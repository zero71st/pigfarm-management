@using MudBlazor
@using System.Text.Json
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudPaper Class="pa-4" Style="display: flex; flex-direction: column; height: 600px;">
    <!-- Header Section - Search -->
    <div Style="flex-shrink: 0;">
        <MudText Typo="Typo.h6" Class="mb-3">Import customers from POSPOS</MudText>

        @if (!_isLoading)
        {
            <MudTextField @bind-Value="_filter" 
                         Label="Search code, name, phone, email..." 
                         Variant="Variant.Outlined"
                         Margin="Margin.Dense"
                         Adornment="Adornment.Start" 
                         AdornmentIcon="Icons.Material.Filled.Search" 
                         Immediate="true"
                         Clearable="true" />
        }
    </div>

    <!-- Total Count Section -->
    @if (!_isLoading && _candidates.Count > 0)
    {
        <div Style="flex-shrink: 0;" Class="mt-3 mb-3">
            <MudPaper Class="pa-3" Elevation="1">
                <MudText Typo="Typo.body1">
                    <strong>@FilteredCandidates.Count()</strong> of <strong>@_candidates.Count</strong> customers found
                </MudText>
            </MudPaper>
        </div>
    }

    <!-- Loading State -->
    @if (_isLoading)
    {
        <div class="d-flex justify-center pa-8" Style="flex-grow: 1;">
            <MudProgressCircular Indeterminate="true" />
        </div>
    }

    <!-- Table Section - Scrollable Content -->
    <div Style="flex-grow: 1; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 4px;">
        @if (!_isLoading)
        {
            @if (FilteredCandidates.Count() == 0)
            {
                <div class="pa-4 text-center">
                    @if (_candidates.Count == 0)
                    {
                        <MudText Typo="Typo.subtitle1">No POSPOS candidates available</MudText>
                        <MudText Typo="Typo.caption" Class="mt-1">No customers found in POSPOS. POSPOS may not be configured or returned no results.</MudText>
                        <div class="mt-3 d-flex justify-center">
                            <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="LoadCandidates">Retry</MudButton>
                        </div>
                    }
                    else
                    {
                        <MudText Typo="Typo.subtitle1">No matches found</MudText>
                        <MudText Typo="Typo.caption" Class="mt-1">No customers match your search criteria.</MudText>
                    }
                </div>
            }
            else
            {
                <MudTable Items="FilteredCandidates" Hover="true" Bordered="true" Striped="true" Dense="true" Class="candidate-table">
                    <HeaderContent>
                        <MudTh>
                        </MudTh>
                        <MudTh>Code</MudTh>
                        <MudTh>Display</MudTh>
                        <MudTh>Mobile</MudTh>
                        <MudTh>Email</MudTh>
                        <MudTh>Address</MudTh>
                        <MudTh>KeyCard</MudTh>
                        <MudTh>ExternalId</MudTh>
                        <MudTh>Sex</MudTh>
                        <MudTh>Zip</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>
                            <MudCheckBox T="bool" @bind-Value="context.IsSelected" />
                        </MudTd>
                        <MudTd>@(string.IsNullOrWhiteSpace(context.Code) ? "-" : context.Code)</MudTd>
                        <MudTd>@(string.IsNullOrWhiteSpace(context.DisplayName) ? "-" : context.DisplayName)</MudTd>
                        <MudTd>@context.Phone</MudTd>
                        <MudTd>@context.Email</MudTd>
                        <MudTd>@context.Address</MudTd>
                        <MudTd>@context.KeyCardId</MudTd>
                        <MudTd>@context.ExternalId</MudTd>
                        <MudTd>@context.Sex</MudTd>
                        <MudTd>@context.Zipcode</MudTd>
                    </RowTemplate>
                </MudTable>
            }
        }
    </div>

    <!-- Footer Section - Buttons -->
    <div Style="flex-shrink: 0;" Class="mt-3 d-flex justify-end gap-2">
        <MudButton Variant="Variant.Text" OnClick="Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="_isLoading || !_hasSelection" OnClick="ImportSelected">Import selected</MudButton>
    </div>
</MudPaper>

@code {
    [Parameter] public bool PersistMapping { get; set; } = true;

    [CascadingParameter] MudDialogInstance? MudDialogInstance { get; set; }

    private bool _isLoading = true;
    private List<CandidateMember> _candidates = new();
    private string _filter = string.Empty;

    private IEnumerable<CandidateMember> FilteredCandidates => string.IsNullOrWhiteSpace(_filter)
        ? _candidates
        : _candidates.Where(c => (
            (c.Id ?? "") + " " + (c.Code ?? "") + " " + (c.DisplayName ?? "") + " " + (c.FirstName ?? "") + " " + (c.LastName ?? "") + " " +
            (c.Phone ?? "") + " " + (c.Email ?? "") + " " + (c.Address ?? "") + " " + (c.KeyCardId ?? "") + " " + (c.ExternalId ?? "") + " " +
            (c.Sex ?? "") + " " + (c.Zipcode ?? "")
        ).Contains(_filter, StringComparison.OrdinalIgnoreCase));

    private bool _hasSelection => FilteredCandidates.Any(c => c.IsSelected);

    protected override async Task OnInitializedAsync()
    {
        await LoadCandidates();
    }

    private async Task LoadCandidates()
    {
        _isLoading = true;
        try
        {
            var url = "/api/customers/import/candidates";
            var list = await Http.GetFromJsonAsync<List<CandidateMember>>(url);
            if (list != null)
                _candidates = list;
        }
        catch (HttpRequestException)
        {
            Snackbar.Add("POSPOS service unavailable. Please try again later.", Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load candidates: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void Cancel() => MudDialogInstance?.Cancel();

    private async Task ImportSelected()
    {
        var selected = FilteredCandidates.Where(c => c.IsSelected).ToList();
        if (!selected.Any())
        {
            Snackbar.Add("Please select at least one customer.", Severity.Warning);
            return;
        }

        var count = selected.Count;
        var namesPreview = string.Join(", ", selected.Take(10).Select(c => c.DisplayName));
        if (selected.Count > 10)
            namesPreview += $", ... (+{selected.Count - 10} more)";

        var confirm = await DialogService.ShowMessageBox(
            "Confirm import",
            $"You are about to import {count} member(s).\n\nPreview: {namesPreview}\n\nProceed?",
            yesText: "Import",
            noText: "Cancel");

        if (confirm != true)
            return;

        var selectedIds = selected.Select(c => c.Id).ToList();

        try
        {
            var uri = "/api/customers/import/selected" + (PersistMapping ? "?persist=true" : "");
            var resp = await Http.PostAsJsonAsync(uri, selectedIds);
            if (resp.IsSuccessStatusCode)
            {
                Snackbar.Add("Import completed.", Severity.Success);
                MudDialogInstance?.Close(DialogResult.Ok(true));
            }
            else
            {
                var txt = await resp.Content.ReadAsStringAsync();
                Snackbar.Add($"Import failed: {resp.StatusCode} - {txt}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Import error: {ex.Message}", Severity.Error);
        }
    }

    private class CandidateMember
    {
        public string Id { get; set; } = string.Empty;
        public string Code { get; set; } = string.Empty;
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public string DisplayName =>
            string.IsNullOrWhiteSpace($"{FirstName} {LastName}".Trim()) ? (string.IsNullOrWhiteSpace(Code) ? Id : Code) : $"{FirstName} {LastName}".Trim();
        public string Phone { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Address { get; set; } = string.Empty;
        public string KeyCardId { get; set; } = string.Empty;
        public string ExternalId { get; set; } = string.Empty;
        public string Sex { get; set; } = string.Empty;
        public string Zipcode { get; set; } = string.Empty;
        public string CreatedAt { get; set; } = string.Empty;
        public bool IsSelected { get; set; }
    }
}
