@using Microsoft.AspNetCore.Components
@using MudBlazor
@using PigFarmManagement.Shared.Models

<MudDialog>
    <DialogContent>
        <div class="mb-4">
            <MudAlert Severity="Severity.Warning" Class="mb-3">
                <strong>คำเตือน:</strong> การกระทำนี้ไม่สามารถย้อนกลับได้ กรุณาตรวจสอบผลกระทบจากการลบด้านล่าง
            </MudAlert>

            <MudText Typo="Typo.h6" Class="mb-3">
                ลบลูกค้า: @Customer?.DisplayName
            </MudText>

            @if (ValidationResult != null)
            {
                <MudCard Class="mb-3">
                    <MudCardContent>
                        <MudText Typo="Typo.subtitle1" Class="mb-2">ผลกระทบจากการลบ:</MudText>
                        
                        @if (!ValidationResult.CanDelete)
                        {
                            <MudAlert Severity="Severity.Error" Class="mb-2">
                                <strong>ไม่สามารถลบลูกค้านี้ได้:</strong>
                            </MudAlert>
                        }

                        @if (ValidationResult.ActivePigPenCount > 0)
                        {
                            <MudChip Color="Color.Error" Size="Size.Small" Class="mr-2 mb-1">
                                @ValidationResult.ActivePigPenCount คอกหมูที่ใช้งาน
                            </MudChip>
                        }

                        @if (ValidationResult.ActiveTransactionCount > 0)
                        {
                            <MudChip Color="Color.Warning" Size="Size.Small" Class="mr-2 mb-1">
                                @ValidationResult.ActiveTransactionCount ธุรกรรมล่าสุด
                            </MudChip>
                        }

                        @if (ValidationResult.BlockingReasons.Any())
                        {
                            @foreach (var reason in ValidationResult.BlockingReasons)
                            {
                                <MudText Typo="Typo.body2" Color="Color.Error" Class="mt-2">
                                    @reason
                                </MudText>
                            }
                        }
                    </MudCardContent>
                </MudCard>
            }

            @if (IsLoading)
            {
                <div class="d-flex justify-center">
                    <MudProgressCircular Indeterminate="true" />
                    <MudText Class="ml-3">กำลังตรวจสอบการลบ...</MudText>
                </div>
            }
            else if (ValidationResult?.CanDelete == true)
            {
                <MudCard Class="mb-3">
                    <MudCardContent>
                        <MudText Typo="Typo.subtitle2" Class="mb-2">ตัวเลือกการลบ:</MudText>
                        
                        <MudRadioGroup @bind-Value="selectedDeletionType">
                            <MudRadio Value="DeletionType.Soft" Color="Color.Primary">
                                <div>
                                    <MudText Typo="Typo.body1">ลบแบบชั่วคราว (แนะนำ)</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Default">
                                        ซ่อนลูกค้าจากมุมมองปกติ แต่เก็บข้อมูลไว้เพื่อการตรวจสอบ
                                    </MudText>
                                </div>
                            </MudRadio>
                            
                            <MudRadio Value="DeletionType.Hard" Color="Color.Error">
                                <div>
                                    <MudText Typo="Typo.body1">ลบถาวร</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Error">
                                        ลบข้อมูลลูกค้าทั้งหมดอย่างถาวร (ต้องยืนยัน)
                                    </MudText>
                                </div>
                            </MudRadio>
                        </MudRadioGroup>
                    </MudCardContent>
                </MudCard>

                <MudTextField @bind-Value="deletionReason" 
                              Label="เหตุผลในการลบ (ไม่บังคับ)" 
                              Placeholder="ระบุเหตุผลในการลบลูกค้านี้..."
                              Lines="3"
                              Variant="Variant.Outlined"
                              Class="mb-3" />

                @if (selectedDeletionType == DeletionType.Hard)
                {
                    <MudAlert Severity="Severity.Error" Class="mb-3">
                        <MudText Typo="Typo.body2">
                            <strong>คำเตือนสุดท้าย:</strong> การลบถาวรจะลบข้อมูลลูกค้าทั้งหมดตลอดไป
                        </MudText>
                        
                        <MudTextField @bind-Value="confirmationText" 
                                      Label="พิมพ์ 'DELETE' เพื่อยืนยัน" 
                                      Placeholder="DELETE"
                                      Class="mt-2" />
                    </MudAlert>
                }
            }
        </div>
    </DialogContent>
    
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text">ยกเลิก</MudButton>
        
        @if (ValidationResult?.CanDelete == true)
        {
            <MudButton Color="@GetDeleteButtonColor()" 
                       Variant="Variant.Filled" 
                       OnClick="ConfirmDelete"
                       Disabled="@(!CanConfirmDelete)"
                       StartIcon="@Icons.Material.Filled.Delete">
                @GetDeleteButtonText()
            </MudButton>
        }
        else if (!IsLoading && ValidationResult != null)
        {
            <MudButton Color="Color.Info" 
                       Variant="Variant.Filled" 
                       OnClick="Cancel">
                เข้าใจแล้ว
            </MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public Customer? Customer { get; set; }
    [Parameter] public CustomerDeletionValidation? ValidationResult { get; set; }
    [Parameter] public bool IsLoading { get; set; } = false;
    [Parameter] public EventCallback<CustomerDeletionRequest> OnDeleteConfirmed { get; set; }

    private enum DeletionType { Soft, Hard }
    private DeletionType selectedDeletionType = DeletionType.Soft;
    private string deletionReason = string.Empty;
    private string confirmationText = string.Empty;

    private bool CanConfirmDelete
    {
        get
        {
            if (Customer == null || ValidationResult?.CanDelete != true)
                return false;

            if (selectedDeletionType == DeletionType.Hard)
                return confirmationText.Equals("DELETE", StringComparison.OrdinalIgnoreCase);

            return true;
        }
    }

    private Color GetDeleteButtonColor()
    {
        return selectedDeletionType == DeletionType.Hard ? Color.Error : Color.Warning;
    }

    private string GetDeleteButtonText()
    {
        return selectedDeletionType == DeletionType.Hard ? "ลบถาวร" : "ลบชั่วคราว";
    }

    private async Task ConfirmDelete()
    {
        if (Customer == null || !CanConfirmDelete)
            return;

        var request = new CustomerDeletionRequest
        {
            CustomerId = Customer.Id,
            ForceDelete = selectedDeletionType == DeletionType.Hard,
            Reason = deletionReason,
            DeletedBy = "Current User" // This should be replaced with actual user info
        };

        await OnDeleteConfirmed.InvokeAsync(request);
        MudDialog.Close(DialogResult.Ok(request));
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}