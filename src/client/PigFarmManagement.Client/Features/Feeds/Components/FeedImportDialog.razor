@using PigFarmManagement.Shared.Models
@inject IFeedImportService FeedImportService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <div class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-4">นำเข้าข้อมูลอาหารจาก POSPOS</MudText>
            
            <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
                <!-- Mock Data Import tab removed. Use Date Range or JSON Import for live data. -->
                
                <MudTabPanel Text="นำเข้าตามช่วงวันที่" Icon="@Icons.Material.Filled.DateRange">
                    <div class="d-flex flex-column gap-4">
                        <MudText Typo="Typo.body1" Class="mb-3">
                            นำเข้าธุรกรรมอาหาร POSPOS จากช่วงวันที่ที่กำหนด
                        </MudText>
                        
                        <div class="d-flex gap-4">
                            <MudDatePicker @bind-Date="_fromDate"
                                         Label="จากวันที่"
                                         Variant="Variant.Outlined"
                                         DateFormat="yyyy-MM-dd"
                                         HelperText="วันที่เริ่มต้นสำหรับการนำเข้าธุรกรรม" />
                            
                            <MudDatePicker @bind-Date="_toDate"
                                         Label="ถึงวันที่"
                                         Variant="Variant.Outlined"
                                         DateFormat="yyyy-MM-dd"
                                         HelperText="วันที่สิ้นสุดสำหรับการนำเข้าธุรกรรม" />
                        </div>
                        
                        @if (_dateRangeTransactions.Any())
                        {
                            <MudCard>
                                <MudCardContent>
                                    <MudText Typo="Typo.h6" Class="mb-2">แสดงตัวอย่างข้อมูลตามช่วงวันที่</MudText>
                                    <MudText Typo="Typo.body2" Class="mb-2">
                                        พบ @_dateRangeTransactions.Count ธุรกรรม พร้อม @_dateRangeTransactions.Sum(t => t.OrderList.Count) รายการอาหาร
                                        จาก @(_fromDate?.ToString("yyyy-MM-dd")) ถึง @(_toDate?.ToString("yyyy-MM-dd"))
                                    </MudText>
                                    
                                    @foreach (var transaction in _dateRangeTransactions.Take(3))
                                    {
                                        <MudChip Color="Color.Primary" Size="Size.Small" Class="mr-2 mb-1">
                                            @transaction.Code - @transaction.BuyerDetail.FirstName @transaction.BuyerDetail.LastName
                                            (@transaction.Timestamp.ToString("MM/dd HH:mm"))
                                        </MudChip>
                                    }
                                    
                                    @if (_dateRangeTransactions.Count > 3)
                                    {
                                        <MudChip Color="Color.Secondary" Size="Size.Small" Variant="Variant.Outlined">
                                            +@(_dateRangeTransactions.Count - 3) more...
                                        </MudChip>
                                    }
                                </MudCardContent>
                            </MudCard>
                        }
                        
                        <div class="d-flex gap-2">
                            <MudButton Color="Color.Info" 
                                     Variant="Variant.Filled" 
                                     StartIcon="@Icons.Material.Filled.Search"
                                     OnClick="LoadDateRangeData"
                                     Disabled="_isLoading || !_fromDate.HasValue || !_toDate.HasValue">
                                @if (_isLoading)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                    <span class="ml-2">กำลังค้นหา...</span>
                                }
                                else
                                {
                                    <span>ค้นหาธุรกรรม</span>
                                }
                            </MudButton>
                            
                            @if (_dateRangeTransactions.Any())
                            {
                                <MudButton Color="Color.Success" 
                                         Variant="Variant.Filled" 
                                         StartIcon="@Icons.Material.Filled.Upload"
                                         OnClick="ImportDateRangeData"
                                         Disabled="_isImporting">
                                    @if (_isImporting)
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                        <span class="ml-2">กำลังนำเข้า...</span>
                                    }
                                    else
                                    {
                                        <span>นำเข้าช่วงที่เลือก</span>
                                    }
                                </MudButton>
                            }
                        </div>
                    </div>
                </MudTabPanel>
                
                <MudTabPanel Text="นำเข้า JSON" Icon="@Icons.Material.Filled.Code">
                    <div class="d-flex flex-column gap-4">
                        <MudText Typo="Typo.body1" Class="mb-3">
                            วางข้อมูลธุรกรรม JSON จาก POSPOS ด้านล่างเพื่อนำเข้าบันทึกอาหาร
                        </MudText>
                        
                        <MudTextField @bind-Value="_jsonContent"
                                    Label="ข้อมูล JSON จาก POSPOS"
                                    Variant="Variant.Outlined"
                                    Lines="12"
                                    Placeholder="วาง JSON ธุรกรรม POSPOS ของคุณที่นี่..."
                                    HelperText="รูปแบบที่คาดหวัง: อาร์เรย์ของออบเจกต์ธุรกรรมที่มี order_list, buyer_detail, เป็นต้น" />
                        
                        <MudButton Color="Color.Primary" 
                                 Variant="Variant.Filled" 
                                 StartIcon="@Icons.Material.Filled.Upload"
                                 OnClick="ImportFromJson"
                                 Disabled="_isImporting || string.IsNullOrWhiteSpace(_jsonContent)">
                            @if (_isImporting)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                <span class="ml-2">กำลังนำเข้า...</span>
                            }
                            else
                            {
                                <span>นำเข้าข้อมูล JSON</span>
                            }
                        </MudButton>
                    </div>
                </MudTabPanel>
            </MudTabs>
            
            @if (_importResult != null)
            {
                <MudAlert Severity="@(_importResult.FailedImports > 0 ? Severity.Warning : Severity.Success)" Class="mt-4">
                    <MudText Typo="Typo.h6" Class="mb-2">ผลการนำเข้า</MudText>
                    <MudText Typo="Typo.body2">
                        • ธุรกรรมทั้งหมด: @_importResult.TotalTransactions<br/>
                        • รายการอาหารทั้งหมด: @_importResult.TotalFeedItems<br/>
                        • นำเข้าสำเร็จ: @_importResult.SuccessfulImports<br/>
                        • นำเข้าล้มเหลว: @_importResult.FailedImports
                    </MudText>
                    
                    @if (_importResult.Errors.Any())
                    {
                        <MudText Typo="Typo.body2" Class="mt-2">
                            <strong>ข้อผิดพลาด:</strong><br/>
                            @foreach (var error in _importResult.Errors)
                            {
                                <span>• @error<br/></span>
                            }
                        </MudText>
                    }
                    
                    @if (_importResult.ImportedFeeds.Any())
                    {
                        <MudText Typo="Typo.body2" Class="mt-2">
                            <strong>อาหารที่นำเข้า:</strong><br/>
                            @foreach (var feed in _importResult.ImportedFeeds.Take(5))
                            {
                                <span>• @feed.InvoiceCode - @feed.CustomerName (@feed.FeedItemsCount items, $@feed.TotalAmount.ToString("F2"))<br/></span>
                            }
                            @if (_importResult.ImportedFeeds.Count > 5)
                            {
                                <span>• And @(_importResult.ImportedFeeds.Count - 5) more...</span>
                            }
                        </MudText>
                    }
                </MudAlert>
            }
        </div>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">ปิด</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;

    private bool _isLoading;
    private bool _isImporting;
    private string _jsonContent = "";
    private List<PosPosTransaction> _dateRangeTransactions = new();
    private FeedImportResult? _importResult;
    private DateTime? _fromDate = DateTime.Today.AddDays(-7); // Default to last 7 days
    private DateTime? _toDate = DateTime.Today;

    protected override Task OnInitializedAsync()
    {
        // No mock data to load on init. User can use Date Range or JSON import flows.
        return Task.CompletedTask;
    }

    // Mock-specific methods removed. Use date-range or JSON import instead.

    private async Task ImportFromJson()
    {
        _isImporting = true;
        try
        {
            _importResult = await FeedImportService.ImportFromJsonAsync(_jsonContent);
            
            if (_importResult.FailedImports == 0)
            {
                Snackbar.Add($"นำเข้าสำเร็จ {_importResult.SuccessfulImports} ธุรกรรมที่มี {_importResult.TotalFeedItems} รายการอาหาร", Severity.Success);
            }
            else
            {
                Snackbar.Add($"นำเข้าเสร็จสมบูรณ์แต่มีความล้มเหลว {_importResult.FailedImports} รายการ", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"การนำเข้าล้มเหลว: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isImporting = false;
        }
    }

    private async Task LoadDateRangeData()
    {
        if (!_fromDate.HasValue || !_toDate.HasValue)
        {
            Snackbar.Add("กรุณาเลือกวันที่เริ่มต้นและวันที่สิ้นสุด", Severity.Warning);
            return;
        }

        if (_fromDate.Value > _toDate.Value)
        {
            Snackbar.Add("วันที่เริ่มต้นต้องไม่สายกว่าวันที่สิ้นสุด", Severity.Warning);
            return;
        }

        _isLoading = true;
        try
        {
            _dateRangeTransactions = await FeedImportService.GetPosPosFeedByDateRangeAsync(_fromDate.Value, _toDate.Value);
            Snackbar.Add($"พบ {_dateRangeTransactions.Count} ธุรกรรมในช่วงวันที่ที่เลือก", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"โหลดข้อมูลช่วงวันที่ล้มเหลว: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task ImportDateRangeData()
    {
        if (!_fromDate.HasValue || !_toDate.HasValue)
        {
            Snackbar.Add("กรุณาเลือกวันที่เริ่มต้นและวันที่สิ้นสุด", Severity.Warning);
            return;
        }

        _isImporting = true;
        try
        {
            _importResult = await FeedImportService.ImportPosPosFeedByDateRangeAsync(_fromDate.Value, _toDate.Value);
            
            if (_importResult.FailedImports == 0)
            {
                Snackbar.Add($"นำเข้าสำเร็จ {_importResult.SuccessfulImports} ธุรกรรมที่มี {_importResult.TotalFeedItems} รายการอาหารจากช่วงวันที่", Severity.Success);
            }
            else
            {
                Snackbar.Add($"นำเข้าเสร็จสมบูรณ์แต่มีความล้มเหลว {_importResult.FailedImports} รายการ", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"การนำเข้าล้มเหลว: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isImporting = false;
        }
    }

    private void Cancel() => MudDialog.Cancel();
}
