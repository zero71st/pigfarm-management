@using PigFarmManagement.Shared.Models
@using System.Globalization

<!-- Activity Metrics Row (3 cards) -->
<MudGrid>
    <!-- Total Active Pig Pens -->
    <MudItem xs="12" sm="6" md="4">
        <MudCard Elevation="3" Class="pa-4">
            <MudCardContent>
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.Home" Color="Color.Primary" Size="Size.Large" Class="mr-3" />
                    <div>
                        <MudText Typo="Typo.h4" Color="Color.Primary">@Overview.TotalActivePigPens</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">คอกสุกรกำลังเลี้ยงทั้งหมด</MudText>
                    </div>
                </div>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <!-- Total Pigs -->
    <MudItem xs="12" sm="6" md="4">
        <MudCard Elevation="3" Class="pa-4">
            <MudCardContent>
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.Pets" Color="Color.Success" Size="Size.Large" Class="mr-3" />
                    <div>
                        <MudText Typo="Typo.h4" Color="Color.Success">@Overview.TotalPigs</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">จำนวนสุกรกำลังเลี้ยงทั้งหมด</MudText>
                    </div>
                </div>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <!-- Total Active Customers -->
    <MudItem xs="12" sm="6" md="4">
        <MudCard Elevation="3" Class="pa-4">
            <MudCardContent>
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.Group" Color="Color.Info" Size="Size.Large" Class="mr-3" />
                    <div>
                        <MudText Typo="Typo.h4" Color="Color.Info">@Overview.TotalActiveCustomers</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">จำนวนลูกค้ากำลังเลี้ยงทั้งหมด</MudText>
                    </div>
                </div>
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

<!-- Financial Metrics Row (3 cards) -->
<MudGrid Class="mt-4">
    <!-- Total Investment -->
    <MudItem xs="12" sm="6" md="4">
        <MudCard Elevation="3" Class="pa-4">
            <MudCardContent>
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Color="Color.Primary" Size="Size.Large"
                        Class="mr-3" />
                    <div style="flex: 1;">
                        <MudText Typo="Typo.h4" Color="Color.Primary">@FormatCurrency(Overview.TotalInvestmentProject)
                        </MudText>
                        <MudText Typo="Typo.body1" Color="Color.Primary">100%</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">เงินลงทุนโครงการทั้งหมด</MudText>
                    </div>
                </div>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <!-- Total Owner's Capital (Project Only) -->
    <MudItem xs="12" sm="6" md="4">
        <MudCard Elevation="3" Class="pa-4">
            <MudCardContent>
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.Business" Color="Color.Info" Size="Size.Large" Class="mr-3" />
                    <div style="flex: 1;">
                        <MudText Typo="Typo.h4" Color="Color.Info">@FormatCurrency(CalculateTotalOwnerPlusProfit())
                        </MudText>
                        <div class="d-flex" style="align-items: baseline; gap: 8px;">
                            <MudText Typo="Typo.body1" Color="Color.Info">
                                @FormatPercentage(CalculatePercentage(CalculateTotalOwnerPlusProfit(),
                                                                Overview.TotalInvestmentProject))</MudText>
                            <MudText Typo="Typo.body1" Color="Color.Info" Style="font-size:0.75rem; opacity:0.95">
                                (@FormatCurrency(Overview.TotalOwnerCapitalProject) @(Overview.TotalProfitProject >= 0 ?
                                                                "+" + FormatCurrency(Overview.TotalProfitProject) :
                                                                FormatCurrency(Overview.TotalProfitProject)))</MudText>
                        </div>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">เงินลงทุนโครงการส่วนของร้าน</MudText>
                    </div>
                </div>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <!-- Total Customer's Capital (NEW 4th card) -->
    <MudItem xs="12" sm="6" md="4">
        <MudCard Elevation="3" Class="pa-4">
            <MudCardContent>
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.AccountBalanceWallet" Color="Color.Secondary"
                        Size="Size.Large" Class="mr-3" />
                    <div style="flex: 1;">
                        <MudText Typo="Typo.h4" Color="Color.Secondary">@FormatCurrency(Overview.TotalCustomerCapitalProject)
                        </MudText>
                        <MudText Typo="Typo.body1" Color="Color.Secondary">
                            @FormatPercentage(CalculatePercentage(Overview.TotalCustomerCapitalProject,
                            Overview.TotalInvestmentProject))</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">เงินลงทุนโครงการส่วนลูกค้า</MudText>
                    </div>
                </div>
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

@code {
    [Parameter] public DashboardOverview Overview { get; set; } = null!;

    // Estimate active pen count for Cash (since we don't have direct count in DTO)
    private int cashPenEstimate => Overview.TotalPigsCash > 0 ?
    (int)Math.Ceiling((decimal)Overview.TotalPigsCash / (Overview.TotalPigs > 0 ? (decimal)Overview.TotalPigs /
    Overview.TotalActivePigPens : 1)) : 0;

    private string FormatCurrency(decimal amount)
    {
        return amount.ToString("N2", new CultureInfo("th-TH"));
    }

    private string FormatCurrencyWithSign(decimal amount)
    {
        var formatted = amount.ToString("N2", new CultureInfo("th-TH"));
        return amount >= 0 ? $"+{formatted}" : formatted;
    }

    private decimal CalculateTotalOwnerPlusProfit()
    {
        return Overview.TotalOwnerCapitalProject + Overview.TotalProfitProject;
    }

    private string FormatPercentage(decimal value)
    {
        return $"{value:N2}%";
    }

    private decimal CalculatePercentage(decimal value, decimal total)
    {
        return total != 0 ? (value / total) * 100 : 0;
    }

    private decimal CalculateROI(decimal profit, decimal investment)
    {
        return investment != 0 ? profit / investment : 0;
    }

    private int GetActivePenCount(int pigs, int estimate)
    {
        return estimate;
    }
}