@using Microsoft.AspNetCore.Components
@using MudBlazor
@using PigFarmManagement.Shared.Models
@using PigFarmManagement.Client.Features.PigPens.Services
@inject IPigPenService PigPenService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudGrid Spacing="3">
            <!-- Deposit Calculation Info Card -->
            @if (calculationInfo != null)
            {
                <MudItem xs="12">
                    <MudCard Style="background-color: #f8f9fa;">
                            <MudCardContent>
                                <MudGrid>
                                    <MudItem xs="12">
                                        <MudText Typo="Typo.subtitle2" Class="mb-2">
                                            üí∞ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
                                        </MudText>
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudText Typo="Typo.body2" Class="text-muted">
                                            ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤:
                                        </MudText>
                                        <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                            @calculationInfo.ExpectedTotalDepositFormatted
                                        </MudText>
                                        <MudText Typo="Typo.caption" Class="text-muted">
                                            (@calculationInfo.PigQuantity ‡∏ï‡∏±‡∏ß √ó @calculationInfo.DepositPerPigFormatted)
                                        </MudText>
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudText Typo="Typo.body2" Class="text-muted">
                                            ‡∏¢‡∏≠‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:
                                        </MudText>
                                        <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                            @GetCurrentTotalFormatted()
                                        </MudText>
                                        <MudText Typo="Typo.caption" Class="text-muted">
                                            (@GetCompletionPercentageFormatted() ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå)
                                        </MudText>
                                    </MudItem>
                                    <MudItem xs="12">
                                        <MudDivider Class="my-2" />
                                        <MudText Typo="Typo.body2" Class="text-muted">
                                            ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç):
                                        </MudText>
                                        <MudText Typo="Typo.h6" Style="@($"color: {GetRemainingAmountColor()}")">
                                            @GetRemainingDepositFormatted()
                                        </MudText>
                                        @if (GetRemainingDeposit() == 0)
                                        {
                                            <MudText Typo="Typo.caption" Style="color: #4caf50;">
                                                ‚úÖ ‡∏à‡∏∞‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                                            </MudText>
                                        }
                                    </MudItem>
                                </MudGrid>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                }
                
            <MudItem xs="12">
                <MudNumericField @bind-Value="amount" 
                               Label="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ø)" 
                               Variant="Variant.Outlined" 
                               Required="true"
                               Min="0.01m"
                               Format="N2"
                               Culture="@System.Globalization.CultureInfo.GetCultureInfo("th-TH")"
                               HelperText="‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏≤‡∏ó"
                               Error="@(!IsAmountValid())"
                               ErrorText="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0" />
            </MudItem>
            
            <MudItem xs="12">
                <MudDatePicker @bind-Date="depositDate" 
                             Label="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏î‡∏à‡∏≥" 
                             Variant="Variant.Outlined" 
                             Required="true"
                             MaxDate="DateTime.Today"
                             HelperText="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏°‡∏±‡∏î‡∏à‡∏≥ (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï)"
                             Error="@(!IsDateValid())"
                             ErrorText="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï" />
            </MudItem>
            
            <MudItem xs="12">
                <MudTextField @bind-Value="remark" 
                            Label="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)" 
                            Variant="Variant.Outlined" 
                            Lines="3"
                            MaxLength="500"
                            Counter="500"
                            HelperText="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏µ‡πâ" />
            </MudItem>
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</MudButton>
        <MudButton Color="Color.Primary" 
                   Variant="Variant.Filled" 
                   OnClick="Submit"
                   Disabled="@(!IsFormValid() || isSubmitting)"
                   StartIcon="@(isSubmitting ? null : Icons.Material.Filled.Save)">
            @if (isSubmitting)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                <MudText Class="ms-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á...</MudText>
            }
            else
            {
                <MudText>‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥</MudText>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public Deposit DepositToEdit { get; set; } = new Deposit(Guid.Empty, Guid.Empty, 0, DateTime.Today, null);
    [Parameter] public PigPen? PigPen { get; set; }
    [Parameter] public List<Deposit>? CurrentDeposits { get; set; }

    private decimal amount;
    private DateTime? depositDate;
    private string remark = "";
    private bool isSubmitting = false;
    private DepositCalculationInfo? calculationInfo;

    protected override void OnInitialized()
    {
        // Pre-populate form with existing deposit data
        if (DepositToEdit != null)
        {
            amount = DepositToEdit.Amount;
            depositDate = DepositToEdit.Date;
            remark = DepositToEdit.Remark ?? "";
        }
        
        // Calculate deposit information if pig pen and deposits are provided
        if (PigPen != null && CurrentDeposits != null)
        {
            calculationInfo = DepositCalculationInfo.Create(PigPen, CurrentDeposits);
        }
    }

    private string GetCurrentTotalFormatted()
    {
        if (calculationInfo == null || CurrentDeposits == null) return "‡∏ø0.00";
        
        // Calculate current total excluding the deposit being edited, then add the new amount
        var totalExcludingCurrent = CurrentDeposits
            .Where(d => d.Id != DepositToEdit.Id)
            .Sum(d => d.Amount);
        
        var newTotal = totalExcludingCurrent + amount;
        return newTotal.FormatThaiBaht();
    }

    private string GetCompletionPercentageFormatted()
    {
        if (calculationInfo == null || CurrentDeposits == null) return "0%";
        
        var totalExcludingCurrent = CurrentDeposits
            .Where(d => d.Id != DepositToEdit.Id)
            .Sum(d => d.Amount);
        
        var newTotal = totalExcludingCurrent + amount;
        var percentage = calculationInfo.ExpectedTotalDeposit == 0 ? 0 : 
            Math.Min(1.0m, newTotal / calculationInfo.ExpectedTotalDeposit);
        
        return $"{percentage:P0}";
    }

    private decimal GetRemainingDeposit()
    {
        if (calculationInfo == null || CurrentDeposits == null) return 0;
        
        var totalExcludingCurrent = CurrentDeposits
            .Where(d => d.Id != DepositToEdit.Id)
            .Sum(d => d.Amount);
        
        var newTotal = totalExcludingCurrent + amount;
        return Math.Max(0, calculationInfo.ExpectedTotalDeposit - newTotal);
    }

    private string GetRemainingDepositFormatted()
    {
        return GetRemainingDeposit().FormatThaiBaht();
    }

    private string GetRemainingAmountColor()
    {
        var remaining = GetRemainingDeposit();
        var completionPercentage = calculationInfo?.ExpectedTotalDeposit == 0 ? 0 :
            (calculationInfo?.ExpectedTotalDeposit - remaining) / calculationInfo?.ExpectedTotalDeposit ?? 0;
        
        return remaining switch
        {
            0 => "#4caf50", // Green - complete
            > 0 when completionPercentage >= 0.5m => "#ff9800", // Orange - partial
            _ => "#f44336" // Red - needs attention
        };
    }

    private bool IsAmountValid()
    {
        return amount > 0;
    }

    private bool IsDateValid()
    {
        return depositDate.HasValue && depositDate.Value <= DateTime.Today;
    }

    private bool IsFormValid()
    {
        return IsAmountValid() && IsDateValid();
    }

    void Cancel() => MudDialog.Cancel();

    async Task Submit()
    {
        if (!IsFormValid() || isSubmitting || DepositToEdit == null)
            return;

        try
        {
            isSubmitting = true;
            StateHasChanged();

            // Create updated deposit DTO
            var updateDto = new DepositUpdateDto(
                amount,
                depositDate!.Value,
                string.IsNullOrWhiteSpace(remark) ? null : remark.Trim()
            );

            var result = await PigPenService.UpdateDepositAsync(DepositToEdit.PigPenId, DepositToEdit.Id, updateDto);
            
            Snackbar.Add($"‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ø{amount:N2})", Severity.Success);
            MudDialog.Close(DialogResult.Ok(result));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }
}