@using Microsoft.AspNetCore.Components
@using MudBlazor
@using PigFarmManagement.Shared.Models
@using PigFarmManagement.Client.Features.PigPens.Services
@inject IPigPenService PigPenService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudContainer Style="max-width: 500px;">
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="mb-4">
                        <MudIcon Icon="Icons.Material.Filled.Edit" Class="mr-2" />
                        Edit Deposit
                    </MudText>
                </MudItem>
                
                <!-- Deposit Calculation Info Card -->
                @if (calculationInfo != null)
                {
                    <MudItem xs="12">
                        <MudCard Class="mb-4" Style="background-color: #f8f9fa;">
                            <MudCardContent>
                                <MudGrid>
                                    <MudItem xs="12">
                                        <MudText Typo="Typo.subtitle2" Class="mb-2">
                                            ðŸ’° Deposit Information
                                        </MudText>
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudText Typo="Typo.body2" Class="text-muted">
                                            Expected Total:
                                        </MudText>
                                        <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                            @calculationInfo.ExpectedTotalDepositFormatted
                                        </MudText>
                                        <MudText Typo="Typo.caption" Class="text-muted">
                                            (@calculationInfo.PigQuantity pigs Ã— @calculationInfo.DepositPerPigFormatted)
                                        </MudText>
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudText Typo="Typo.body2" Class="text-muted">
                                            Current Total:
                                        </MudText>
                                        <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                            @GetCurrentTotalFormatted()
                                        </MudText>
                                        <MudText Typo="Typo.caption" Class="text-muted">
                                            (@GetCompletionPercentageFormatted() complete)
                                        </MudText>
                                    </MudItem>
                                    <MudItem xs="12">
                                        <MudDivider Class="my-2" />
                                        <MudText Typo="Typo.body2" Class="text-muted">
                                            Remaining Needed (after edit):
                                        </MudText>
                                        <MudText Typo="Typo.h6" Style="@($"color: {GetRemainingAmountColor()}")">
                                            @GetRemainingDepositFormatted()
                                        </MudText>
                                        @if (GetRemainingDeposit() == 0)
                                        {
                                            <MudText Typo="Typo.caption" Style="color: #4caf50;">
                                                âœ… Deposit requirement will be fulfilled
                                            </MudText>
                                        }
                                    </MudItem>
                                </MudGrid>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                }
                
                <MudItem xs="12">
                    <MudNumericField @bind-Value="amount" 
                                   Label="Amount (à¸¿)" 
                                   Variant="Variant.Outlined" 
                                   Required="true"
                                   Min="0.01m"
                                   Format="N2"
                                   Culture="@System.Globalization.CultureInfo.GetCultureInfo("th-TH")"
                                   HelperText="Enter the deposit amount in Thai Baht"
                                   Error="@(!IsAmountValid())"
                                   ErrorText="Amount must be greater than 0" />
                </MudItem>
                
                <MudItem xs="12">
                    <MudDatePicker @bind-Date="depositDate" 
                                 Label="Deposit Date" 
                                 Variant="Variant.Outlined" 
                                 Required="true"
                                 MaxDate="DateTime.Today"
                                 HelperText="Select the date of deposit (cannot be future date)"
                                 Error="@(!IsDateValid())"
                                 ErrorText="Date is required and cannot be in the future" />
                </MudItem>
                
                <MudItem xs="12">
                    <MudTextField @bind-Value="remark" 
                                Label="Remark (Optional)" 
                                Variant="Variant.Outlined" 
                                Lines="3"
                                MaxLength="500"
                                Counter="500"
                                HelperText="Add any notes about this deposit" />
                </MudItem>
            </MudGrid>
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" 
                   Variant="Variant.Filled" 
                   OnClick="Submit"
                   Disabled="@(!IsFormValid() || isSubmitting)"
                   StartIcon="@(isSubmitting ? null : Icons.Material.Filled.Save)">
            @if (isSubmitting)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                <MudText Class="ms-2">Updating...</MudText>
            }
            else
            {
                <MudText>Update Deposit</MudText>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public Deposit DepositToEdit { get; set; } = new Deposit(Guid.Empty, Guid.Empty, 0, DateTime.Today, null);
    [Parameter] public PigPen? PigPen { get; set; }
    [Parameter] public List<Deposit>? CurrentDeposits { get; set; }

    private decimal amount;
    private DateTime? depositDate;
    private string remark = "";
    private bool isSubmitting = false;
    private DepositCalculationInfo? calculationInfo;

    protected override void OnInitialized()
    {
        // Pre-populate form with existing deposit data
        if (DepositToEdit != null)
        {
            amount = DepositToEdit.Amount;
            depositDate = DepositToEdit.Date;
            remark = DepositToEdit.Remark ?? "";
        }
        
        // Calculate deposit information if pig pen and deposits are provided
        if (PigPen != null && CurrentDeposits != null)
        {
            calculationInfo = DepositCalculationInfo.Create(PigPen, CurrentDeposits);
        }
    }

    private string GetCurrentTotalFormatted()
    {
        if (calculationInfo == null || CurrentDeposits == null) return "à¸¿0.00";
        
        // Calculate current total excluding the deposit being edited, then add the new amount
        var totalExcludingCurrent = CurrentDeposits
            .Where(d => d.Id != DepositToEdit.Id)
            .Sum(d => d.Amount);
        
        var newTotal = totalExcludingCurrent + amount;
        return newTotal.FormatThaiBaht();
    }

    private string GetCompletionPercentageFormatted()
    {
        if (calculationInfo == null || CurrentDeposits == null) return "0%";
        
        var totalExcludingCurrent = CurrentDeposits
            .Where(d => d.Id != DepositToEdit.Id)
            .Sum(d => d.Amount);
        
        var newTotal = totalExcludingCurrent + amount;
        var percentage = calculationInfo.ExpectedTotalDeposit == 0 ? 0 : 
            Math.Min(1.0m, newTotal / calculationInfo.ExpectedTotalDeposit);
        
        return $"{percentage:P0}";
    }

    private decimal GetRemainingDeposit()
    {
        if (calculationInfo == null || CurrentDeposits == null) return 0;
        
        var totalExcludingCurrent = CurrentDeposits
            .Where(d => d.Id != DepositToEdit.Id)
            .Sum(d => d.Amount);
        
        var newTotal = totalExcludingCurrent + amount;
        return Math.Max(0, calculationInfo.ExpectedTotalDeposit - newTotal);
    }

    private string GetRemainingDepositFormatted()
    {
        return GetRemainingDeposit().FormatThaiBaht();
    }

    private string GetRemainingAmountColor()
    {
        var remaining = GetRemainingDeposit();
        var completionPercentage = calculationInfo?.ExpectedTotalDeposit == 0 ? 0 :
            (calculationInfo?.ExpectedTotalDeposit - remaining) / calculationInfo?.ExpectedTotalDeposit ?? 0;
        
        return remaining switch
        {
            0 => "#4caf50", // Green - complete
            > 0 when completionPercentage >= 0.5m => "#ff9800", // Orange - partial
            _ => "#f44336" // Red - needs attention
        };
    }

    private bool IsAmountValid()
    {
        return amount > 0;
    }

    private bool IsDateValid()
    {
        return depositDate.HasValue && depositDate.Value <= DateTime.Today;
    }

    private bool IsFormValid()
    {
        return IsAmountValid() && IsDateValid();
    }

    void Cancel() => MudDialog.Cancel();

    async Task Submit()
    {
        if (!IsFormValid() || isSubmitting || DepositToEdit == null)
            return;

        try
        {
            isSubmitting = true;
            StateHasChanged();

            // Create updated deposit object
            var updatedDeposit = new Deposit(
                DepositToEdit.Id,
                DepositToEdit.PigPenId,
                amount,
                depositDate!.Value,
                string.IsNullOrWhiteSpace(remark) ? null : remark.Trim()
            );

            var result = await PigPenService.UpdateDepositAsync(updatedDeposit);
            
            Snackbar.Add($"Deposit updated successfully (à¸¿{amount:N2})", Severity.Success);
            MudDialog.Close(DialogResult.Ok(result));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating deposit: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }
}