@using Microsoft.AspNetCore.Components
@using MudBlazor
@using PigFarmManagement.Shared.Models
@using PigFarmManagement.Client.Features.Customers.Services
@using PigFarmManagement.Client.Features.PigPens.Services
@using PigFarmManagement.Client.Features.FeedFormulas.Services
@using PigFarmManagement.Shared
@inject ICustomerService CustomerService
@inject IPigPenService PigPenService
@inject IFeedFormulaCalculationService FeedFormulaCalculationService
@inject IFeedFormulaService FeedFormulaService

<MudDialog>
    <DialogContent>
        <MudContainer Style="max-width: 500px;">
            <MudGrid>
                <MudItem xs="12">
                    <MudAutocomplete T="Customer"
                                   Label="ลูกค้า"
                                   @bind-Value="selectedCustomer"
                                   SearchFunc="@SearchCustomers"
                                   ToStringFunc="@(c => c == null ? "" : $"{c.DisplayName} ({c.Status})")"
                                   Variant="Variant.Outlined"
                                   Required="true"
                                   Clearable="true"
                                   AdornmentIcon="@Icons.Material.Filled.Search"
                                   AdornmentColor="Color.Primary" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="penCode" Label="รหัสคอก" Variant="Variant.Outlined" Required="true" />
                </MudItem>
                <MudItem xs="12">
                    <MudSelect T="PigPenType" @bind-Value="selectedType" Label="ประเภทคอก" Variant="Variant.Outlined" Required="true">
                        <MudSelectItem T="PigPenType" Value="PigPenType.Cash">เงินสด</MudSelectItem>
                        <MudSelectItem T="PigPenType" Value="PigPenType.Project">โครงการ</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="6">
                    <MudNumericField Value="pigQty" 
                                   ValueChanged="@((int value) => OnPigQuantityChanged(value))"
                                   Label="จำนวนสุกร" 
                                   Variant="Variant.Outlined" 
                                   Min="1" 
                                   Required="true" />
                </MudItem>
                <MudItem xs="6">
                    <MudNumericField @bind-Value="depositPerPig" 
                                   Label="Deposit Per Pig (บาท)" 
                                   Variant="Variant.Outlined" 
                                   Min="0" 
                                   Step="100"
                                   Format="N0"
                                   Required="true" 
                                   Adornment="Adornment.End" 
                                   AdornmentText="฿" />
                </MudItem>
                <MudItem xs="6">
                    <MudDatePicker Date="registerDate" 
                                  DateChanged="@OnRegisterDateChanged"
                                  Label="วันที่ลงทะเบียน" 
                                  Variant="Variant.Outlined" 
                                  Required="true" />
                </MudItem>
                <MudItem xs="6">
                    <MudDatePicker @bind-Date="estimatedHarvestDate" 
                                  Label="วันจับสุกรโดยประมาณ" 
                                  Variant="Variant.Outlined" 
                                  ReadOnly="true"
                                  HelperText="คำนวณอัตโนมัติ: วันลงทะเบียน + 120 วัน" />
                </MudItem>
                <MudItem xs="6">
                    <MudDatePicker @bind-Date="actualHarvestDate" Label="วันจับสุกรจริง" Variant="Variant.Outlined" />
                </MudItem>
                
                <!-- Feed Brand Selection -->
                <MudItem xs="12">
                    <MudDivider DividerType="DividerType.FullWidth" />
                    <MudText Typo="Typo.h6" Class="mt-3 mb-2">การเลือกยี่ห้ออาหาร</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
                        เลือกยี่ห้ออาหาร สูตรอาหารที่มีสำหรับยี่ห้อที่เลือกจะถูกกำหนดโดยอัตโนมัติ
                    </MudText>
                </MudItem>

                <MudItem xs="12">
                    <MudSelect T="string"
                             @bind-Value="selectedBrand"
                             Label="ยี่ห้ออาหาร"
                             Variant="Variant.Outlined"
                             Required="true">
                        <MudSelectItem T="string" Value="@((string?)null)">-- เลือกยี่ห้อ --</MudSelectItem>
                        @foreach (var brand in availableBrands)
                        {
                            <MudSelectItem T="string" Value="@brand">@brand</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                @if (!string.IsNullOrEmpty(selectedBrand))
                {
                    <MudItem xs="12">
                        <MudAlert Severity="Severity.Info" Class="mt-2">
                            <MudText Typo="Typo.body2">
                                เลือกยี่ห้อ <strong>@selectedBrand</strong> แล้ว สูตรอาหารทั้งหมดสำหรับยี่ห้อนี้จะถูกกำหนดโดยอัตโนมัติเมื่อสร้างคอกสุกร
                            </MudText>
                        </MudAlert>
                    </MudItem>
                }

                <!-- Note Section -->
                <MudItem xs="12">
                    <MudTextField @bind-Value="note" 
                                 Label="หมายเหตุ" 
                                 Variant="Variant.Outlined" 
                                 Lines="3"
                                 Placeholder="ป้อนข้อมูลเพิ่มเติมเกี่ยวกับคอกสุกรนี้..." />
                </MudItem>
            </MudGrid>
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">ยกเลิก</MudButton>
        <MudButton Color="Color.Primary" 
                  Variant="Variant.Filled" 
                  OnClick="Submit"
                  Disabled="@(!IsFormValid())">
            เพิ่มคอกสุกร
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;

    private List<Customer> customers = new();
    private List<string> availableBrands = new();
    private Customer? selectedCustomer;
    private string penCode = "";
    private PigPenType selectedType = PigPenType.Project;
    private int pigQty = 1;
    private decimal depositPerPig = 1500m;
    private DateTime? registerDate = DateTime.Today;
    private DateTime? estimatedHarvestDate;
    private DateTime? actualHarvestDate;

    // Feed brand selection property
    private string? selectedBrand;
    
    // Note property
    private string? note;

    protected override async Task OnInitializedAsync()
    {
        await LoadCustomers();
        await LoadAvailableBrands();
        
        // Calculate initial estimated harvest date based on default register date
        if (registerDate.HasValue)
        {
            estimatedHarvestDate = registerDate.Value.AddDays(120);
        }
    }

    private async Task LoadCustomers()
    {
        try
        {
            customers = await CustomerService.GetCustomersAsync();
        }
        catch
        {
            customers = new();
        }
    }

    private async Task LoadAvailableBrands()
    {
        try
        {
            var feedFormulas = await FeedFormulaService.GetAllFeedFormulasAsync();
            availableBrands = feedFormulas
                .Select(f => f.Brand ?? "")
                .Where(b => !string.IsNullOrEmpty(b))
                .Distinct()
                .OrderBy(b => b)
                .ToList();
        }
        catch
        {
            availableBrands = new();
        }
    }

    private void OnPigQuantityChanged(int newPigQty)
    {
        pigQty = newPigQty;
    }

    private void OnRegisterDateChanged(DateTime? newRegisterDate)
    {
        registerDate = newRegisterDate;
        
        // Automatically calculate estimated harvest date (register date + 120 days)
        if (newRegisterDate.HasValue)
        {
            estimatedHarvestDate = newRegisterDate.Value.AddDays(120);
            Console.WriteLine($"[OnRegisterDateChanged] Register date set to: {registerDate?.ToString("yyyy-MM-dd")}, Estimated harvest date automatically set to: {estimatedHarvestDate?.ToString("yyyy-MM-dd")}");
        }
        else
        {
            estimatedHarvestDate = null;
            Console.WriteLine($"[OnRegisterDateChanged] Register date cleared, estimated harvest date cleared");
        }
        
        StateHasChanged();
    }

    void Cancel() => MudDialog.Cancel();

    private async Task<IEnumerable<Customer>> SearchCustomers(string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return customers;
        
        return customers.Where(c => 
            c.DisplayName.Contains(searchString, StringComparison.OrdinalIgnoreCase) ||
            (c.Code?.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false));
    }

    private bool IsFormValid()
    {
        return selectedCustomer != null &&
               !string.IsNullOrWhiteSpace(penCode) &&
               pigQty > 0 &&
               registerDate.HasValue &&
               !string.IsNullOrWhiteSpace(selectedBrand);
    }

    async Task Submit()
    {
        if (!IsFormValid())
            return;

        try
        {
            // Convert dates to UTC to avoid timezone parsing issues on server
            var registerDateUtc = registerDate!.Value.ToUniversalTime();
            var actualHarvestDateUtc = actualHarvestDate?.ToUniversalTime();
            var estimatedHarvestDateUtc = estimatedHarvestDate?.ToUniversalTime();

            // Create the pig pen first
            var pigPenDto = new PigPenCreateDto(
                selectedCustomer!.Id,
                penCode,
                pigQty,
                registerDateUtc,
                actualHarvestDateUtc,
                estimatedHarvestDateUtc,
                selectedType,
                selectedBrand, // Save the selected brand
                depositPerPig, // Custom deposit per pig amount
                note // Note
            );

            Console.WriteLine($"[AddPigPenDialog] Creating pig pen with data: {System.Text.Json.JsonSerializer.Serialize(pigPenDto)}");

            var createdPigPen = await PigPenService.CreatePigPenAsync(pigPenDto);

            Console.WriteLine($"[AddPigPenDialog] Pig pen created successfully: {createdPigPen.Id}");

            // If a brand is selected, automatically assign all formulas for that brand
            if (!string.IsNullOrEmpty(selectedBrand))
            {
                var formulaAssignments = await CreateAutomaticFormulaAssignments(createdPigPen.Id, selectedBrand);
                if (formulaAssignments.Any())
                {
                    // Note: This is just to assign formulas - we might want to refactor this logic
                    var updateDto = new PigPenUpdateDto();
                    createdPigPen = await PigPenService.UpdatePigPenAsync(createdPigPen.Id, updateDto);
                }
            }

            MudDialog.Close(DialogResult.Ok(createdPigPen));
        }
        catch (HttpRequestException httpEx)
        {
            Console.Error.WriteLine($"[AddPigPenDialog] HTTP Error creating pig pen: {httpEx.Message}");
            Console.Error.WriteLine($"[AddPigPenDialog] HTTP Error details: {httpEx}");
            MudDialog.Cancel();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"[AddPigPenDialog] Error creating pig pen: {ex.Message}");
            Console.Error.WriteLine($"[AddPigPenDialog] Error details: {ex}");
            MudDialog.Cancel();
        }
    }

    private async Task<List<PigPenFormulaAssignment>> CreateAutomaticFormulaAssignments(Guid pigPenId, string brand)
    {
        try
        {
            // Get available formulas for the brand
            var formulas = await FeedFormulaCalculationService.GetFeedFormulasByBrandAsync(brand, pigQty);

            if (!formulas.Any())
                return new List<PigPenFormulaAssignment>();

            // Create assignments for all formulas that match the brand
            var assignments = new List<PigPenFormulaAssignment>();
            foreach (var formula in formulas)
            {
                var assignment = new PigPenFormulaAssignment(
                    Id: Guid.NewGuid(),
                    PigPenId: pigPenId,
                    OriginalFormulaId: formula.Id,
                    ProductCode: formula.ProductCode,
                    ProductName: formula.ProductName,
                    Brand: formula.Brand,
                    Stage: null, // Single formula, no stage
                    AssignedPigQuantity: pigQty,
                    AssignedBagPerPig: formula.BagPerPig,
                    AssignedTotalBags: formula.TotalBagsRequired,
                    AssignedAt: DateTime.Now,
                    EffectiveUntil: null, // Always effective
                    IsActive: true,
                    IsLocked: false,
                    LockReason: null,
                    LockedAt: null
                );
                assignments.Add(assignment);
            }

            return assignments;
        }
        catch
        {
            // If automatic assignment fails, return empty list (pig pen still created without formulas)
            return new List<PigPenFormulaAssignment>();
        }
    }
}
