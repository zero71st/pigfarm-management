@using PigFarmManagement.Shared.Models
@inject IFeedImportService FeedImportService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudDialog>
    <DialogContent>
        <style>
            .no-select-all thead tr th:first-child .mud-checkbox {
                visibility: hidden !important;
            }
        </style>
        <div class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-4">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏Å POSPOS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏Å @PenCode</MudText>
            
            <MudAlert Severity="Severity.Info" Class="mb-4">
                <MudText Typo="Typo.body2">
                    <strong>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong> @CustomerDisplayName<br/>
                    <strong>‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏≠‡∏Å:</strong> @PenCode<br/>
                    <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> @(_searchAllCustomers 
                        ? "‡πÅ‡∏™‡∏î‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° POSPOS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏Å‡∏ô‡∏µ‡πâ" 
                        : $"‡πÅ‡∏™‡∏î‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° POSPOS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ {_customerCode} ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏Å‡∏ô‡∏µ‡πâ")
                </MudText>
            </MudAlert>
            
            <!-- Date Range Filter -->
            <MudCard Class="mb-4">
                <MudCardContent>
                    <MudText Typo="Typo.h6" Class="mb-3">
                        <MudIcon Icon="@Icons.Material.Filled.Search" Class="mr-2"/>
                        ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                    </MudText>
                    
                    <!-- 1. Search All Customers Toggle -->
                    <div class="mb-3">
                        <MudSwitch @bind-Value="_searchAllCustomers"
                                   Color="Color.Primary"
                                   Label="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏∏‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"
                                   ThumbIcon="@(_searchAllCustomers ? Icons.Material.Filled.Groups : Icons.Material.Filled.Person)"
                                   UnCheckedColor="Color.Default" />
                    </div>
                    
                    <!-- 2. Invoice Code Search Box - Only show when searching all customers -->
                    @if (_searchAllCustomers)
                    {
                        <div class="mb-3">
                            <MudTextField @bind-Value="_invoiceCodeSearch"
                                        Label="‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ"
                                        Variant="Variant.Outlined"
                                        Adornment="Adornment.Start"
                                        AdornmentIcon="@Icons.Material.Filled.Search"
                                        HelperText="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™ ‡πÄ‡∏ä‡πà‡∏ô ST6802"
                                        Clearable="true"
                                        FullWidth="true" />
                        </div>
                    }
                    
                    <!-- 3. Date Range Filter -->
                    <MudText Typo="Typo.subtitle1" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.DateRange" Size="Size.Small" Class="mr-1"/>
                        ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                    </MudText>
                    
                    <div class="d-flex gap-4 justify-center" style="align-items: flex-end;">
                        <MudDatePicker Date="_fromDate"
                                     DateChanged="OnFromDateChanged"
                                     Label="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô"
                                     Variant="Variant.Outlined"
                                     Margin="Margin.Dense"
                                     DateFormat="yyyy-MM-dd" />
                        
                        <MudDatePicker @bind-Date="_toDate"
                                     Label="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î"
                                     Variant="Variant.Outlined"
                                    Margin="Margin.Dense"
                                     DateFormat="yyyy-MM-dd" />
                        
                        <MudButton Color="Color.Info" 
                                 Variant="Variant.Filled" 
                                 StartIcon="@Icons.Material.Filled.Search"
                                 OnClick="LoadAvailableTransactions"
                                 Disabled="_isLoading"
                                 Style="height: 40px;">
                            @if (_isLoading)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                <span class="ml-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</span>
                            }
                            else
                            {
                                <span>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</span>
                            }
                        </MudButton>
                        
                        <MudButton Color="Color.Secondary" 
                                 Variant="Variant.Outlined" 
                                 StartIcon="@Icons.Material.Filled.Clear"
                                 OnClick="ClearDateFilter"
                                 Disabled="_isLoading"
                                 Style="height: 40px;">
                            ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
                        </MudButton>
                    </div>
                    
                    @if (_fromDate.HasValue || _toDate.HasValue)
                    {
                        <MudText Typo="Typo.body2" Class="mt-2 text-info">
                            <MudIcon Icon="@Icons.Material.Filled.FilterAlt" Size="Size.Small" Class="mr-1"/>
                            @if (_fromDate.HasValue && _toDate.HasValue)
                            {
                                <span>‡∏Å‡∏£‡∏≠‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà @_fromDate.Value.ToString("yyyy-MM-dd") ‡∏ñ‡∏∂‡∏á @_toDate.Value.ToString("yyyy-MM-dd")</span>
                            }
                            else if (_fromDate.HasValue)
                            {
                                <span>‡∏Å‡∏£‡∏≠‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà @_fromDate.Value.ToString("yyyy-MM-dd") ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ</span>
                            }
                            else if (_toDate.HasValue)
                            {
                                <span>‡∏Å‡∏£‡∏≠‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ñ‡∏∂‡∏á @_toDate.Value.ToString("yyyy-MM-dd")</span>
                            }
                        </MudText>
                    }
                </MudCardContent>
            </MudCard>
            
            @if (_availableTransactions.Any())
            {
                <MudText Typo="Typo.h6" Class="mb-3">
                    @if (_searchAllCustomers)
                    {
                        <span>‡∏ö‡∏¥‡∏•‡∏Ç‡∏≤‡∏¢ POSPOS ‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏ó‡∏∏‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</span>
                    }
                    else
                    {
                        <span>‡∏ö‡∏¥‡∏•‡∏Ç‡∏≤‡∏¢ POSPOS ‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: @_customerCode</span>
                    }
                </MudText>
                
                <MudTable Items="_availableTransactions" Hover="true" Striped="true" MultiSelection="true" 
                         @bind-SelectedItems="_selectedTransactions" T="PosPosTransaction"
                         SelectOnRowClick="false"
                         Class="no-select-all">
                    <HeaderContent>
                        <MudTh><MudTableSortLabel SortBy="new Func<PosPosTransaction, object>(x => x.InvoiceReference.Code)">‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏¥‡∏•‡∏Ç‡∏≤‡∏¢</MudTableSortLabel></MudTh>
                        <MudTh><MudTableSortLabel SortBy="new Func<PosPosTransaction, object>(x => x.Timestamp)">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</MudTableSortLabel></MudTh>
                        <MudTh>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</MudTh>
                        <MudTh>‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</MudTh>
                        <MudTh>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</MudTh>
                        <MudTh>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</MudTh>
                        <MudTh>‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Invoice Code">
                            <MudChip Color="Color.Primary" Size="Size.Small">@context.InvoiceReference.Code</MudChip>
                        </MudTd>
                        <MudTd DataLabel="Date">@context.Timestamp.ToString("yyyy-MM-dd HH:mm")</MudTd>
                        <MudTd DataLabel="Customer">@context.BuyerDetail.FirstName @context.BuyerDetail.LastName</MudTd>
                        <MudTd DataLabel="Customer Code">
                            @if (!string.IsNullOrEmpty(context.BuyerDetail.Code))
                            {
                                <MudChip Color="Color.Secondary" Size="Size.Small">@context.BuyerDetail.Code</MudChip>
                            }
                            else
                            {
                                <MudChip Color="Color.Default" Size="Size.Small">N/A</MudChip>
                            }
                        </MudTd>
                        <MudTd DataLabel="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">@context.OrderList.Count ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</MudTd>
                        <MudTd DataLabel="‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°">@context.GrandTotal.ToString("N2")</MudTd>
                        <MudTd DataLabel="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">
                            <MudButton Size="Size.Small" Variant="Variant.Text" Color="Color.Info"
                                     OnClick="() => ShowTransactionDetails(context)">
                                üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                            </MudButton>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
                
                @if (_selectedTransactions.Any())
                {
                    <MudCard Class="mt-4">
                        <MudCardContent>
                            <MudText Typo="Typo.h6" Class="mb-2">‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏¥‡∏•‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</MudText>
                            <MudText Typo="Typo.body2">
                                ‚Ä¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß @_selectedTransactions.Count ‡∏ö‡∏¥‡∏•‡∏Ç‡∏≤‡∏¢<br/>
                                ‚Ä¢ ‡∏£‡∏ß‡∏° @_selectedTransactions.Sum(t => t.OrderList.Count) ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£<br/>
                                ‚Ä¢ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° @_selectedTransactions.Sum(t => t.GrandTotal).ToString("N2") ‡∏ö‡∏≤‡∏ó
                            </MudText>
                            
                            @if (_selectedTransactionDetails.Any())
                            {
                                <MudExpansionPanels Elevation="0" Class="mt-3">
                                    @foreach (var transaction in _selectedTransactions)
                                    {
                                        var panelText = $"{transaction.Code} - {transaction.GrandTotal:N2} ‡∏ö‡∏≤‡∏ó";
                                        <MudExpansionPanel Text="@panelText">>
                                            <div class="pa-2">
                                                @foreach (var item in transaction.OrderList)
                                                {
                                                    <MudChip Size="Size.Small" Color="Color.Secondary" Class="mr-1 mb-1">
                                                        @item.Name (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: @item.Stock) - @item.TotalPriceIncludeDiscount.ToString("N2") ‡∏ö‡∏≤‡∏ó
                                                    </MudChip>
                                                }
                                            </div>
                                        </MudExpansionPanel>
                                    }
                                </MudExpansionPanels>
                            }
                        </MudCardContent>
                    </MudCard>
                }
                
                <div class="d-flex justify-end gap-2 mt-4">
                    <MudButton Color="Color.Primary" 
                             Variant="Variant.Filled" 
                             StartIcon="@Icons.Material.Filled.Upload"
                             OnClick="ImportSelectedTransactions"
                             Disabled="_isImporting || !_selectedTransactions.Any()">
                        @if (_isImporting)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                            <span class="ml-2">Importing...</span>
                        }
                        else
                        {
                            <span>Import Selected (@_selectedTransactions.Count)</span>
                        }
                    </MudButton>
                </div>
            }
            else if (_isLoading)
            {
                <div class="d-flex justify-center align-center" style="height: 200px;">
                    <MudProgressCircular Size="Size.Large" Indeterminate="true" />
                    <MudText Class="ml-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° POSPOS...</MudText>
                </div>
            }
            else
            {
                <MudAlert Severity="Severity.Warning">
                    <MudText Typo="Typo.body1">
                        ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° POSPOS ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    </MudText>
                    <MudText Typo="Typo.body2" Class="mt-2">
                        ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ:
                        <br/>‚Ä¢ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏ô POSPOS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                        <br/>‚Ä¢ POSPOS API ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
                        <br/>‚Ä¢ ‡∏•‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà
                    </MudText>
                </MudAlert>
            }
            
            @if (_importResult != null)
            {
                <MudAlert Severity="@(_importResult.FailedImports > 0 ? Severity.Warning : Severity.Success)" Class="mt-4">
                    <MudText Typo="Typo.h6" Class="mb-2">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</MudText>
                    <MudText Typo="Typo.body2">
                        ‚Ä¢ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: @_importResult.SuccessfulImports ‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°<br/>
                        ‚Ä¢ ‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£: @_importResult.TotalFeedItems ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br/>
                        ‚Ä¢ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: @_importResult.FailedImports ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    </MudText>
                    
                    @if (_importResult.Errors.Any())
                    {
                        <MudText Typo="Typo.body2" Class="mt-2 text-error">
                            <strong>‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:</strong><br/>
                            @foreach (var error in _importResult.Errors)
                            {
                                <span>‚Ä¢ @error<br/></span>
                            }
                        </MudText>
                    }
                </MudAlert>
            }
        </div>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">‡∏õ‡∏¥‡∏î</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;
    
    [Parameter] public Guid PigPenId { get; set; }
    [Parameter] public string CustomerDisplayName { get; set; } = "";
    [Parameter] public string PenCode { get; set; } = "";
    [Parameter] public string CustomerCode { get; set; } = "";

    private bool _isLoading = true;
    private bool _isImporting;
    private string _customerCode = "";
    private List<PosPosTransaction> _availableTransactions = new();
    private HashSet<PosPosTransaction> _selectedTransactions = new();
    private List<PosPosTransaction> _selectedTransactionDetails = new();
    private FeedImportResult? _importResult;
    private DateTime? _fromDate; // Default to  1 week ago
    private DateTime? _toDate; // Default to today
    private bool _searchAllCustomers = false;
    private string _invoiceCodeSearch = "";

    protected override async Task OnInitializedAsync()
    {
        _customerCode = CustomerCode;

        // Set default date range: 2 days ago to today
        _fromDate = DateTime.Today.AddDays(-2);
        _toDate = DateTime.Today;
        
        await LoadAvailableTransactions();
    }

    private async Task LoadAvailableTransactions()
    {
        _isLoading = true;
        _selectedTransactions.Clear(); // Clear previous selections when reloading
        
        try
        {
            List<PosPosTransaction> allTransactions;
            
            // Determine date range
            DateTime fromDate;
            DateTime toDate;
            
            if (_fromDate.HasValue && _toDate.HasValue)
            {
                fromDate = _fromDate.Value;
                toDate = _toDate.Value;
            }
            else if (_fromDate.HasValue)
            {
                fromDate = _fromDate.Value;
                toDate = DateTime.UtcNow;
            }
            else if (_toDate.HasValue)
            {
                fromDate = DateTime.UtcNow.AddDays(-30);
                toDate = _toDate.Value;
            }
            else
            {
                fromDate = DateTime.Today.AddDays(-2);
                toDate = DateTime.Today;
            }
            
            // Search by customer or all customers
            if (_searchAllCustomers)
            {
                // Search all customers
                allTransactions = await FeedImportService.GetPosPosFeedByDateRangeAsync(fromDate, toDate);
            }
            else
            {
                // Search specific customer
                allTransactions = await FeedImportService.GetPosPosFeedByCustomerAndDateRangeAsync(
                    _customerCode, fromDate, toDate);
            }
            
            // Filter by invoice code if provided (case-insensitive partial match)
            if (!string.IsNullOrWhiteSpace(_invoiceCodeSearch))
            {
                allTransactions = allTransactions
                    .Where(t => t.InvoiceReference?.Code?.Contains(_invoiceCodeSearch, StringComparison.OrdinalIgnoreCase) == true)
                    .ToList();
            }
            
            // Filter to only show successful transactions
            allTransactions = allTransactions
                .Where(t => t.Status?.Equals("success", StringComparison.OrdinalIgnoreCase) == true)
                .ToList();
            
            _availableTransactions = allTransactions
                .OrderByDescending(t => t.Timestamp)
                .ToList();
                
            if (_availableTransactions.Any())
            {
                var dateRangeText = GetDateRangeDisplayText();
                var searchModeText = _searchAllCustomers ? "‡∏ó‡∏∏‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" : $"‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ {_customerCode}";
                var invoiceFilterText = !string.IsNullOrWhiteSpace(_invoiceCodeSearch) ? $" (‡∏Å‡∏£‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™: {_invoiceCodeSearch})" : "";
                Snackbar.Add($"‡∏û‡∏ö {_availableTransactions.Count} ‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° POSPOS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö{searchModeText}{dateRangeText}{invoiceFilterText}", Severity.Success);
            }
            else
            {
                var dateRangeText = GetDateRangeDisplayText();
                Snackbar.Add($"‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° POSPOS{dateRangeText}", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° POSPOS: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string GetDateRangeDisplayText()
    {
        if (_fromDate.HasValue && _toDate.HasValue)
        {
            return $" (‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà {_fromDate.Value:yyyy-MM-dd} ‡∏ñ‡∏∂‡∏á {_toDate.Value:yyyy-MM-dd})";
        }
        else if (_fromDate.HasValue)
        {
            return $" (‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà {_fromDate.Value:yyyy-MM-dd})";
        }
        else if (_toDate.HasValue)
        {
            return $" (‡∏ñ‡∏∂‡∏á {_toDate.Value:yyyy-MM-dd})";
        }
        return "";
    }

    private async Task ClearDateFilter()
    {
        _fromDate = null;
        _toDate = null;
        await LoadAvailableTransactions();
        Snackbar.Add("‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß", Severity.Info);
    }

    private void ShowTransactionDetails(PosPosTransaction transaction)
    {
        // Convert POSPOS transaction items to InvoiceItemDisplay format
        var invoiceItems = transaction.OrderList.Select(item => new InvoiceDetailsDialog.InvoiceItemDisplay
        {
            ProductCode = item.Code ?? "-",
            ProductName = item.Name ?? "-",
            Quantity = item.Stock,
            Unit = "‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö",
            UnitPriceBeforeDiscount = item.Price,
            UnitPrice = item.Price - item.CostDiscountPrice,
            Discount = item.CostDiscountPrice,
            Total = item.TotalPriceIncludeDiscount
        }).ToList();

        var parameters = new DialogParameters<InvoiceDetailsDialog>
        {
            { x => x.InvoiceItems, invoiceItems }
        };

        var options = new DialogOptions() 
        { 
            MaxWidth = MaxWidth.Large, 
            FullWidth = true,
            CloseButton = true,
            DisableBackdropClick = false
        };

        DialogService.Show<InvoiceDetailsDialog>("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", parameters, options);
    }

    private async Task ImportSelectedTransactions()
    {
        if (!_selectedTransactions.Any())
        {
            Snackbar.Add("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤", Severity.Warning);
            return;
        }

        _isImporting = true;
        try
        {
            // Create a specialized import request for this specific pig pen
            _importResult = await FeedImportService.ImportPosPosFeedForPigPenAsync(
                PigPenId, 
                _selectedTransactions.ToList()
            );
            
            if (_importResult.FailedImports == 0)
            {
                Snackbar.Add($"‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à {_importResult.SuccessfulImports} ‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£ {_importResult.TotalFeedItems} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ñ‡∏≠‡∏Å {PenCode}", Severity.Success);
                MudDialog.Close(DialogResult.Ok(_importResult));
            }
            else
            {
                Snackbar.Add($"‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î {_importResult.FailedImports} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isImporting = false;
        }
    }

    private void OnFromDateChanged(DateTime? newFromDate)
    {
        _fromDate = newFromDate;
        // When FromDate changes, set ToDate to the same date
        if (newFromDate.HasValue)
        {
            _toDate = newFromDate.Value;
        }
        StateHasChanged();
    }

    private void Cancel() => MudDialog.Cancel();
}
