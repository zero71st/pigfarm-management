@using Microsoft.AspNetCore.Components
@using MudBlazor
@using PigFarmManagement.Shared.Models
@using PigFarmManagement.Shared.DTOs
@inject IDialogService DialogService
@inject IPigPenService PigPenService
@inject ISnackbar Snackbar

@if (invoiceGroups.Any())
{
    <MudTable Items="@invoiceGroups" Hover="true" Striped="true" Dense="true">
        <HeaderContent>
            <MudTh>‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏¥‡∏•‡∏Ç‡∏≤‡∏¢</MudTh>
            <MudTh Style="text-align: center">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•‡∏Ç‡∏≤‡∏¢</MudTh>
            <MudTh Style="text-align: center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</MudTh>
            <MudTh Style="text-align: right">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</MudTh>
            <MudTh Style="text-align: center">‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏¥‡∏•‡∏Ç‡∏≤‡∏¢">@context.InvoiceReferenceCode</MudTd>
            <MudTd DataLabel="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•‡∏Ç‡∏≤‡∏¢" Style="text-align: center">
                @context.InvoiceDate.ToString("yyyy-MM-dd")
            </MudTd>
            <MudTd DataLabel="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£" Style="text-align: center">
                <MudChip Size="Size.Small" Color="Color.Info">@context.ItemCount</MudChip>
            </MudTd>
            <MudTd DataLabel="‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°" Style="text-align: right">
                <MudText Color="Color.Success"><strong>‡∏ø@context.TotalAmount.ToString("N2")</strong></MudText>
            </MudTd>
            <MudTd DataLabel="‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" Style="text-align: center">
                <div class="d-flex justify-center" style="gap:8px;">
                    <MudButton Color="Color.Info" 
                             Size="Size.Small"
                             Variant="Variant.Outlined"
                             Title="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"
                             OnClick="@(() => ShowInvoiceDetails(context))"
                             Style="white-space:nowrap;">
                        üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                    </MudButton>
                    <MudButton Color="Color.Error" 
                             Size="Size.Small"
                             Variant="Variant.Outlined"
                             Title="‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡∏Ç‡∏≤‡∏¢"
                             OnClick="@(() => DeleteInvoice(context))"
                             Disabled="@isLocked"
                             Style="white-space:nowrap;">
                        üóëÔ∏è ‡∏•‡∏ö
                    </MudButton>
                </div>
            </MudTd>
        </RowTemplate>
        <FooterContent>
            <MudTd colspan="3" Style="text-align: right; font-weight: bold;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</MudTd>
            <MudTd Style="text-align: right; font-weight: bold;">
                <MudText Color="Color.Success" Typo="Typo.h6">‡∏ø@invoiceGroups.Sum(i => i.TotalAmount).ToString("N2")</MudText>
            </MudTd>
            <MudTd></MudTd>
        </FooterContent>
    </MudTable>
    <!-- Mobile-only grand total bar -->
    <div class="d-flex d-sm-none justify-space-between align-center pa-3 mt-2" style="background:#ffffff;border:1px solid #e0e0e0;border-radius:6px;">
        <MudText Typo="Typo.subtitle2">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</MudText>
        <MudText Typo="Typo.h6" Color="Color.Success">‡∏ø@invoiceGroups.Sum(i => i.TotalAmount).ToString("N2")</MudText>
    </div>
}
else
{
    <MudAlert Severity="Severity.Info">
        <MudText>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏¥‡∏•‡∏Ç‡∏≤‡∏¢</MudText>
        <MudText Typo="Typo.body2" Class="mt-2">
            ‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏° "‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å POSPOS
        </MudText>
    </MudAlert>
}

@code {
    [Parameter] public Guid PigPenId { get; set; }
    [Parameter] public List<FeedItem> Feeds { get; set; } = new();
    [Parameter] public EventCallback OnInvoiceDeleted { get; set; }

    private List<InvoiceGroupDto> invoiceGroups = new();
    private bool isLocked = false;

    protected override async Task OnParametersSetAsync()
    {
        GroupInvoices();
        try
        {
            var pig = await PigPenService.GetPigPenByIdAsync(PigPenId);
            isLocked = pig?.IsCalculationLocked ?? false;
        }
        catch
        {
            isLocked = false;
        }
    }

    private void GroupInvoices()
    {
        // Group feeds by InvoiceReferenceCode and create InvoiceGroupDto objects
        invoiceGroups = Feeds
            .Where(f => !string.IsNullOrWhiteSpace(f.InvoiceReferenceCode))
            .GroupBy(f => f.InvoiceReferenceCode)
            .Select(g => new InvoiceGroupDto(
                InvoiceReferenceCode: g.Key!,
                TransactionCode: g.First().TransactionCode ?? "-",
                TotalAmount: g.Sum(f => f.Pos_TotalPriceIncludeDiscount ?? f.Sys_TotalPriceIncludeDiscount ?? 0),
                InvoiceDate: g.OrderByDescending(f => f.Date).First().Date,
                ItemCount: g.Count()
            ))
            .OrderBy(i => i.InvoiceDate)
            .ToList();
    }

    private async Task ShowInvoiceDetails(InvoiceGroupDto invoice)
    {
        // Get all feed items for this invoice
        var invoiceFeeds = Feeds
            .Where(f => f.InvoiceReferenceCode == invoice.InvoiceReferenceCode)
            .OrderBy(f => f.ProductCode)
            .ToList();

        // Convert to InvoiceItemDisplay
        var invoiceItems = invoiceFeeds.Select(f => new InvoiceDetailsDialog.InvoiceItemDisplay
        {
            ProductCode = f.ProductCode ?? "-",
            ProductName = f.ProductName ?? "-",
            Quantity = f.QuantityKg / 25m, // Convert kg to bags
            Unit = "‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö",
            UnitPriceBeforeDiscount = f.PricePerKg * 25m, // PricePerKg needs √ó25 conversion to per-bag
            UnitPrice = f.PriceIncludeDiscount ?? (f.PricePerKg * 25m), // Already per-bag from database
            Discount = f.CostDiscountPrice ?? 0, // Already per-bag from database
            Total = f.Pos_TotalPriceIncludeDiscount ?? f.Sys_TotalPriceIncludeDiscount ?? 0
        }).ToList();

        var parameters = new DialogParameters<InvoiceDetailsDialog>
        {
            { x => x.InvoiceItems, invoiceItems }
        };

        var options = new DialogOptions() 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        await DialogService.ShowAsync<InvoiceDetailsDialog>($"‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ - {invoice.InvoiceReferenceCode}", parameters, options);
    }

    private async Task DeleteInvoice(InvoiceGroupDto invoice)
    {
        var parameters = new DialogParameters<DeleteInvoiceConfirmDialog>
        {
            { x => x.InvoiceReferenceCode, invoice.InvoiceReferenceCode },
            { x => x.TotalAmount, invoice.TotalAmount },
            { x => x.ItemCount, invoice.ItemCount }
        };

        var options = new DialogOptions() 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<DeleteInvoiceConfirmDialog>("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡∏Ç‡∏≤‡∏¢", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is bool confirmed && confirmed)
        {
            try
            {
                var response = await PigPenService.DeleteInvoiceByReferenceAsync(PigPenId, invoice.InvoiceReferenceCode);
                
                Snackbar.Add(response.Message, Severity.Success);
                
                // Trigger parent refresh
                await OnInvoiceDeleted.InvokeAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡∏Ç‡∏≤‡∏¢: {ex.Message}", Severity.Error);
            }
        }
    }
}
