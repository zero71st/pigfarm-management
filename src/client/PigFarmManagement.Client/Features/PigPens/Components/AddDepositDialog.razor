@using Microsoft.AspNetCore.Components
@using MudBlazor
@using PigFarmManagement.Shared.Models
@using PigFarmManagement.Client.Features.PigPens.Services
@inject IPigPenService PigPenService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudGrid Spacing="3">
            <!-- Deposit Calculation Info Card -->
            @if (calculationInfo != null)
            {
                <MudItem xs="12">
                    <MudCard Style="background-color: #f8f9fa;">
                            <MudCardContent>
                                <MudGrid>
                                    <MudItem xs="12">
                                        <MudText Typo="Typo.subtitle2" Class="mb-2">
                                            üí∞ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
                                        </MudText>
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudText Typo="Typo.body2" Class="text-muted">
                                            ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤:
                                        </MudText>
                                        <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                            @calculationInfo.ExpectedTotalDepositFormatted
                                        </MudText>
                                        <MudText Typo="Typo.caption" Class="text-muted">
                                            (@calculationInfo.PigQuantity ‡∏ï‡∏±‡∏ß √ó @calculationInfo.DepositPerPigFormatted)
                                        </MudText>
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudText Typo="Typo.body2" Class="text-muted">
                                            ‡∏¢‡∏≠‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:
                                        </MudText>
                                        <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                            @calculationInfo.CurrentTotalDepositsFormatted
                                        </MudText>
                                        <MudText Typo="Typo.caption" Class="text-muted">
                                            (@calculationInfo.CompletionPercentageFormatted ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå)
                                        </MudText>
                                    </MudItem>
                                    <MudItem xs="12">
                                        <MudDivider Class="my-2" />
                                        <MudText Typo="Typo.body2" Class="text-muted">
                                            ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:
                                        </MudText>
                                        <MudText Typo="Typo.h6" Style="@($"color: {GetRemainingAmountColor()}")">
                                            @calculationInfo.RemainingDepositFormatted
                                        </MudText>
                                        @if (calculationInfo.RemainingDeposit == 0)
                                        {
                                            <MudText Typo="Typo.caption" Style="color: #4caf50;">
                                                ‚úÖ ‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß
                                            </MudText>
                                        }
                                    </MudItem>
                                </MudGrid>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                }
                
            <MudItem xs="12">
                <MudNumericField @bind-Value="amount" 
                               Label="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ø)" 
                               Variant="Variant.Outlined" 
                               Required="true"
                               Min="0.01m"
                               Format="N2"
                               Culture="@System.Globalization.CultureInfo.GetCultureInfo("th-TH")"
                               HelperText="‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏≤‡∏ó"
                               Error="@(!IsAmountValid())"
                               ErrorText="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0" />
            </MudItem>
            
            <MudItem xs="12">
                <MudDatePicker @bind-Date="depositDate" 
                             Label="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏î‡∏à‡∏≥" 
                             Variant="Variant.Outlined" 
                             Required="true"
                             MaxDate="DateTime.Today"
                             HelperText="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏°‡∏±‡∏î‡∏à‡∏≥ (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï)"
                             Error="@(!IsDateValid())"
                             ErrorText="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï" />
            </MudItem>
            
            <MudItem xs="12">
                <MudTextField @bind-Value="remark" 
                            Label="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)" 
                            Variant="Variant.Outlined" 
                            Lines="3"
                            MaxLength="500"
                            Counter="500"
                            HelperText="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏µ‡πâ" />
            </MudItem>
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</MudButton>
        <MudButton Color="Color.Primary" 
                   Variant="Variant.Filled" 
                   OnClick="Submit"
                   Disabled="@(!IsFormValid() || isSubmitting)"
                   StartIcon="@(isSubmitting ? null : Icons.Material.Filled.Save)">
            @if (isSubmitting)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                <MudText Class="ms-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°...</MudText>
            }
            else
            {
                <MudText>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥</MudText>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public Guid PigPenId { get; set; }
    [Parameter] public PigPen? PigPen { get; set; }
    [Parameter] public List<Deposit>? CurrentDeposits { get; set; }

    // When true, do not call API; return a local Deposit for the parent dialog to persist later.
    [Parameter] public bool IsDraft { get; set; } = false;

    private decimal amount = 0;
    private DateTime? depositDate = DateTime.Today;
    private string remark = "";
    private bool isSubmitting = false;
    private DepositCalculationInfo? calculationInfo;

    protected override void OnInitialized()
    {
        // Set default date to today
        depositDate = DateTime.Today;
    }

    protected override void OnParametersSet()
    {
        // Calculate deposit information if pig pen and deposits are provided
        if (PigPen != null && CurrentDeposits != null)
        {
            calculationInfo = DepositCalculationInfo.Create(PigPen, CurrentDeposits);
            
            // Auto-fill the remaining deposit amount as default
            if (calculationInfo.RemainingDeposit > 0 && amount == 0)
            {
                amount = calculationInfo.RemainingDeposit;
            }
        }
    }

    private string GetRemainingAmountColor()
    {
        if (calculationInfo == null) return "#666";
        
        return calculationInfo.RemainingDeposit switch
        {
            0 => "#4caf50", // Green - complete
            > 0 when calculationInfo.CompletionPercentage >= 0.5m => "#ff9800", // Orange - partial
            _ => "#f44336" // Red - needs attention
        };
    }

    private bool IsAmountValid()
    {
        return amount > 0;
    }

    private bool IsDateValid()
    {
        return depositDate.HasValue && depositDate.Value <= DateTime.Today;
    }

    private bool IsFormValid()
    {
        return IsAmountValid() && IsDateValid();
    }

    void Cancel() => MudDialog.Cancel();

    async Task Submit()
    {
        if (!IsFormValid() || isSubmitting)
            return;

        try
        {
            isSubmitting = true;
            StateHasChanged();

            // Send date-only value without timezone offset (prevents day shifting on UTC-hosted servers)
            var depositDateValue = DateOnlyUtc.AsUnspecifiedDate(depositDate!.Value);

            var cleanedRemark = string.IsNullOrWhiteSpace(remark) ? null : remark.Trim();

            if (IsDraft)
            {
                var draftDeposit = new Deposit(
                    Id: Guid.NewGuid(),
                    PigPenId: Guid.Empty,
                    Amount: amount,
                    Date: depositDateValue,
                    Remark: cleanedRemark
                );

                Snackbar.Add($"‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ ‡∏ø{amount:N2} (‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß)", Severity.Success);
                MudDialog.Close(DialogResult.Ok(draftDeposit));
                return;
            }

            var depositDto = new DepositCreateDto(amount, depositDateValue, cleanedRemark);
            var createdDeposit = await PigPenService.AddDepositAsync(PigPenId, depositDto);

            Snackbar.Add($"‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ ‡∏ø{amount:N2} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", Severity.Success);
            MudDialog.Close(DialogResult.Ok(createdDeposit));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }
}