@using Microsoft.AspNetCore.Components
@using MudBlazor
@using PigFarmManagement.Shared.Models
@using PigFarmManagement.Client.Features.Customers.Services
@using PigFarmManagement.Client.Features.PigPens.Services
@using PigFarmManagement.Client.Features.FeedFormulas.Services
@using PigFarmManagement.Shared
@inject ICustomerService CustomerService
@inject IPigPenService PigPenService
@inject IFeedFormulaCalculationService FeedFormulaCalculationService
@inject IFeedFormulaService FeedFormulaService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudContainer Style="max-width: 500px;">
            <MudGrid>
                <MudItem xs="12">
                    <MudAutocomplete T="Customer"
                                   Label="ลูกค้า"
                                   @bind-Value="selectedCustomer"
                                   SearchFunc="@SearchCustomers"
                                   ToStringFunc="@(c => c == null ? "" : $"{c.DisplayName} ({c.Status})")"
                                   Variant="Variant.Outlined"
                                   Required="true"
                                   Clearable="true"
                                   AdornmentIcon="@Icons.Material.Filled.Search"
                                   AdornmentColor="Color.Primary" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="penCode" Label="รหัสคอก" Variant="Variant.Outlined" Required="true" />
                </MudItem>
                <MudItem xs="12">
                    <MudSelect T="PigPenType" Value="selectedType" ValueChanged="@((PigPenType value) => { selectedType = value; StateHasChanged(); })" Label="ประเภทคอก" Variant="Variant.Outlined" Required="true">
                        <MudSelectItem T="PigPenType" Value="PigPenType.Cash">เงินสด</MudSelectItem>
                        <MudSelectItem T="PigPenType" Value="PigPenType.Project">โครงการ</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="@(selectedType == PigPenType.Project ? 6 : 12)">
                    <MudNumericField Value="pigQty" 
                                   ValueChanged="@((int value) => OnPigQuantityChanged(value))"
                                   Label="จำนวนสุกร" 
                                   Variant="Variant.Outlined" 
                                   Min="1" 
                                   Required="true" />
                </MudItem>
                @if (selectedType == PigPenType.Project)
                {
                    <MudItem xs="6">
                        <MudNumericField @bind-Value="depositPerPig" 
                                       Label="ค่ามัดจำ/ตัว" 
                                       Variant="Variant.Outlined" 
                                       Min="0" 
                                       Step="100"
                                       Format="N0"
                                       Required="true" 
                                       Adornment="Adornment.End" 
                                       AdornmentText="฿" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudPaper Class="pa-3" Elevation="2" Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <div class="d-flex justify-space-between align-center">
                                <MudText Typo="Typo.h6" Style="color: white; font-weight: 500;">ยอดเงินมัดจำทั้งหมด</MudText>
                                <MudText Typo="Typo.h4" Style="color: white; font-weight: bold;">฿@((pigQty * depositPerPig).ToString("N2"))</MudText>
                            </div>
                            <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.9); margin-top: 4px;">
                                @pigQty สุกร × ฿@depositPerPig.ToString("N0") = ฿@((pigQty * depositPerPig).ToString("N2"))
                            </MudText>
                            @if (totalPaidDeposit > 0)
                            {
                                <MudDivider Class="my-2" Style="background-color: rgba(255,255,255,0.3);" />
                                <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.9);">
                                    จ่ายแล้ว: ฿@totalPaidDeposit.ToString("N2") (@currentDeposits.Count รายการ)
                                </MudText>
                                <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.9);">
                                    คงเหลือ: ฿@((pigQty * depositPerPig - totalPaidDeposit).ToString("N2"))
                                </MudText>
                            }
                            <MudDivider Class="my-3" Style="background-color: rgba(255,255,255,0.3);" />
                            <MudButton Variant="Variant.Filled" 
                                       Color="Color.Warning"
                                       FullWidth="true"
                                       Size="Size.Large"
                                       StartIcon="@Icons.Material.Filled.Payment"
                                       Style="background: white; color: #667eea; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.2);"
                                       OnClick="ShowAddDepositDialog">
                                จ่ายเงินมัดจำ
                            </MudButton>
                        </MudPaper>
                    </MudItem>
                }
                <MudItem xs="6">
                    <MudDatePicker Date="registerDate" 
                                  DateChanged="@OnRegisterDateChanged"
                                  Label="วันที่ลงทะเบียน" 
                                  Variant="Variant.Outlined" 
                                  Required="true" />
                </MudItem>
                <MudItem xs="6">
                    <MudDatePicker @bind-Date="estimatedHarvestDate" 
                                  Label="วันจับสุกรโดยประมาณ" 
                                  Variant="Variant.Outlined" 
                                  ReadOnly="true"
                                  HelperText="คำนวณอัตโนมัติ: วันลงทะเบียน + 120 วัน" />
                </MudItem>
                <MudItem xs="6">
                    <MudDatePicker @bind-Date="actualHarvestDate" Label="นัดหมายจับสุกร" Variant="Variant.Outlined" />
                </MudItem>
                
                <!-- Feed Brand Selection -->
                <MudItem xs="12">
                    <MudDivider DividerType="DividerType.FullWidth" />
                    <MudText Typo="Typo.h6" Class="mt-3 mb-2">การเลือกยี่ห้ออาหาร</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
                        เลือกยี่ห้ออาหาร สูตรอาหารที่มีสำหรับยี่ห้อที่เลือกจะถูกกำหนดโดยอัตโนมัติ
                    </MudText>
                </MudItem>

                <MudItem xs="12">
                    <MudSelect T="string"
                             @bind-Value="selectedBrand"
                             Label="ยี่ห้ออาหาร"
                             Variant="Variant.Outlined"
                             Required="true">
                        <MudSelectItem T="string" Value="@((string?)null)">-- เลือกยี่ห้อ --</MudSelectItem>
                        @foreach (var brand in availableBrands)
                        {
                            <MudSelectItem T="string" Value="@brand">@brand</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                @if (!string.IsNullOrEmpty(selectedBrand))
                {
                    <MudItem xs="12">
                        <MudAlert Severity="Severity.Info" Class="mt-2">
                            <MudText Typo="Typo.body2">
                                เลือกยี่ห้อ <strong>@selectedBrand</strong> แล้ว สูตรอาหารทั้งหมดสำหรับยี่ห้อนี้จะถูกกำหนดโดยอัตโนมัติเมื่อปรับปรุงคอกสุกร
                            </MudText>
                        </MudAlert>
                    </MudItem>
                }

                <!-- Note Section -->
                <MudItem xs="12">
                    <MudTextField @bind-Value="note" 
                                 Label="หมายเหตุ" 
                                 Variant="Variant.Outlined" 
                                 Lines="3"
                                 Placeholder="ป้อนข้อมูลเพิ่มเติมเกี่ยวกับคอกสุกรนี้..." />
                </MudItem>
            </MudGrid>
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">ยกเลิก</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Save" Disabled="@(!IsFormValid())">
            บันทึก
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public PigPen PigPen { get; set; } = default!;

    private List<Customer> customers = new();
    private List<string> availableBrands = new();
    private Customer? selectedCustomer;
    private string penCode = "";
    private PigPenType selectedType = PigPenType.Cash;
    private int pigQty = 1;
    private decimal depositPerPig = 1500m;
    private DateTime? registerDate = DateTime.Today;
    private DateTime? actualHarvestDate;
    private DateTime? estimatedHarvestDate;
    
    // Feed brand selection property
    private string? selectedBrand;
    
    // Note property
    private string? note;
    
    // Deposit tracking
    private List<Deposit> currentDeposits = new();
    private decimal totalPaidDeposit => currentDeposits.Sum(d => d.Amount);

    protected override async Task OnInitializedAsync()
    {
        customers = await CustomerService.GetCustomersAsync();
        await LoadAvailableBrands();
        
        // Populate form with existing pig pen data
        selectedCustomer = customers.FirstOrDefault(c => c.Id == PigPen.CustomerId);
        penCode = PigPen.PenCode;
        selectedType = PigPen.Type;
        pigQty = PigPen.PigQty;
        depositPerPig = PigPen.DepositPerPig;
        registerDate = PigPen.RegisterDate;
        actualHarvestDate = PigPen.ActHarvestDate;
        estimatedHarvestDate = PigPen.EstimatedHarvestDate;
        note = PigPen.Note;
        
        // Load deposits
        try
        {
            currentDeposits = await PigPenService.GetDepositsAsync(PigPen.Id);
        }
        catch
        {
            currentDeposits = new();
        }
        
        // Initialize feed brand selection based on existing data
        InitializeFeedBrandSelection();
    }

    private async Task LoadAvailableBrands()
    {
        try
        {
            var feedFormulas = await FeedFormulaService.GetAllFeedFormulasAsync();
            availableBrands = feedFormulas
                .Select(f => f.Brand ?? "")
                .Where(b => !string.IsNullOrEmpty(b))
                .Distinct()
                .OrderBy(b => b)
                .ToList();
        }
        catch
        {
            availableBrands = new();
        }
    }

    private void InitializeFeedBrandSelection()
    {
        // First, try to get the brand from the pig pen's SelectedBrand property
        if (!string.IsNullOrEmpty(PigPen.SelectedBrand))
        {
            selectedBrand = PigPen.SelectedBrand;
            Console.WriteLine($"[EditPigPen - InitializeFeedBrandSelection] Found saved brand: {selectedBrand}");
            return;
        }
        
        // Fallback: Try to get the brand from existing formula assignments if available
        var activeAssignment = PigPen.FormulaAssignments.FirstOrDefault(fa => fa.IsActive && !fa.IsLocked);
        if (activeAssignment != null)
        {
            selectedBrand = activeAssignment.Brand;
            Console.WriteLine($"[EditPigPen - InitializeFeedBrandSelection] Found existing formula assignment brand: {selectedBrand}");
            return;
        }
        
        // Final fallback: Auto-select first available brand as default
        if (availableBrands.Any())
        {
            selectedBrand = availableBrands.First();
            Console.WriteLine($"[EditPigPen - InitializeFeedBrandSelection] No saved brand information. Auto-selecting default brand: {selectedBrand}");
        }
        else
        {
            Console.WriteLine($"[EditPigPen - InitializeFeedBrandSelection] No brands available");
        }
    }



    private void OnPigQuantityChanged(int newPigQty)
    {
        pigQty = newPigQty;
        Console.WriteLine($"[EditPigPen - OnPigQuantityChanged] Pig quantity changed to: {pigQty}");
    }

    private async Task ShowAddDepositDialog()
    {
        var parameters = new DialogParameters
        {
            { "PigPenId", PigPen.Id },
            { "PigPen", PigPen },
            { "CurrentDeposits", currentDeposits }
        };

        var dialog = await DialogService.ShowAsync<AddDepositDialog>("เพิ่มเงินมัดจำ", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is Deposit newDeposit)
        {
            // Refresh deposits from server
            try
            {
                currentDeposits = await PigPenService.GetDepositsAsync(PigPen.Id);
                StateHasChanged();
            }
            catch
            {
                // Fallback: add to local list
                currentDeposits.Add(newDeposit);
                StateHasChanged();
            }
        }
    }

    private void OnRegisterDateChanged(DateTime? newRegisterDate)
    {
        registerDate = newRegisterDate;
        
        // Automatically calculate estimated harvest date (register date + 120 days)
        if (newRegisterDate.HasValue)
        {
            estimatedHarvestDate = newRegisterDate.Value.AddDays(120);
            Console.WriteLine($"[EditPigPen - OnRegisterDateChanged] Register date set to: {registerDate?.ToString("yyyy-MM-dd")}, Estimated harvest date automatically set to: {estimatedHarvestDate?.ToString("yyyy-MM-dd")}");
        }
        else
        {
            estimatedHarvestDate = null;
            Console.WriteLine($"[EditPigPen - OnRegisterDateChanged] Register date cleared, estimated harvest date cleared");
        }
        
        StateHasChanged();
    }

    private async Task<IEnumerable<Customer>> SearchCustomers(string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return customers;
        
        return customers.Where(c => 
            c.DisplayName.Contains(searchString, StringComparison.OrdinalIgnoreCase) ||
            (c.Code?.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false));
    }

    private bool IsFormValid()
    {
        return selectedCustomer != null && 
               !string.IsNullOrWhiteSpace(penCode) && 
               pigQty > 0 && 
               registerDate.HasValue;
    }

    private async Task Save()
    {
        if (!IsFormValid() || selectedCustomer == null || !registerDate.HasValue)
            return;

        var oldQty = PigPen.PigQty;
        var newQty = pigQty;

        List<string>? preserveCodes = null;
        
        // Show confirmation dialog when pig quantity changes
        if (newQty != oldQty)
        {
            try
            {
                // Get used product usages from server
                var usages = await PigPenService.GetUsedProductUsagesAsync(PigPen.Id);
                
                var parameters = new DialogParameters<ConfirmReassignmentsDialog>
                {
                    { x => x.Assignments, PigPen.FormulaAssignments.Where(a => a.IsActive && !a.IsLocked).ToList() },
                    { x => x.OldQty, oldQty },
                    { x => x.NewQty, newQty },
                    { x => x.UsedProductUsages, usages }
                };

                var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium };
                var dialog = await DialogService.ShowAsync<ConfirmReassignmentsDialog>("ปรับการจัดสรรอาหาร", parameters, options);
                var result = await dialog.Result;
                
                if (result == null || result.Canceled)
                    return;
                    
                if (result.Data is List<string> codes)
                {
                    preserveCodes = codes;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading product usages: {ex.Message}");
                Snackbar.Add($"ไม่สามารถโหลดข้อมูลการใช้งานผลิตภัณฑ์: {ex.Message}", Severity.Warning);
                // Continue without preserve codes if failed to load usages
            }
        }

        var updateDto = new PigPenUpdateDto(
            PenCode: penCode,
            PigQty: pigQty,
            RegisterDate: registerDate.Value,
            ActHarvestDate: actualHarvestDate,
            EstimatedHarvestDate: estimatedHarvestDate,
            Type: selectedType,
            SelectedBrand: selectedBrand,
            DepositPerPig: selectedType == PigPenType.Project ? depositPerPig : 0m,
            Note: note,
            PreserveProductCodes: preserveCodes
        );

        try
        {
            var updatedPigPen = await PigPenService.UpdatePigPenAsync(PigPen.Id, updateDto);
            MudDialog.Close(DialogResult.Ok(updatedPigPen));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating pig pen: {ex.Message}", Severity.Error);
        }
    }

    private async Task<List<PigPenFormulaAssignment>> CreateAutomaticFormulaAssignments(Guid pigPenId, string brand)
    {
        try
        {
            // Get available formulas for the brand
            var formulas = await FeedFormulaCalculationService.GetFeedFormulasByBrandAsync(brand, pigQty);

            if (!formulas.Any())
                return new List<PigPenFormulaAssignment>();

            // Create assignments for all formulas that match the brand
            var assignments = new List<PigPenFormulaAssignment>();
            foreach (var formula in formulas)
            {
                var assignment = new PigPenFormulaAssignment(
                    Id: Guid.NewGuid(),
                    PigPenId: pigPenId,
                    OriginalFormulaId: formula.Id,
                    ProductCode: formula.ProductCode,
                    ProductName: formula.ProductName,
                    Brand: formula.Brand,
                    Stage: null, // Single formula, no stage
                    AssignedPigQuantity: pigQty,
                    AssignedBagPerPig: formula.BagPerPig,
                    AssignedTotalBags: formula.TotalBagsRequired,
                    AssignedAt: DateTime.Now,
                    EffectiveUntil: null, // Always effective
                    IsActive: true,
                    IsLocked: false,
                    LockReason: null,
                    LockedAt: null
                );
                assignments.Add(assignment);
            }

            return assignments;
        }
        catch
        {
            // If automatic assignment fails, return empty list (pig pen still updated without formulas)
            return new List<PigPenFormulaAssignment>();
        }
    }

    private void Cancel() => MudDialog.Cancel();
}
