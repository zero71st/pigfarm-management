@using Microsoft.AspNetCore.Components
@using MudBlazor
@using PigFarmManagement.Shared.Models
@using PigFarmManagement.Client.Features.PigPens.Services
@inject IPigPenService PigPenService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudContainer Style="max-width: 600px;">
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="mb-4">
                        <MudIcon Icon="Icons.Material.Filled.Agriculture" Class="mr-2" />
                        ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏™‡∏∏‡∏Å‡∏£
                    </MudText>
                </MudItem>
                
                <!-- Pig Pen Info Card -->
                @if (PigPen != null)
                {
                    <MudItem xs="12">
                        <MudCard Class="mb-4" Style="background-color: #f8f9fa;">
                            <MudCardContent>
                                <MudGrid>
                                    <MudItem xs="12">
                                        <MudText Typo="Typo.subtitle2" Class="mb-2">
                                            üê∑ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≠‡∏Å‡∏™‡∏∏‡∏Å‡∏£
                                        </MudText>
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudText Typo="Typo.body2" Class="text-muted">
                                            ‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏≠‡∏Å:
                                        </MudText>
                                        <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                            @PigPen.PenCode
                                        </MudText>
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudText Typo="Typo.body2" Class="text-muted">
                                            ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏∏‡∏Å‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:
                                        </MudText>
                                        <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                            @PigPen.PigQty ‡∏ï‡∏±‡∏ß
                                        </MudText>
                                    </MudItem>
                                    @if (remainingPigs > 0)
                                    {
                                        <MudItem xs="12">
                                            <MudAlert Severity="Severity.Info" Dense="true">
                                                <MudText Typo="Typo.body2">
                                                    <strong>@remainingPigs ‡∏ï‡∏±‡∏ß</strong> ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏ö‡∏™‡∏∏‡∏Å‡∏£
                                                </MudText>
                                            </MudAlert>
                                        </MudItem>
                                    }
                                    else if (remainingPigs < 0)
                                    {
                                        <MudItem xs="12">
                                            <MudAlert Severity="Severity.Warning" Dense="true">
                                                <MudText Typo="Typo.body2">
                                                    <strong>‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</strong> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏∏‡∏Å‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß (@totalHarvestedPigs) ‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≠‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö (@PigPen.PigQty)
                                                </MudText>
                                            </MudAlert>
                                        </MudItem>
                                    }
                                    else
                                    {
                                        <MudItem xs="12">
                                            <MudAlert Severity="Severity.Success" Dense="true">
                                                <MudText Typo="Typo.body2">
                                                    ‡∏à‡∏±‡∏ö‡∏™‡∏∏‡∏Å‡∏£‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏Å‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß
                                                </MudText>
                                            </MudAlert>
                                        </MudItem>
                                    }
                                </MudGrid>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                }

                <MudItem xs="12">
                    <MudForm @ref="form" @bind-IsValid="@isFormValid">
                        <MudGrid>
                            <!-- Harvest Date -->
                            <MudItem xs="12" md="6">
                                <MudDatePicker @bind-Date="harvestDate"
                                               Label="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡∏™‡∏∏‡∏Å‡∏£"
                                               Required="true"
                                               RequiredError="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡∏™‡∏∏‡∏Å‡∏£"
                                               MaxDate="DateTime.Today"
                                               HelperText="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏™‡∏∏‡∏Å‡∏£"
                                               Variant="Variant.Outlined" />
                            </MudItem>

                            <!-- Total Pigs -->
                            <MudItem xs="12" md="6">
                                <MudNumericField @bind-Value="totalPigs"
                                                 Label="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏∏‡∏Å‡∏£"
                                                 Required="true"
                                                 RequiredError="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏∏‡∏Å‡∏£"
                                                 Min="1"
                                                 Max="@(remainingPigs > 0 ? remainingPigs : PigPen?.PigQty ?? 1000)"
                                                 HelperText="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏∏‡∏Å‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö"
                                                 Variant="Variant.Outlined"
                                                 Adornment="Adornment.End"
                                                 AdornmentText="‡∏ï‡∏±‡∏ß"
                                                 OnBlur="CalculateRevenue" />
                            </MudItem>

                            <!-- Price Per Kg -->
                            <MudItem xs="12" md="6">
                                <MudNumericField @bind-Value="pricePerKg"
                                                 Label="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°"
                                                 Required="true"
                                                 RequiredError="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°"
                                                 Min="0.01m"
                                                 Step="0.01m"
                                                 Format="F2"
                                                 HelperText="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°"
                                                 Variant="Variant.Outlined"
                                                 Adornment="Adornment.Start"
                                                 AdornmentText="‡∏ø"
                                                 OnBlur="CalculateRevenue" />
                            </MudItem>

                            <!-- Total Weight -->
                            <MudItem xs="12" md="6">
                                <MudNumericField @bind-Value="totalWeight"
                                                 Label="‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°"
                                                 Required="true"
                                                 RequiredError="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°"
                                                 Min="0.1m"
                                                 Step="0.1m"
                                                 Format="F1"
                                                 HelperText="‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏™‡∏∏‡∏Å‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
                                                 Variant="Variant.Outlined"
                                                 Adornment="Adornment.End"
                                                 AdornmentText="‡∏Å‡∏Å."
                                                 OnBlur="CalculateWeightMetrics" />
                            </MudItem>

                            <!-- Calculated Metrics Display -->
                            @if (totalPigs > 0 && totalWeight > 0)
                            {
                                <MudItem xs="12">
                                    <MudDivider Class="my-2" />
                                    <MudText Typo="Typo.subtitle2" Class="mb-2">
                                        üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
                                    </MudText>
                                </MudItem>

                                <MudItem xs="12" md="4">
                                    <MudPaper Class="pa-3" Elevation="1">
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</MudText>
                                        <MudText Typo="Typo.h6">@averageWeight.ToString("F1") ‡∏Å‡∏Å.</MudText>
                                    </MudPaper>
                                </MudItem>

                                <MudItem xs="12" md="4">
                                    <MudPaper Class="pa-3" Elevation="1">
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡∏ï‡∏±‡∏ß</MudText>
                                        <MudText Typo="Typo.h6" Color="Color.Success">‡∏ø@revenuePerPig.ToString("N0")</MudText>
                                    </MudPaper>
                                </MudItem>

                                <MudItem xs="12" md="4">
                                    <MudPaper Class="pa-3" Elevation="1">
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</MudText>
                                        <MudText Typo="Typo.h6" Color="Color.Success">‡∏ø@totalRevenue.ToString("N0")</MudText>
                                    </MudPaper>
                                </MudItem>
                            }

                        </MudGrid>
                    </MudForm>
                </MudItem>
            </MudGrid>
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</MudButton>
        <MudButton Color="Color.Primary" 
                   Variant="Variant.Filled" 
                   OnClick="SaveHarvest" 
                   Disabled="@(!isFormValid || isSaving)"
                   StartIcon="@Icons.Material.Filled.Save">
            @if (isSaving)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                <MudText Class="ms-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</MudText>
            }
            else
            {
                <MudText>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</MudText>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;

    [Parameter] public Guid PigPenId { get; set; }
    [Parameter] public PigPen? PigPen { get; set; }
    [Parameter] public List<HarvestResult> ExistingHarvests { get; set; } = new();

    private MudForm form = null!;
    private bool isFormValid;
    private bool isSaving = false;

    // Form fields (in the order requested by user)
    private DateTime? harvestDate = DateTime.Today;
    private int totalPigs = 0;
    private decimal pricePerKg = 0;
    private decimal totalWeight = 0;

    // Calculated values
    private decimal averageWeight => totalPigs > 0 ? totalWeight / totalPigs : 0;
    private decimal totalRevenue => totalWeight * pricePerKg;
    private decimal revenuePerPig => totalPigs > 0 ? totalRevenue / totalPigs : 0;

    // Pig tracking
    private int totalHarvestedPigs => ExistingHarvests.Sum(h => h.PigCount);
    private int remainingPigs => PigPen?.PigQty - totalHarvestedPigs ?? 0;

    protected override void OnInitialized()
    {
        // Set default values if we have pig pen info
        if (PigPen != null && remainingPigs > 0)
        {
            totalPigs = Math.Min(remainingPigs, PigPen.PigQty);
        }
    }

    private void CalculateRevenue()
    {
        StateHasChanged();
    }

    private void CalculateWeightMetrics()
    {
        // Weight metrics are now calculated automatically from total weight and pig count
        StateHasChanged();
    }

    private async Task SaveHarvest()
    {
        if (!isFormValid || isSaving) return;

        isSaving = true;
        StateHasChanged();

        try
        {
            // Validate the form
            await form.Validate();
            if (!form.IsValid) 
            {
                isSaving = false;
                return;
            }

            // Create the harvest DTO for the API
            var harvestDto = new HarvestCreateDto(
                HarvestDate: harvestDate!.Value,
                PigCount: totalPigs,
                AvgWeight: averageWeight,
                TotalWeight: totalWeight,
                SalePricePerKg: pricePerKg,
                Revenue: totalRevenue
            );

            // Call the API to save the harvest
            var createdHarvest = await PigPenService.AddHarvestResultAsync(PigPenId, harvestDto);

            Snackbar.Add($"Harvest record saved successfully. Revenue: ‡∏ø{totalRevenue:N2}", Severity.Success);
            MudDialog.Close(DialogResult.Ok(createdHarvest));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving harvest: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}