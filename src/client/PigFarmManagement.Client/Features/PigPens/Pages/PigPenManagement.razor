@page "/pigpens"
@attribute [Authorize]
@using System.Linq
@using Microsoft.AspNetCore.Authorization
@using PigFarmManagement.Client.Features.PigPens.Components
@inject ICustomerService CustomerService
@inject IPigPenService PigPenService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<PageTitle>PIG PEN MANAGEMENT - Pig Pens</PageTitle>

<style>
    /* Responsive text switches: show Thai on small screens, English on larger */
    @@media (max-width: 600px) {
        .desktop-only { display: none !important; }
        .mobile-only { display: inline !important; }
    }
    @@media (min-width: 601px) {
        .desktop-only { display: inline !important; }
        .mobile-only { display: none !important; }
    }

    /* Header action stacking on mobile */
    .header-row { display: flex; }
    .actions-row { display: flex; gap: 8px; }
    @@media (max-width: 600px) {
        .header-row { flex-direction: column !important; align-items: stretch !important; gap: 8px; }
        .actions-row { flex-direction: column !important; width: 100% !important; }
        .actions-row .mud-button-root { width: 100% !important; }
    }
</style>
<div class="d-flex align-center mb-4">
    <MudIcon Icon="@Icons.Material.Filled.Pets" Size="Size.Large" Class="mr-2" Color="Color.Primary" />
    <MudText Typo="Typo.h4" GutterBottom="false">จัดการคอกสุกร</MudText>
</div>

<!-- Statistics Cards -->
<MudGrid Class="mb-4">
    <MudItem xs="12" sm="4">
        <MudPaper Elevation="2" Class="pa-4" Style="cursor: pointer;" @onclick="() => SetStatusFilter(null)">
            <div class="d-flex align-center" style="gap:12px;">
                <MudIcon Icon="@Icons.Material.Filled.Home" Size="Size.Large" Color="Color.Primary" />
                <div class="d-flex flex-column" style="line-height:1;">
                    <MudText Typo="Typo.h3" Style="margin:0;color:#6C4CFF;">@GetTotalCount()</MudText>
                    <MudText Typo="Typo.caption" Style="color:#FF4D79;">คอกสุกรกำลังเลี้ยงทั้งหมด</MudText>
                </div>
            </div>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="4">
        <MudPaper Elevation="2" Class="pa-4" Style="cursor: pointer;" @onclick="() => SetStatusFilter(PigPenStatus.Active)">
            <div class="d-flex align-center" style="gap:12px;">
                <MudIcon Icon="@Icons.Material.Filled.Pets" Size="Size.Large" Color="Color.Success" />
                <div class="d-flex flex-column" style="line-height:1;">
                    <MudText Typo="Typo.h3" Style="margin:0;color:#21B573;">@GetActiveCount()</MudText>
                    <MudText Typo="Typo.caption" Style="color:#FF4D79;">กำลังเลี้ยง</MudText>
                </div>
            </div>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="4">
        <MudPaper Elevation="2" Class="pa-4" Style="cursor: pointer;" @onclick="() => SetStatusFilter(PigPenStatus.Closed)">
            <div class="d-flex align-center" style="gap:12px;">
                <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Large" Color="Color.Error" />
                <div class="d-flex flex-column" style="line-height:1;">
                    <MudText Typo="Typo.h3" Style="margin:0;color:#FF5A5F;">@GetClosedCount()</MudText>
                    <MudText Typo="Typo.caption" Style="color:#FF4D79;">ปิดคอกแล้ว</MudText>
                </div>
            </div>
        </MudPaper>
    </MudItem>
</MudGrid>

<!-- Filter and Search Section -->
<MudPaper Class="pa-4 ma-2" Elevation="2">
    <MudGrid>
        <MudItem xs="12" md="5">
                <MudAutocomplete T="Customer"
                               Label="กรองลูกค้า"
                               @bind-Value="SelectedCustomer"
                               SearchFunc="@SearchCustomers"
                               ToStringFunc="@(c => c == null ? "ลูกค้าทั้งหมด" : $"{c.DisplayName} ({c.Status})")"
                               Variant="Variant.Outlined"
                               Margin="Margin.Dense"
                               Clearable="true"
                               AdornmentIcon="@Icons.Material.Filled.Search"
                               AdornmentColor="Color.Primary" />
        </MudItem>
        <MudItem xs="12" md="3">
                <MudSelect T="PigPenType?" @bind-Value="SelectedPigPenType" Margin="Margin.Dense" Label="กรองประเภท" Variant="Variant.Outlined">
                    <MudSelectItem T="PigPenType?" Value="@((PigPenType?)null)">ทุกประเภท</MudSelectItem>
                    <MudSelectItem T="PigPenType?" Value="PigPenType.Cash">เงินสด</MudSelectItem>
                    <MudSelectItem T="PigPenType?" Value="PigPenType.Project">โครงการ</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="3">
                <MudSelect T="PigPenStatus?" @bind-Value="SelectedStatus" Margin="Margin.Dense" Label="กรองสถานะ" Variant="Variant.Outlined">
                    <MudSelectItem T="PigPenStatus?" Value="@((PigPenStatus?)null)">ทุกสถานะ</MudSelectItem>
                    <MudSelectItem T="PigPenStatus?" Value="PigPenStatus.Active">กำลังเลี้ยง</MudSelectItem>
                    <MudSelectItem T="PigPenStatus?" Value="PigPenStatus.Closed">ปิดคอกแล้ว</MudSelectItem>
            </MudSelect>
        </MudItem>
    </MudGrid>
</MudPaper>

<!-- Pig Pen Management Section -->
<MudPaper Class="pa-4 ma-2" Elevation="2">
    <div class="d-flex justify-space-between align-center mb-4 header-row">
        <div class="d-flex align-center" style="gap:8px;">
            <MudIcon Icon="@Icons.Material.Filled.List" Color="Color.Primary" />
            <MudText Typo="Typo.h6">รายการคอกสุกร</MudText>
        </div>
        <div class="d-flex gap-2 actions-row">
            <MudSelect T="SortOrder" @bind-Value="SelectedSortOrder" 
                       Margin="Margin.Dense" 
                       Variant="Variant.Outlined"
                       Style="min-width: 200px;"
                       Dense="true">
                <MudSelectItem T="SortOrder" Value="SortOrder.LatestUpdate">อัพเดตล่าสุด</MudSelectItem>
                <MudSelectItem T="SortOrder" Value="SortOrder.LongestSinceFeed">รับอาหารนานสุด</MudSelectItem>
                <MudSelectItem T="SortOrder" Value="SortOrder.ClosestToHarvest">ใกล้จับที่สุด</MudSelectItem>
            </MudSelect>
            <MudButton Variant="Variant.Outlined" 
                       Color="Color.Info"
                       StartIcon="@Icons.Material.Filled.Refresh"
                       OnClick="RefreshData"
                       Size="Size.Small">
                รีเฟรช
            </MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                       StartIcon="@Icons.Material.Filled.Add" OnClick="ShowAddDialog">
                เพิ่มคอกใหม่
            </MudButton>
        </div>
    </div>

    <MudTable Items="@filteredPigPens" Hover="true" Striped="true" Loading="@loading">
        <HeaderContent>
            <MudTh>ลูกค้า</MudTh>
            <MudTh>รหัสคอก</MudTh>
            <MudTh>ประเภท</MudTh>
            <MudTh>สถานะ</MudTh>
            <MudTh>จำนวน</MudTh>
            <MudTh>วันที่ลงทะเบียน</MudTh>
            <MudTh>ประมาณการจับ</MudTh>
            <MudTh>ระยะเวลาเลี้ยง</MudTh>
            <MudTh>รับอาหารล่าสุด</MudTh>
            <MudTh>การดำเนินการ</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="ลูกค้า">@GetCustomerName(context.CustomerId)</MudTd>
            <MudTd DataLabel="รหัสคอก">@context.PenCode</MudTd>
            <MudTd DataLabel="ประเภท">
                <MudChip Color="@(context.Type == PigPenType.Cash ? Color.Success : Color.Info)" 
                         Size="Size.Small" Variant="Variant.Filled">
                    @(context.Type == PigPenType.Cash ? "เงินสด" : "โครงการ")
                </MudChip>
            </MudTd>
            <MudTd DataLabel="สถานะ">
                @if (context.IsCalculationLocked)
                {
                    <MudChip Color="Color.Error" 
                             Size="Size.Small" 
                             Variant="Variant.Filled"
                             Icon="@Icons.Material.Filled.Lock">
                        ปิดคอกแล้ว
                    </MudChip>
                }
                else if (context.HasHarvests)
                {
                    <MudChip Color="Color.Info" 
                             Size="Size.Small" 
                             Variant="Variant.Filled"
                             Icon="@Icons.Material.Filled.CheckCircle">
                        จับแล้ว
                    </MudChip>
                }
                else if (context.ActHarvestDate.HasValue)
                {
                    <MudChip Color="Color.Warning" 
                             Size="Size.Small" 
                             Variant="Variant.Filled"
                             Icon="@Icons.Material.Filled.EventAvailable">
                        นัดหมายแล้ว
                    </MudChip>
                }
                else
                {
                    <MudChip Color="Color.Success" 
                             Size="Size.Small" 
                             Variant="Variant.Filled"
                             Icon="@Icons.Material.Filled.Pets">
                        กำลังเลี้ยง
                    </MudChip>
                }
            </MudTd>
            <MudTd DataLabel="จำนวน">@context.PigQty</MudTd>
            <MudTd DataLabel="วันที่ลงทะเบียน">@context.RegisterDate.ToString("d/M/yyyy")</MudTd>
            <MudTd DataLabel="ประมาณการจับ" Style="text-align: center;">
                @if (context.EstimatedHarvestDate.HasValue)
                {
                    var harvestDate = context.EstimatedHarvestDate.Value;
                    var month = harvestDate.Month;
                    var weekOfMonth = (harvestDate.Day - 1) / 7 + 1;
                    
                    // Calculate week start (Monday) and end (Sunday)
                    var dayOfWeek = (int)harvestDate.DayOfWeek;
                    var daysToMonday = dayOfWeek == 0 ? 6 : dayOfWeek - 1;
                    var weekStart = harvestDate.AddDays(-daysToMonday);
                    var weekEnd = weekStart.AddDays(6);
                    
                    // Thai month abbreviations
                    string[] thaiMonths = { "ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค." };
                    var startMonth = thaiMonths[weekStart.Month - 1];
                    var endMonth = thaiMonths[weekEnd.Month - 1];
                    var startYear = (weekStart.Year + 543) % 100;
                    var endYear = (weekEnd.Year + 543) % 100;
                    
                    <div class="d-flex flex-column align-center" style="gap: 4px;">
                        <div class="d-flex align-center" style="gap:8px;">
                            <MudChip Size="Size.Small" Color="Color.Primary" Variant="Variant.Text" Style="font-size: 1.1rem; font-weight: 600; height: 24px;">
                                @month/@weekOfMonth
                            </MudChip>
                            <MudText Typo="Typo.overline" Color="Color.Primary" Style="font-size:0.72rem; opacity:0.95;">
                                (@harvestDate.ToString("d/M/yyyy"))
                            </MudText>
                        </div>
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Style="white-space: nowrap; font-size: 0.7rem;">
                            @weekStart.Day @startMonth @startYear.ToString("00") - @weekEnd.Day @endMonth @endYear.ToString("00")
                        </MudText>
                    </div>
                }
                else
                {
                    <MudText Color="Color.Secondary">
                        <span class="desktop-only">N/A</span>
                        <span class="mobile-only">ไม่ระบุ</span>
                    </MudText>
                }
            </MudTd>
            <MudTd DataLabel="ระยะเวลาเลี้ยง">
                @if (context.ActHarvestDate.HasValue)
                {
                    var daysRaised = (context.ActHarvestDate.Value - context.RegisterDate).Days;
                    <MudChip Size="Size.Small" Color="Color.Info" Variant="Variant.Filled">
                        เลี้ยง @daysRaised วัน
                    </MudChip>
                }
                else if (context.EstimatedHarvestDate.HasValue)
                {
                    var daysRemaining = (context.EstimatedHarvestDate.Value - DateTime.Now).Days;
                    var chipColor = daysRemaining <= 0 ? Color.Error : (daysRemaining < 20 ? Color.Warning : Color.Success);
                    <MudChip Size="Size.Small" Color="@chipColor" Variant="Variant.Filled">
                        เหลือ @daysRemaining วัน
                    </MudChip>
                }
                else
                {
                    <MudText Color="Color.Secondary">
                        <span class="desktop-only">N/A</span>
                        <span class="mobile-only">ไม่ระบุ</span>
                    </MudText>
                }
            </MudTd>
            <MudTd DataLabel="รับอาหารล่าสุด" Style="text-align: center;">
                @if (feedImportDates.TryGetValue(context.Id, out var importData) && importData?.LastImportDate.HasValue == true)
                {
                    var days = importData.DaysSinceLastImport ?? 0;
                    var badgeColor = days <= 15 ? Color.Success : (days <= 30 ? Color.Warning : Color.Error);
                    <div class="d-flex flex-column align-center" style="gap: 4px;">
                        <MudChip Size="Size.Small" Color="@badgeColor" Variant="Variant.Filled" Style="font-weight: 600;">
                            @days วัน
                        </MudChip>
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Style="font-size: 0.7rem;">
                            @importData.LastImportDate.Value.ToString("d/M/yyyy")
                        </MudText>
                    </div>
                }
                else
                {
                    <MudText Color="Color.Secondary" Typo="Typo.caption">ไม่เคยรับอาหาร</MudText>
                }
            </MudTd>
            <MudTd DataLabel="การดำเนินการ">
                <div class="d-flex flex-column" style="gap:6px;">
                    <div class="d-flex gap-1" style="align-items:center;">
                        <MudButton Size="Size.Small"
                                  Variant="Variant.Text"
                                  Color="Color.Primary"
                                  Class="pa-1"
                                  Style="min-width: 32px; font-size: 16px; line-height: 1;"
                                  OnClick="() => NavigateToPigPenDetail(context.Id)"
                                  Title="ดูรายละเอียด">
                            <MudIcon Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" />
                        </MudButton>
                        <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" Dense="true">
                            <MudMenuItem OnClick="() => ShowPosImportDialog(context.Id, GetCustomerName(context.CustomerId), context.PenCode, GetCustomerCode(context.CustomerId))">
                                <div class="d-flex align-center gap-2">
                                    <MudIcon Icon="@Icons.Material.Filled.Download" Size="Size.Small" Color="Color.Info" />
                                    <MudText>นำเข้าอาหาร</MudText>
                                </div>
                            </MudMenuItem>
                            <MudMenuItem OnClick="() => ShowEditDialog(context)" Disabled="@IsPigPenClosed(context)">
                                <div class="d-flex align-center gap-2">
                                    <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Warning" />
                                    <MudText>แก้ไข</MudText>
                                </div>
                            </MudMenuItem>
                            <MudMenuItem OnClick="() => ShowDeleteDialog(context)">
                                <div class="d-flex align-center gap-2">
                                    <MudIcon Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" />
                                    <MudText>ลบ</MudText>
                                </div>
                            </MudMenuItem>
                        </MudMenu>
                    </div>

                    <div>
                        <MudText Typo="Typo.caption" Color="@(IsRecentlyUpdated(context.UpdatedAt) ? Color.Primary : Color.Secondary)" Style="font-size:0.75rem; white-space:nowrap;">
                            @FormatRelativeShort(context.UpdatedAt)
                        </MudText>
                    </div>
                </div>
            </MudTd>
        </RowTemplate>
    </MudTable>
</MudPaper>

@code {
    private enum PigPenStatus
    {
        Active,
        Closed
    }

    private enum SortOrder
    {
        LatestUpdate,
        LongestSinceFeed,
        ClosestToHarvest
    }

    private List<Customer> customers = new();
    private List<PigPen> pigPens = new();
    private List<PigPen> filteredPigPens = new();
    private Dictionary<Guid, LastFeedImportDateDto?> feedImportDates = new();
    private bool loading = true;
    private Customer? selectedCustomer = null;
    private PigPenType? selectedPigPenType = null;
    private PigPenStatus? selectedStatus = PigPenStatus.Active;
    private SortOrder selectedSortOrder = SortOrder.LatestUpdate;
    private DateTime lastRefreshTime = DateTime.MinValue;

    private Customer? SelectedCustomer
    {
        get => selectedCustomer;
        set
        {
            selectedCustomer = value;
            FilterPigPens();
        }
    }

    private PigPenType? SelectedPigPenType
    {
        get => selectedPigPenType;
        set
        {
            selectedPigPenType = value;
            FilterPigPens();
        }
    }

    private PigPenStatus? SelectedStatus
    {
        get => selectedStatus;
        set
        {
            selectedStatus = value;
            FilterPigPens();
        }
    }

    private SortOrder SelectedSortOrder
    {
        get => selectedSortOrder;
        set
        {
            selectedSortOrder = value;
            FilterPigPens();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
        {
            // Auto-refresh data if it's been more than 30 seconds since last refresh
            // This helps when navigating back from detail pages after operations
            if ((DateTime.Now - lastRefreshTime).TotalSeconds > 30)
            {
                await LoadData();
            }
        }
    }

    private async Task LoadData()
    {
        try
        {
            loading = true;

            var customersTask = CustomerService.GetCustomersAsync();
            var pigPensTask = PigPenService.GetPigPensAsync();
            var feedImportsTask = PigPenService.GetLastFeedImportsAsync();

            await Task.WhenAll(customersTask, pigPensTask, feedImportsTask);

            customers = customersTask.Result;
            pigPens = pigPensTask.Result;
            
            // Map batch results to dictionary
            feedImportDates = feedImportsTask.Result.ToDictionary(x => x.PigPenId, x => (LastFeedImportDateDto?)x);

            FilterPigPens();
            lastRefreshTime = DateTime.Now;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"เกิดข้อผิดพลาดในการโหลดข้อมูล: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private void FilterPigPens()
    {
        var selectedCustomerId = selectedCustomer?.Id;
        
        var filtered = pigPens.Where(p =>
            (selectedCustomerId == null || p.CustomerId == selectedCustomerId) &&
            (selectedPigPenType == null || p.Type == selectedPigPenType) &&
            (selectedStatus == null || 
                (selectedStatus == PigPenStatus.Active && !p.IsCalculationLocked) ||
                (selectedStatus == PigPenStatus.Closed && p.IsCalculationLocked))
        );

        // Apply sorting based on selected order
        filteredPigPens = selectedSortOrder switch
        {
            SortOrder.LatestUpdate => filtered.OrderByDescending(p => p.UpdatedAt).ToList(),
            SortOrder.LongestSinceFeed => filtered.OrderByDescending(p => 
                feedImportDates.TryGetValue(p.Id, out var importData) && importData?.DaysSinceLastImport.HasValue == true
                    ? importData.DaysSinceLastImport.Value
                    : int.MaxValue // Put pens with no feed imports at the top
            ).ToList(),
            SortOrder.ClosestToHarvest => filtered.OrderBy(p => 
                p.EstimatedHarvestDate ?? DateTime.MaxValue // Put pens without harvest date at the end
            ).ToList(),
            _ => filtered.OrderByDescending(p => p.UpdatedAt).ToList()
        };
    }

    private async Task RefreshData()
    {
        await LoadData();
        Snackbar.Add("รีเฟรชข้อมูลสำเร็จ", Severity.Info);
    }

    private async Task<IEnumerable<Customer>> SearchCustomers(string searchString)
    {
        // Return all customers if search is empty
        if (string.IsNullOrWhiteSpace(searchString))
            return customers;
        
        // Filter customers by display name or code
        return customers.Where(c => 
            c.DisplayName.Contains(searchString, StringComparison.OrdinalIgnoreCase) ||
            (c.Code?.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false));
    }

    private void SetStatusFilter(PigPenStatus? status)
    {
        SelectedStatus = status;
    }

    private int GetTotalCount()
    {
        // Apply customer and type filters, but not status filter
        var selectedCustomerId = selectedCustomer?.Id;
        
        return pigPens.Where(p =>
            (selectedCustomerId == null || p.CustomerId == selectedCustomerId) &&
            (selectedPigPenType == null || p.Type == selectedPigPenType)
        ).Count();
    }

    private int GetActiveCount()
    {
        // Apply customer and type filters, plus active status
        var selectedCustomerId = selectedCustomer?.Id;
        
        return pigPens.Where(p =>
            (selectedCustomerId == null || p.CustomerId == selectedCustomerId) &&
            (selectedPigPenType == null || p.Type == selectedPigPenType) &&
            !p.IsCalculationLocked
        ).Count();
    }

    private int GetClosedCount()
    {
        // Apply customer and type filters, plus closed status
        var selectedCustomerId = selectedCustomer?.Id;
        
        return pigPens.Where(p =>
            (selectedCustomerId == null || p.CustomerId == selectedCustomerId) &&
            (selectedPigPenType == null || p.Type == selectedPigPenType) &&
            p.IsCalculationLocked
        ).Count();
    }

    private string GetCustomerName(Guid customerId)
    {
        // Default to Thai label for unknown customers (mobile-friendly)
        return customers.FirstOrDefault(c => c.Id == customerId)?.DisplayName ?? "ไม่ทราบ";
    }

    private async Task ShowAddDialog()
    {
        var dialog = await DialogService.ShowAsync<AddPigPenDialog>("เพิ่มคอกใหม่");
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadData();
            Snackbar.Add("เพิ่มคอกสุกรสำเร็จ!", Severity.Success);
        }
    }

    private async Task ShowPosImportDialog(Guid pigPenId, string customerName, string penCode, string customerCode)
    {
        var parameters = new DialogParameters
        {
            { "PigPenId", pigPenId },
            { "CustomerDisplayName", customerName },
            { "PenCode", penCode },
            { "CustomerCode", customerCode }
        };

        var dialog = await DialogService.ShowAsync<PigPenPosImportDialog>("นำเข้าข้อมูลอาหารจาก POSPOS", parameters, new DialogOptions 
        { 
            MaxWidth = MaxWidth.Large,
            FullWidth = true 
        });
        
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadData(); // Refresh the list after import
            Snackbar.Add("นำเข้าอาหารจาก POSPOS สำเร็จ!", Severity.Success);
        }
    }

    private string GetCustomerCode(Guid customerId)
    {
        var customer = customers.FirstOrDefault(c => c.Id == customerId);
        return customer?.Code ?? "";
    }

    private void NavigateToPigPenDetail(Guid pigPenId)
    {
        NavigationManager.NavigateTo($"/pigpens/{pigPenId}/detail");
    }

    private bool IsRecentlyUpdated(DateTime updatedAt)
    {
        return DateTime.UtcNow.Subtract(updatedAt).TotalHours < 24;
    }

    private string FormatRelativeTime(DateTime dateTime)
    {
        var timeSpan = DateTime.UtcNow.Subtract(dateTime);
        
        if (timeSpan.TotalMinutes < 1)
            return "เมื่อสักครู่";
        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes} นาทีที่แล้ว";
        if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours} ชั่วโมงที่แล้ว";
        if (timeSpan.TotalDays < 7)
            return $"{(int)timeSpan.TotalDays} วันที่แล้ว";
        
        return dateTime.ToString("MMM dd, yyyy");
    }

    private string FormatRelativeShort(DateTime dateTime)
    {
        var ts = DateTime.UtcNow.Subtract(dateTime);

        if (ts.TotalMinutes < 1)
            return "เมื่อสักครู่";
        if (ts.TotalMinutes < 60)
            return $"{(int)ts.TotalMinutes} นาที";
        if (ts.TotalHours < 24)
            return $"{(int)ts.TotalHours} ชม.";
        if (ts.TotalDays < 7)
            return $"{(int)ts.TotalDays} วัน";

        // Fallback to short date for older entries
        return dateTime.ToString("d/M/yy");
    }

    private async Task ShowEditDialog(PigPen pigPen)
    {
        // Prevent editing if pig pen is closed
        if (IsPigPenClosed(pigPen))
        {
            Snackbar.Add("ไม่สามารถแก้ไขคอกสุกรที่ปิดแล้ว", Severity.Warning);
            return;
        }

        var parameters = new DialogParameters<EditPigPenDialog>
        {
            { x => x.PigPen, pigPen }
        };

        var dialog = await DialogService.ShowAsync<EditPigPenDialog>("แก้ไขคอกสุกร", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadData();
            Snackbar.Add("อัปเดตคอกสุกรสำเร็จ!", Severity.Success);
        }
    }

    private async Task ShowDeleteDialog(PigPen pigPen)
    {
        var parameters = new DialogParameters
        {
            { "ContentText", $"คุณแน่ใจหรือไม่ว่าต้องการลบคอกสุกร '{pigPen.PenCode}'? การดำเนินการนี้ไม่สามารถยกเลิกได้" }
        };

        var dialog = await DialogService.ShowAsync<DeleteConfirmationDialog>("ลบคอกสุกร", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            try
            {
                var success = await PigPenService.DeletePigPenAsync(pigPen.Id);
                if (success)
                {
                    await LoadData();
                    Snackbar.Add("ลบคอกสุกรสำเร็จ!", Severity.Success);
                }
                else
                {
                    Snackbar.Add("ลบคอกสุกรล้มเหลว", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"เกิดข้อผิดพลาดในการลบคอกสุกร: {ex.Message}", Severity.Error);
            }
        }
    }

    private bool IsPigPenClosed(PigPen pigPen)
    {
        if (pigPen == null) return false;
        
        // A pig pen is considered closed only if calculations are locked
        // Having an ActHarvestDate alone doesn't mean it's closed - user may want to force close later
        return pigPen.IsCalculationLocked;
    }
}