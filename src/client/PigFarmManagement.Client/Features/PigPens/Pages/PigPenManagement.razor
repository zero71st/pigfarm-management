@page "/pigpens"
@attribute [Authorize]
@using System.Linq
@using Microsoft.AspNetCore.Authorization
@using PigFarmManagement.Client.Features.PigPens.Components
@inject ICustomerService CustomerService
@inject IPigPenService PigPenService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<PageTitle>PIG PEN MANAGEMENT - Pig Pens</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">จัดการคอกสุกร</MudText>

<!-- Filter and Search Section -->
<MudPaper Class="pa-4 ma-2" Elevation="2">
    <MudGrid>
        <MudItem xs="12" md="4">
                <MudSelect T="Guid?" @bind-Value="SelectedCustomerId" Margin="Margin.Dense" Label="กรองลูกค้า" Variant="Variant.Outlined">
                    <MudSelectItem T="Guid?" Value="@((Guid?)null)">ลูกค้าทั้งหมด</MudSelectItem>
                @foreach (var customer in customers)
                {
                    <MudSelectItem T="Guid?" Value="@((Guid?)customer.Id)">@customer.DisplayName (@customer.Status)</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="4">
                <MudSelect T="PigPenType?" @bind-Value="SelectedPigPenType" Margin="Margin.Dense" Label="กรองประเภท" Variant="Variant.Outlined">
                    <MudSelectItem T="PigPenType?" Value="@((PigPenType?)null)">ทุกประเภท</MudSelectItem>
                    <MudSelectItem T="PigPenType?" Value="PigPenType.Cash">เงินสด</MudSelectItem>
                    <MudSelectItem T="PigPenType?" Value="PigPenType.Project">โครงการ</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="4">
                    <MudTextField @bind-Value="SearchText" Label="ค้นหา" Variant="Variant.Outlined"  Margin="Margin.Dense"
                         Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search" />
        </MudItem>
    </MudGrid>
</MudPaper>

<!-- Pig Pen Management Section -->
<MudPaper Class="pa-4 ma-2" Elevation="2">
    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h6">รายการคอกสุกร</MudText>
        <div class="d-flex gap-2">
            <MudButton Variant="Variant.Outlined" 
                       Color="Color.Info"
                       StartIcon="@Icons.Material.Filled.Refresh"
                       OnClick="RefreshData"
                       Size="Size.Small">
                รีเฟรช
            </MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                       StartIcon="@Icons.Material.Filled.Add" OnClick="ShowAddDialog">
                เพิ่มคอกสุกรใหม่
            </MudButton>
        </div>
    </div>

    <MudTable Items="@filteredPigPens" Hover="true" Striped="true" Loading="@loading">
        <HeaderContent>
            <MudTh>ลูกค้า</MudTh>
            <MudTh>รหัสคอก</MudTh>
            <MudTh>ประเภท</MudTh>
            <MudTh>สถานะ</MudTh>
            <MudTh>จำนวน</MudTh>
            <MudTh>วันที่ลงทะเบียน</MudTh>
            <MudTh>วันจับสุกรโดยประมาณ</MudTh>
            <MudTh>จำนวนวันที่เหลือ</MudTh>
            <MudTh>อัปเดตล่าสุด</MudTh>
            <MudTh>การดำเนินการ</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Customer">@GetCustomerName(context.CustomerId)</MudTd>
            <MudTd DataLabel="Pen Code">@context.PenCode</MudTd>
            <MudTd DataLabel="Type">
                <MudChip Color="@(context.Type == PigPenType.Cash ? Color.Success : Color.Info)" 
                         Size="Size.Small" Variant="Variant.Filled">
                    @context.Type
                </MudChip>
            </MudTd>
            <MudTd DataLabel="Status">
                @if (context.ActHarvestDate.HasValue)
                {
                    <MudChip Color="Color.Error" 
                             Size="Size.Small" 
                             Variant="Variant.Filled"
                             Icon="Icons.Material.Filled.Cancel">
                        ปิดแล้ว
                    </MudChip>
                }
                else if (context.IsCalculationLocked)
                {
                    <MudChip Color="Color.Warning" 
                             Size="Size.Small" 
                             Variant="Variant.Filled"
                             Icon="Icons.Material.Filled.Lock">
                        ล็อกแล้ว
                    </MudChip>
                }
                else
                {
                    <MudChip Color="Color.Success" 
                             Size="Size.Small" 
                             Variant="Variant.Filled"
                             Icon="Icons.Material.Filled.CheckCircle">
                        ใช้งานอยู่
                    </MudChip>
                }
            </MudTd>
            <MudTd DataLabel="Quantity">@context.PigQty</MudTd>
            <MudTd DataLabel="Register Date">@context.RegisterDate.ToString("yyyy-MM-dd")</MudTd>
            <MudTd DataLabel="Est. Harvest">@(context.EstimatedHarvestDate?.ToString("yyyy-MM-dd") ?? "N/A")</MudTd>
            <MudTd DataLabel="Days Remaining">
                @if (context.EstimatedHarvestDate.HasValue)
                {
                    var daysRemaining = (context.EstimatedHarvestDate.Value - DateTime.Now).Days;
                    <MudText Color="@(daysRemaining > 30 ? Color.Success : daysRemaining > 7 ? Color.Warning : Color.Error)">
                        @daysRemaining วัน
                    </MudText>
                }
                else
                {
                    <MudText Color="Color.Secondary">N/A</MudText>
                }
            </MudTd>
            <MudTd DataLabel="Last Updated">
                <MudText Typo="Typo.body2" Color="@(IsRecentlyUpdated(context.UpdatedAt) ? Color.Primary : Color.Secondary)">
                    @FormatRelativeTime(context.UpdatedAt)
                </MudText>
            </MudTd>
            <MudTd DataLabel="Actions">
                <div class="d-flex gap-1">
                    <MudButton Size="Size.Small"
                              Variant="Variant.Text"
                              Color="Color.Info"
                              Class="pa-1"
                              Style="min-width: 32px; font-size: 16px; line-height: 1;"
                            OnClick="() => ShowPosImportDialog(context.Id, GetCustomerName(context.CustomerId), context.PenCode, GetCustomerCode(context.CustomerId))"
                              Title="นำเข้าอาหาร">
                        <MudIcon Icon="@Icons.Material.Filled.Download" Size="Size.Small" />
                    </MudButton>
                    <MudButton Size="Size.Small"
                              Variant="Variant.Text"
                              Color="Color.Primary"
                              Class="pa-1"
                              Style="min-width: 32px; font-size: 16px; line-height: 1;"
                              OnClick="() => NavigateToPigPenDetail(context.Id)"
                              Title="ดูรายละเอียด">
                        <MudIcon Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" />
                    </MudButton>
                    <MudButton Size="Size.Small"
                              Variant="Variant.Text"
                              Color="Color.Warning"
                              Class="pa-1"
                              Style="min-width: 32px; font-size: 16px; line-height: 1;"
                              OnClick="() => ShowEditDialog(context)"
                              Disabled="@IsPigPenClosed(context)"
                              Title="แก้ไข">
                        <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" />
                    </MudButton>
                    <MudButton Size="Size.Small"
                              Variant="Variant.Text"
                              Color="Color.Error"
                              Class="pa-1"
                              Style="min-width: 32px; font-size: 16px; line-height: 1;"
                              OnClick="() => ShowDeleteDialog(context)"
                              Title="ลบ">
                        <MudIcon Icon="@Icons.Material.Filled.Delete" Size="Size.Small" />
                    </MudButton>
                </div>
            </MudTd>
        </RowTemplate>
    </MudTable>
</MudPaper>

@code {
    private List<Customer> customers = new();
    private List<PigPen> pigPens = new();
    private List<PigPen> filteredPigPens = new();
    private bool loading = true;
    private Guid? selectedCustomerId = null;
    private PigPenType? selectedPigPenType = null;
    private string searchText = "";
    private DateTime lastRefreshTime = DateTime.MinValue;

    private Guid? SelectedCustomerId
    {
        get => selectedCustomerId;
        set
        {
            selectedCustomerId = value;
            FilterPigPens();
        }
    }

    private PigPenType? SelectedPigPenType
    {
        get => selectedPigPenType;
        set
        {
            selectedPigPenType = value;
            FilterPigPens();
        }
    }

    private string SearchText
    {
        get => searchText;
        set
        {
            searchText = value;
            FilterPigPens();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
        {
            // Auto-refresh data if it's been more than 30 seconds since last refresh
            // This helps when navigating back from detail pages after operations
            if ((DateTime.Now - lastRefreshTime).TotalSeconds > 30)
            {
                await LoadData();
            }
        }
    }

    private async Task LoadData()
    {
        try
        {
            loading = true;

            var customersTask = CustomerService.GetCustomersAsync();
            var pigPensTask = PigPenService.GetPigPensAsync();

            await Task.WhenAll(customersTask, pigPensTask);

            customers = customersTask.Result;
            pigPens = pigPensTask.Result;

            FilterPigPens();
            lastRefreshTime = DateTime.Now;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"เกิดข้อผิดพลาดในการโหลดข้อมูล: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private async Task RefreshData()
    {
        await LoadData();
        Snackbar.Add("รีเฟรชข้อมูลสำเร็จ", Severity.Info);
    }

    private void FilterPigPens()
    {
        filteredPigPens = pigPens.Where(p =>
            (selectedCustomerId == null || p.CustomerId == selectedCustomerId) &&
            (selectedPigPenType == null || p.Type == selectedPigPenType) &&
            (string.IsNullOrEmpty(searchText) || 
             p.PenCode.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
             GetCustomerName(p.CustomerId).Contains(searchText, StringComparison.OrdinalIgnoreCase))
        ).OrderByDescending(p => p.UpdatedAt).ToList();
    }

    private string GetCustomerName(Guid customerId)
    {
        return customers.FirstOrDefault(c => c.Id == customerId)?.DisplayName ?? "Unknown";
    }

    private async Task ShowAddDialog()
    {
        var dialog = await DialogService.ShowAsync<AddPigPenDialog>("เพิ่มคอกสุกรใหม่");
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadData();
            Snackbar.Add("เพิ่มคอกสุกรสำเร็จ!", Severity.Success);
        }
    }

    private async Task ShowPosImportDialog(Guid pigPenId, string customerName, string penCode, string customerCode)
    {
        var parameters = new DialogParameters
        {
            { "PigPenId", pigPenId },
            { "CustomerDisplayName", customerName },
            { "PenCode", penCode },
            { "CustomerCode", customerCode }
        };

        var dialog = await DialogService.ShowAsync<PigPenPosImportDialog>("นำเข้าข้อมูลอาหารจาก POSPOS", parameters, new DialogOptions 
        { 
            MaxWidth = MaxWidth.Large,
            FullWidth = true 
        });
        
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadData(); // Refresh the list after import
            Snackbar.Add("นำเข้าอาหารจาก POSPOS สำเร็จ!", Severity.Success);
        }
    }

    private string GetCustomerCode(Guid customerId)
    {
        var customer = customers.FirstOrDefault(c => c.Id == customerId);
        return customer?.Code ?? "";
    }

    private void NavigateToPigPenDetail(Guid pigPenId)
    {
        NavigationManager.NavigateTo($"/pigpens/{pigPenId}/detail");
    }

    private bool IsRecentlyUpdated(DateTime updatedAt)
    {
        return DateTime.UtcNow.Subtract(updatedAt).TotalHours < 24;
    }

    private string FormatRelativeTime(DateTime dateTime)
    {
        var timeSpan = DateTime.UtcNow.Subtract(dateTime);
        
        if (timeSpan.TotalMinutes < 1)
            return "เมื่อสักครู่";
        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes} นาทีที่แล้ว";
        if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours} ชั่วโมงที่แล้ว";
        if (timeSpan.TotalDays < 7)
            return $"{(int)timeSpan.TotalDays} วันที่แล้ว";
        
        return dateTime.ToString("MMM dd, yyyy");
    }

    private async Task ShowEditDialog(PigPen pigPen)
    {
        // Prevent editing if pig pen is closed
        if (IsPigPenClosed(pigPen))
        {
            Snackbar.Add("ไม่สามารถแก้ไขคอกสุกรที่ปิดแล้ว", Severity.Warning);
            return;
        }

        var parameters = new DialogParameters<EditPigPenDialog>
        {
            { x => x.PigPen, pigPen }
        };

        var dialog = await DialogService.ShowAsync<EditPigPenDialog>("แก้ไขคอกสุกร", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadData();
            Snackbar.Add("อัปเดตคอกสุกรสำเร็จ!", Severity.Success);
        }
    }

    private async Task ShowDeleteDialog(PigPen pigPen)
    {
        var parameters = new DialogParameters
        {
            { "ContentText", $"คุณแน่ใจหรือไม่ว่าต้องการลบคอกสุกร '{pigPen.PenCode}'? การดำเนินการนี้ไม่สามารถยกเลิกได้" }
        };

        var dialog = await DialogService.ShowAsync<DeleteConfirmationDialog>("ลบคอกสุกร", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            try
            {
                var success = await PigPenService.DeletePigPenAsync(pigPen.Id);
                if (success)
                {
                    await LoadData();
                    Snackbar.Add("ลบคอกสุกรสำเร็จ!", Severity.Success);
                }
                else
                {
                    Snackbar.Add("ลบคอกสุกรล้มเหลว", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"เกิดข้อผิดพลาดในการลบคอกสุกร: {ex.Message}", Severity.Error);
            }
        }
    }

    private bool IsPigPenClosed(PigPen pigPen)
    {
        if (pigPen == null) return false;
        
        // A pig pen is considered closed if:
        // 1. It has an actual harvest date (harvested)
        // 2. Calculations are locked
        return pigPen.ActHarvestDate.HasValue || pigPen.IsCalculationLocked;
    }
}