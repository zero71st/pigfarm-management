@page "/pigpens/{pigPenId:guid}/detail"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject IPigPenService PigPenService
@using PigFarmManagement.Shared.Models
@using PigFarmManagement.Client.Features.FeedFormulas.Services
@using PigFarmManagement.Client.Features.PigPens.Components
@inject IFeedFormulaCalculationService FeedFormulaCalculationService

<PageTitle>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≠‡∏Å‡∏™‡∏∏‡∏Å‡∏£</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-6">
    @if (loading)
    {
        <div class="d-flex justify-center align-center" style="min-height: 400px;">
            <MudProgressCircular Indeterminate="true" Size="Size.Large" />
            <MudText Class="ml-4" Typo="Typo.h6">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≠‡∏Å‡∏™‡∏∏‡∏Å‡∏£...</MudText>
        </div>
    }
    else if (pigPen == null)
    {
        <MudAlert Severity="Severity.Error">
            <MudText Typo="Typo.h6">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏Å‡∏™‡∏∏‡∏Å‡∏£</MudText>
            <MudText>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏Å‡∏™‡∏∏‡∏Å‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</MudText>
        </MudAlert>
    }
    else
    {
        <!-- Header Section -->
        <div class="d-flex justify-space-between align-center mb-6">
            <div>
                <div class="d-flex align-center mb-2">
                    <MudText Typo="Typo.h3" GutterBottom="true" Class="mr-3">
                        <MudIcon Icon="@Icons.Material.Filled.Widgets" Class="mr-3" />
                        @pigPen.Name
                    </MudText>
                    @if (pigPen.IsCalculationLocked)
                    {
                        <MudChip Color="Color.Error" 
                                 Size="Size.Medium" 
                                 Variant="Variant.Filled"
                                 Icon="@Icons.Material.Filled.Lock"
                                 Class="mr-2">
                            ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß
                        </MudChip>
                    }
                    else if (pigPen.ActHarvestDate.HasValue)
                    {
                        <MudChip Color="Color.Info" 
                                 Size="Size.Medium" 
                                 Variant="Variant.Filled"
                                 Icon="@Icons.Material.Filled.CheckCircle"
                                 Class="mr-2">
                            ‡∏à‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß
                        </MudChip>
                    }
                    else
                    {
                        <MudChip Color="Color.Success" 
                                 Size="Size.Medium" 
                                 Variant="Variant.Filled"
                                 Icon="@Icons.Material.Filled.CheckCircle">
                            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á
                        </MudChip>
                    }
                </div>
                <MudBreadcrumbs Items="@breadcrumbItems" />
            </div>
            <div>
                <MudButton Variant="Variant.Outlined" 
                           StartIcon="@Icons.Material.Filled.ArrowBack"
                           OnClick="@(() => Navigation.NavigateTo("/pigpens"))"
                           Class="mr-2">
                    ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                </MudButton>
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Edit"
                           OnClick="EditPigPen"
                           Disabled="@IsPigPenClosed()">
                    ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                </MudButton>
                @* Force Close button - Show for all pig pens with smart behavior *@
                @if (ShouldShowForceCloseButton())
                {
                    <MudButton Variant="Variant.Filled" 
                               Color="@GetForceCloseButtonColor()"
                               StartIcon="@GetForceCloseButtonIcon()"
                               OnClick="ForceClosePigPen"
                               Class="ml-2">
                        @GetForceCloseButtonText()
                    </MudButton>
                }
                @* Remove debug info in production *@
            </div>
        </div>

        <!-- Section 1: Pig Pen Details -->
        <MudCard Elevation="2" Class="mb-6">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h5">
                        <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" />
                        ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≠‡∏Å‡∏™‡∏∏‡∏Å‡∏£
                    </MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudSimpleTable Style="overflow-x: auto;" Dense="true">
                            <tbody>
                                <tr>
                                    <td><strong>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong></td>
                                    <td>@(customer?.DisplayName ?? "Unknown Customer")</td>
                                </tr>
                                <tr>
                                    <td><strong>‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏≠‡∏Å:</strong></td>
                                    <td>@pigPen.PenCode</td>
                                </tr>
                                <tr>
                                    <td><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong></td>
                                    <td>
                                        <MudChip Color="@(pigPen.Type == PigPenType.Cash ? Color.Success : Color.Info)" 
                                                 Size="Size.Small" Variant="Variant.Filled">
                                            @(pigPen.Type == PigPenType.Cash ? "‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î" : "‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£")
                                        </MudChip>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</strong></td>
                                    <td>@pigPen.PigQty ‡∏ï‡∏±‡∏ß</td>
                                </tr>
                                <tr>
                                    <td><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô:</strong></td>
                                    <td>@pigPen.RegisterDate.ToString("dd/MM/yyyy")</td>
                                </tr>
                                <tr>
                                    <td><strong>‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ö‡∏™‡∏∏‡∏Å‡∏£‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì:</strong></td>
                                    <td>@(pigPen.EstimatedHarvestDate?.ToString("dd/MM/yyyy") ?? "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á")</td>
                                </tr>
                                <tr>
                                    <td><strong>‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ö‡∏™‡∏∏‡∏Å‡∏£‡∏à‡∏£‡∏¥‡∏á:</strong></td>
                                    <td>@(pigPen.ActHarvestDate?.ToString("dd/MM/yyyy") ?? "‡∏¢‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£")</td>
                                </tr>
                                <tr>
                                    <td><strong>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏à‡∏£‡∏¥‡∏á:</strong></td>
                                    <td>
                                        @if (pigPen.ActHarvestDate.HasValue)
                                        {
                                            var actualDays = (pigPen.ActHarvestDate.Value - pigPen.RegisterDate).Days;
                                            <MudChip Color="Color.Primary" Size="Size.Small" Variant="Variant.Filled">
                                                <strong>@actualDays ‡∏ß‡∏±‡∏ô</strong>
                                            </MudChip>
                                        }
                                        else
                                        {
                                            var daysInProgress = (DateTime.Today - pigPen.RegisterDate).Days;
                                            <MudChip Color="Color.Info" Size="Size.Small" Variant="Variant.Outlined">
                                                @daysInProgress ‡∏ß‡∏±‡∏ô (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á)
                                            </MudChip>
                                        }
                                    </td>
                                </tr>
                                @if (!string.IsNullOrWhiteSpace(pigPen.Note))
                                {
                                    <tr>
                                        <td><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong></td>
                                        <td style="max-width: 300px; word-wrap: break-word;">@pigPen.Note</td>
                                    </tr>
                                }
                            </tbody>
                        </MudSimpleTable>
                    </MudItem>
                    <MudItem xs="12" md="6">
                        @if (summary != null)
                        {
                            <MudSimpleTable Style="overflow-x: auto;" Dense="true">
                                <tbody>
                                    <tr>
                                        <td><strong>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£:</strong></td>
                                        <td class="text-right">
                                            <MudText Color="Color.Primary">‡∏ø@summary.TotalFeedCost.ToString("N0")</MudText>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏£‡∏ß‡∏°:</strong></td>
                                        <td class="text-right">
                                            @if (pigPen?.Type == PigPenType.Project)
                                            {
                                                @if (depositCalculationInfo != null)
                                                {
                                                    <div>
                                                        <MudText Color="@GetDepositStatusColor()">
                                                            <strong>@depositCalculationInfo.CurrentTotalDepositsFormatted</strong>
                                                        </MudText>
                                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                            of @depositCalculationInfo.ExpectedTotalDepositFormatted expected
                                                        </MudText>
                                                        <br />
                                                        <MudChip Size="Size.Small" Color="@GetStatusChipColor()" Variant="Variant.Filled">
                                                            @depositCalculationInfo.CompletionPercentageFormatted
                                                        </MudChip>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <MudText Color="Color.Secondary">‡∏ø@summary.TotalDeposit.ToString("N0")</MudText>
                                                }
                                            }
                                            else
                                            {
                                                <MudText Color="Color.Secondary" Style="font-style: italic;">
                                                    N/A (Cash Type)
                                                </MudText>
                                            }
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô:</strong></td>
                                        <td class="text-right">
                                            <MudText Color="Color.Info">‡∏ø@summary.Investment.ToString("N0")</MudText>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô:</strong></td>
                                        <td class="text-right">
                                            <MudText Color="@(summary.ProfitLoss >= 0 ? Color.Success : Color.Error)">
                                                ‡∏ø@summary.ProfitLoss.ToString("N0")
                                            </MudText>
                                        </td>
                                    </tr>
                                </tbody>
                            </MudSimpleTable>
                        }
                    </MudItem>
                </MudGrid>
            </MudCardContent>
        </MudCard>

        <!-- Section 2: Feed History with Invoice Management Tabs -->
        <MudCard Elevation="2" Class="mb-6">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h5">
                        <MudIcon Icon="@Icons.Material.Filled.Fastfood" Class="mr-2" />
                        ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏•‡∏Ç‡∏≤‡∏¢ (@feeds.GroupBy(f => f.InvoiceReferenceCode).Count())
                    </MudText>
                    @if (pigPen?.IsCalculationLocked == true)
                    {
                        <MudChip Color="Color.Warning" 
                                 Size="Size.Small" 
                                 Variant="Variant.Filled" 
                                 Class="ml-3"
                                 Icon="@Icons.Material.Filled.Lock">
                            ‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
                        </MudChip>
                    }
                </CardHeaderContent>
                <CardHeaderActions>
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Download"
                               OnClick="ImportFeeds">
                        ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏¥‡∏•‡∏Ç‡∏≤‡∏¢
                    </MudButton>
                </CardHeaderActions>
            </MudCardHeader>
            <MudCardContent>
                <MudTabs Elevation="0" 
                         Rounded="true" 
                         ApplyEffectsToContainer="true"
                         PanelClass="pa-4"
                         ActivePanelIndex="_activeTabIndex"
                         ActivePanelIndexChanged="OnTabChanged">
                    <MudTabPanel Text="‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏•‡∏Ç‡∏≤‡∏¢" Icon="@Icons.Material.Filled.Receipt">
                        <InvoiceListTab PigPenId="@PigPenId" 
                                       Feeds="@feeds" 
                                       OnInvoiceDeleted="HandleInvoiceDeleted" />
                    </MudTabPanel>
                    <MudTabPanel Text="‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£" Icon="@Icons.Material.Filled.Fastfood">
                        <FeedHistoryTab PigPenId="@PigPenId"
                                       Feeds="@feeds" 
                                       FeedFormulaCalculations="@feedFormulaCalculations"
                                       ComparisonData="@comparisonData"
                                       ShowFinancial="@_showFinancial"
                                       ShowSpecificProducts="@_showSpecificProducts"
                                       OnFeedsChanged="HandleFeedsChanged" />
                    </MudTabPanel>
                </MudTabs>
            </MudCardContent>
        </MudCard>

        <!-- Section 3: Deposits List (Project Type Only) -->
        @if (pigPen?.Type == PigPenType.Project)
        {
            <MudCard Elevation="2" Class="mb-6">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h5">
                            <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Class="mr-2" />
                            ‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ (@deposits.Count)
                        </MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudButton Variant="Variant.Filled" 
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Add"
                                   OnClick="AddDeposit">
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
                        </MudButton>
                    </CardHeaderActions>
                </MudCardHeader>
            <MudCardContent>
                <!-- Deposit Progress Card -->
                @if (pigPen != null && depositCalculationInfo != null)
                {
                    <MudCard Class="mb-4" Style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
                        <MudCardContent>
                            <MudGrid>
                                <MudItem xs="12" sm="8">
                                    <MudText Typo="Typo.subtitle1" Class="mb-2">
                                        üí∞ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
                                    </MudText>
                                    <MudProgressLinear Value="@((double)(depositCalculationInfo.CompletionPercentage * 100))" 
                                                     Color="@GetProgressColor()" 
                                                     Size="Size.Large" 
                                                     Class="mb-2" />
                                    <MudText Typo="Typo.body2" Class="mb-1">
                                        <strong>@depositCalculationInfo.CurrentTotalDepositsFormatted</strong> of <strong>@depositCalculationInfo.ExpectedTotalDepositFormatted</strong> collected
                                    </MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        Based on @depositCalculationInfo.PigQuantity pigs √ó @depositCalculationInfo.DepositPerPigFormatted per pig
                                    </MudText>
                                </MudItem>
                                <MudItem xs="12" sm="4" Class="d-flex flex-column justify-center">
                                    <MudChip Color="@GetStatusChipColor()" Size="Size.Large" Class="ma-1">
                                        @GetStatusText()
                                    </MudChip>
                                    @if (depositCalculationInfo.RemainingDeposit > 0)
                                    {
                                        <MudText Typo="Typo.body2" Class="text-center mt-2">
                                            <strong>@depositCalculationInfo.RemainingDepositFormatted</strong> ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
                                        </MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2" Class="text-center mt-2" Style="color: #4caf50;">
                                            ‚úÖ ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!
                                        </MudText>
                                    }
                                </MudItem>
                            </MudGrid>
                        </MudCardContent>
                    </MudCard>
                }
                
                @if (deposits.Any())
                {
                    <MudTable Items="@deposits" Hover="true" Striped="true" Dense="true">
                        <HeaderContent>
                            <MudTh>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</MudTh>
                            <MudTh Style="text-align: right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</MudTh>
                            <MudTh>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</MudTh>
                            <MudTh Style="text-align: center">‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Date">@context.Date.ToString("dd/MM/yyyy")</MudTd>
                            <MudTd DataLabel="Amount" Style="text-align: right">
                                <MudText Color="Color.Success"><strong>‡∏ø@context.Amount.ToString("N2")</strong></MudText>
                            </MudTd>
                            <MudTd DataLabel="Notes">@(context.Remark ?? "-")</MudTd>
                            <MudTd DataLabel="Actions" Style="text-align: center">
                                <MudButtonGroup Size="Size.Small" Variant="Variant.Outlined">
                                    <MudButton Color="Color.Primary" 
                                             Size="Size.Small"
                                             Variant="Variant.Outlined"
                                             Title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥"
                                             OnClick="@(() => EditDeposit(context))">
                                        ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                    </MudButton>
                                    <MudButton Color="Color.Error" 
                                             Size="Size.Small"
                                             Variant="Variant.Outlined"
                                             Title="‡∏•‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥"
                                             OnClick="@(() => DeleteDeposit(context))">
                                        üóëÔ∏è ‡∏•‡∏ö
                                    </MudButton>
                                </MudButtonGroup>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }
                else
                {
                    <MudAlert Severity="Severity.Info">
                        <MudText>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏Å‡∏™‡∏∏‡∏Å‡∏£‡∏ô‡∏µ‡πâ</MudText>
                    </MudAlert>
                }
            </MudCardContent>
        </MudCard>
        }
        @if (pigPen?.Type == PigPenType.Cash)
        {
            <!-- Information Card for Cash Type Pig Pens -->
            <MudCard Elevation="2" Class="mb-6">
                <MudCardContent>
                    <MudAlert Severity="Severity.Info" Dense="true">
                        <MudText Typo="Typo.subtitle2" Class="mb-2">
                            <MudIcon Icon="Icons.Material.Filled.Info" Class="mr-2" />
                            ‡∏Ñ‡∏≠‡∏Å‡∏™‡∏∏‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
                        </MudText>
                        <MudText Typo="Typo.body2">
                            ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏Å‡∏™‡∏∏‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î ‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                        </MudText>
                    </MudAlert>
                </MudCardContent>
            </MudCard>
        }

        <!-- Section 4: Harvest List -->
        <MudCard Elevation="2" Class="mb-6">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h5">
                        <MudIcon Icon="@Icons.Material.Filled.Agriculture" Class="mr-2" />
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏™‡∏∏‡∏Å‡∏£ (@harvests.Count)
                    </MudText>
                </CardHeaderContent>
                <CardHeaderActions>
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Add"
                               OnClick="AddHarvest">
                        ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏™‡∏∏‡∏Å‡∏£
                    </MudButton>
                </CardHeaderActions>
            </MudCardHeader>
            <MudCardContent>
                
                <!-- Harvest Progress Card -->
                @if (pigPen != null && harvestCalculationInfo != null)
                {
                    <MudCard Elevation="1" Class="mb-4" Style="background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%);">
                        <MudCardContent Class="pa-4">
                            <MudGrid AlignItems="Center.Center" Spacing="2">
                                <MudItem xs="12" sm="6" md="3">
                                    <MudText Typo="Typo.subtitle2" Class="mb-1">üê∑ Harvest Progress</MudText>
                                    <MudProgressLinear Value="@((double)(harvestCalculationInfo.CompletionPercentage * 100))" 
                                                     Color="@GetHarvestProgressColor()" 
                                                     Size="Size.Medium" 
                                                     Class="mb-2" />
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                                        <strong>@harvestCalculationInfo.HarvestedPigQuantity</strong> of <strong>@harvestCalculationInfo.TotalPigQuantity</strong> pigs sold
                                    </MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        @harvestCalculationInfo.CompletionPercentageFormatted complete
                                    </MudText>
                                </MudItem>
                                
                                <MudItem xs="12" sm="6" md="3">
                                    <MudText Typo="Typo.body2" Class="text-muted">Remaining Pigs:</MudText>
                                    @if (harvestCalculationInfo.RemainingPigQuantity > 0)
                                    {
                                        <MudText Typo="Typo.h6" Color="@GetHarvestStatusColor()">
                                            <strong>@harvestCalculationInfo.RemainingPigQuantity</strong> pigs left
                                        </MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.h6" Style="color: #4caf50;">
                                            ‚úÖ All pigs harvested
                                        </MudText>
                                    }
                                </MudItem>
                                
                                <MudItem xs="12" sm="6" md="3">
                                    <MudText Typo="Typo.body2" Class="text-muted">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°:</MudText>
                                    <MudText Typo="Typo.h6" Color="Color.Success">
                                        @harvestCalculationInfo.TotalRevenueFormatted
                                    </MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        @harvests.Count ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                                    </MudText>
                                </MudItem>
                                
                                <MudItem xs="12" sm="6" md="3">
                                    <MudText Typo="Typo.body2" Class="text-muted">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏Å‡∏Å.:</MudText>
                                    <MudText Typo="Typo.h6" Color="Color.Info">
                                        @harvestCalculationInfo.AveragePricePerKgFormatted
                                    </MudText>
                                    <MudChip Size="Size.Small" Color="@GetHarvestStatusChipColor()" Variant="Variant.Filled">
                                        @harvestCalculationInfo.Status
                                    </MudChip>
                                </MudItem>
                            </MudGrid>
                        </MudCardContent>
                    </MudCard>
                }
                
                @if (harvests.Any())
                {
                    <MudTable Items="@harvests" Hover="true" Striped="true" Dense="true">
                        <HeaderContent>
                            <MudTh>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</MudTh>
                            <MudTh Style="text-align: center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏∏‡∏Å‡∏£‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢</MudTh>
                            <MudTh Style="text-align: right">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏Å‡∏Å.)</MudTh>
                            <MudTh Style="text-align: right">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠ ‡∏Å‡∏Å.</MudTh>
                            <MudTh Style="text-align: right">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</MudTh>
                            <MudTh Style="text-align: center">‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Date">@context.HarvestDate.ToString("dd/MM/yyyy")</MudTd>
                            <MudTd DataLabel="Pigs Sold" Style="text-align: center">
                                <MudChip Size="Size.Small" Color="Color.Info">@context.PigCount</MudChip>
                            </MudTd>
                            <MudTd DataLabel="Avg Weight" Style="text-align: right">@context.AvgWeight.ToString("N1")</MudTd>
                            <MudTd DataLabel="Price per Kg" Style="text-align: right">‡∏ø@context.SalePricePerKg.ToString("N2")</MudTd>
                            <MudTd DataLabel="Total Revenue" Style="text-align: right">
                                <MudText Color="Color.Success"><strong>‡∏ø@context.Revenue.ToString("N2")</strong></MudText>
                            </MudTd>
                            <MudTd DataLabel="Actions" Style="text-align: center">
                                <MudButtonGroup Size="Size.Small" Variant="Variant.Outlined">
                                    <MudButton Color="Color.Primary" 
                                             Size="Size.Small"
                                             Variant="Variant.Outlined"
                                             Title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏™‡∏∏‡∏Å‡∏£"
                                             OnClick="@(() => EditHarvest(context))">
                                        ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                    </MudButton>
                                    <MudButton Color="Color.Error" 
                                             Size="Size.Small"
                                             Variant="Variant.Outlined"
                                             Title="‡∏•‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏™‡∏∏‡∏Å‡∏£"
                                             OnClick="@(() => DeleteHarvest(context))">
                                        üóëÔ∏è ‡∏•‡∏ö
                                    </MudButton>
                                </MudButtonGroup>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }
                else
                {
                    <MudAlert Severity="Severity.Info">
                        <MudText>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏™‡∏∏‡∏Å‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏Å‡∏™‡∏∏‡∏Å‡∏£‡∏ô‡∏µ‡πâ</MudText>
                    </MudAlert>
                }
            </MudCardContent>
        </MudCard>
    }
</MudContainer>

@code {
    [Parameter] public Guid PigPenId { get; set; }

    private bool loading = true;
    private PigPen? pigPen;
    private Customer? customer;
    private PigPenSummary? summary;
    private List<FeedItem> feeds = new();
    private List<GroupedFeedItem> groupedFeeds = new();
    private List<Deposit> deposits = new();
    private List<HarvestResult> harvests = new();
    
    // Product visibility control
    private bool _showFinancial = false;
    private bool _showSpecificProducts = false; // Default to true to show these products
    
    // Deposit calculation information
    private DepositCalculationInfo? depositCalculationInfo;
    
    // Harvest calculation information
    private HarvestCalculationInfo? harvestCalculationInfo;
    
    // Feed formula comparison data
    private IEnumerable<FeedFormulaWithCalculationDto>? feedFormulaCalculations;
    private List<FeedComparisonData> comparisonData = new();
    
    // Feed progress data
    private FeedProgressSummary? feedProgressSummary;

    // Tab management
    private int _activeTabIndex = 0;

    private List<BreadcrumbItem> breadcrumbItems = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        SetupBreadcrumbs();
    }

    private async Task OnTabChanged(int newIndex)
    {
        _activeTabIndex = newIndex;
        // Reload feeds when switching tabs to ensure both tabs have fresh data
        await RefreshFeeds();
    }

    private async Task HandleInvoiceDeleted()
    {
        // Reload feeds after invoice deletion
        await RefreshFeeds();
    }

    private async Task HandleFeedsChanged()
    {
        // Reload feeds after feed changes (e.g., deletion from FeedHistoryTab)
        await RefreshFeeds();
    }

    private async Task LoadData()
    {
        loading = true;
        try
        {
            // Load pig pen details
            var pigPens = await Http.GetFromJsonAsync<List<PigPen>>("/api/pigpens") ?? new();
            pigPen = pigPens.FirstOrDefault(p => p.Id == PigPenId);

            if (pigPen != null)
            {
                // Load customer information
                var customers = await Http.GetFromJsonAsync<List<Customer>>("/api/customers") ?? new();
                customer = customers.FirstOrDefault(c => c.Id == pigPen.CustomerId);

                // Load summary
                summary = await Http.GetFromJsonAsync<PigPenSummary>($"/api/pigpens/{PigPenId}/summary");

                // Load feeds and group by product code
                var allFeeds = await Http.GetFromJsonAsync<List<FeedItem>>($"/api/pigpens/{PigPenId}/feeds") ?? new();
                feeds = allFeeds.OrderByDescending(f => f.Date).ThenBy(f => f.ProductCode).ToList();
                
                // Group feeds by product code
                groupedFeeds = feeds
                    .Where(f => !string.IsNullOrEmpty(f.ProductCode))
                    .GroupBy(f => f.ProductCode)
                    .Select(g => new GroupedFeedItem
                    {
                        ProductCode = g.Key,
                        ProductName = g.First().ProductName ?? g.Key,
                        TotalQuantity = g.Sum(f => f.QuantityKg),
                        FeedCount = g.Count()
                    })
                    .OrderBy(g => g.ProductCode)
                    .ToList();

                // Load deposits (only for Project type pig pens)
                if (pigPen?.Type == PigPenType.Project)
                {
                    deposits = await Http.GetFromJsonAsync<List<Deposit>>($"/api/pigpens/{PigPenId}/deposits") ?? new();
                    
                    // Calculate deposit information
                    depositCalculationInfo = DepositCalculationInfo.Create(pigPen, deposits);
                }
                else
                {
                    deposits = new();
                    depositCalculationInfo = null;
                }

                // Load harvests
                harvests = await Http.GetFromJsonAsync<List<HarvestResult>>($"/api/pigpens/{PigPenId}/harvests") ?? new();

                // Calculate harvest information
                if (pigPen != null)
                {
                    harvestCalculationInfo = HarvestCalculationInfo.Create(pigPen, harvests);
                }

                // Load feed progress summary
                try
                {
                    feedProgressSummary = await Http.GetFromJsonAsync<FeedProgressSummary>($"/api/pigpens/{PigPenId}/feed-progress/summary");
                    Console.WriteLine($"Loaded feed progress: {feedProgressSummary?.Progress?.Status ?? "No data"}");
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error loading feed progress: {ex.Message}");
                    Snackbar.Add($"Error loading feed progress: {ex.Message}", Severity.Warning);
                }

                // Load feed formula calculations - use actual formula assignments for comparison
                if (pigPen != null)
                {
                    try
                    {
                        // Get formula assignments for this pig pen from the API
                        var assignments = await PigPenService.GetFormulaAssignmentsAsync(pigPen.Id);
                        Console.WriteLine($"[LoadData] Loaded {assignments?.Count ?? 0} formula assignments from API");

                        if (assignments?.Any() == true)
                        {
                            Console.WriteLine($"[LoadData] Assignment details:");
                            foreach (var assignment in assignments)
                            {
                                Console.WriteLine($"  - {assignment.ProductCode}: {assignment.ProductName}, Active={assignment.IsActive}, Locked={assignment.IsLocked}");
                            }
                        }

                        // Get active formula assignments for this pig pen
                        var activeAssignments = (assignments ?? new List<PigPenFormulaAssignment>())
                            .Where(fa => fa.IsActive && !fa.IsLocked)
                            .ToList();

                        if (activeAssignments.Any())
                        {
                            // Use active assignment data for comparison with actual consumption
                            Console.WriteLine($"Using {activeAssignments.Count} active formula assignments for feed comparison");
                            feedFormulaCalculations = activeAssignments.Select(assignment => new FeedFormulaWithCalculationDto
                            {
                                Id = assignment.OriginalFormulaId,
                                ProductCode = assignment.ProductCode,
                                ProductName = assignment.ProductName,
                                Brand = assignment.Brand,
                                BagPerPig = assignment.AssignedBagPerPig,
                                TotalBagsRequired = assignment.AssignedTotalBags,
                                PigCount = assignment.AssignedPigQuantity,
                                CreatedAt = assignment.AssignedAt,
                                UpdatedAt = assignment.AssignedAt,
                                DisplayName = $"{assignment.ProductCode} - {assignment.ProductName}",
                                ConsumptionRate = $"{assignment.AssignedBagPerPig:F1} bags/pig",
                                BrandDisplayName = $"{assignment.Brand} - {assignment.ProductName}"
                            }).ToList();
                        }
                        else if (pigPen.IsCalculationLocked)
                        {
                            // Fallback to locked assignments for locked pig pens
                            var lockedAssignments = (assignments ?? new List<PigPenFormulaAssignment>())
                                .Where(fa => fa.IsLocked)
                                .ToList();

                            if (lockedAssignments.Any())
                            {
                                Console.WriteLine($"Using {lockedAssignments.Count} locked formula assignments for locked pig pen");
                                feedFormulaCalculations = lockedAssignments.Select(assignment => new FeedFormulaWithCalculationDto
                                {
                                    Id = assignment.OriginalFormulaId,
                                    ProductCode = assignment.ProductCode,
                                    ProductName = assignment.ProductName,
                                    Brand = assignment.Brand,
                                    BagPerPig = assignment.AssignedBagPerPig,
                                    TotalBagsRequired = assignment.AssignedTotalBags,
                                    PigCount = assignment.AssignedPigQuantity,
                                    CreatedAt = assignment.AssignedAt,
                                    UpdatedAt = assignment.AssignedAt,
                                    DisplayName = $"{assignment.ProductCode} - {assignment.ProductName}",
                                    ConsumptionRate = $"{assignment.AssignedBagPerPig:F1} bags/pig",
                                    BrandDisplayName = $"{assignment.Brand} - {assignment.ProductName}"
                                }).ToList();
                            }
                            else
                            {
                                Console.WriteLine("No assignments available for locked pig pen");
                                feedFormulaCalculations = new List<FeedFormulaWithCalculationDto>();
                            }
                        }
                        else
                        {
                            Console.WriteLine("No active formula assignments found for pig pen");
                            feedFormulaCalculations = new List<FeedFormulaWithCalculationDto>();
                        }
                        
                        Console.WriteLine($"Loaded {feedFormulaCalculations?.Count() ?? 0} feed formula assignments for comparison");
                        
                        // Build comparison data
                        BuildComparisonData();
                        Console.WriteLine($"Built comparison data: {comparisonData?.Count ?? 0} items");
                    }
                    catch (Exception feedEx)
                    {
                        Console.WriteLine($"Error loading feed formula assignments: {feedEx.Message}");
                        Snackbar.Add($"Error loading feed formula assignments: {feedEx.Message}", Severity.Warning);
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading data: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private void SetupBreadcrumbs()
    {
        breadcrumbItems = new List<BreadcrumbItem>
        {
            new BreadcrumbItem("Home", href: "/"),
            new BreadcrumbItem("Pig Pens", href: "/pigpens"),
            new BreadcrumbItem(pigPen?.PenCode ?? "Detail", href: null, disabled: true)
        };
    }

    private async Task LoadDeposits()
    {
        if (pigPen == null) return;
        
        try
        {
            deposits = await Http.GetFromJsonAsync<List<Deposit>>($"/api/pigpens/{PigPenId}/deposits") ?? new();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading deposits: {ex.Message}", Severity.Error);
        }
    }

    private async Task EditPigPen()
    {
        Console.WriteLine("[EditPigPen] Method called");
        
        if (pigPen == null) 
        {
            Console.WriteLine("[EditPigPen] pigPen is null, returning");
            Snackbar.Add("No pig pen data available", Severity.Error);
            return;
        }

        // Prevent editing if pig pen is closed
        if (IsPigPenClosed())
        {
            Console.WriteLine("[EditPigPen] Pig pen is closed, preventing edit");
            Snackbar.Add("Cannot edit a closed pig pen", Severity.Warning);
            return;
        }

        Console.WriteLine($"[EditPigPen] About to open dialog for pig pen: {pigPen.PenCode}");

        try
        {
            var parameters = new DialogParameters<EditPigPenDialog>
            {
                { x => x.PigPen, pigPen }
            };

            Console.WriteLine("[EditPigPen] Parameters created, showing dialog");
            var dialog = await DialogService.ShowAsync<EditPigPenDialog>("Edit Pig Pen", parameters);
            Console.WriteLine("[EditPigPen] Dialog shown, waiting for result");
            
            var result = await dialog.Result;
            Console.WriteLine($"[EditPigPen] Dialog result: Canceled={result.Canceled}");

            if (!result.Canceled && result.Data is PigPen updatedPigPen)
            {
                Console.WriteLine("[EditPigPen] Dialog result successful, updating data");
                // Update the local pig pen data
                pigPen = updatedPigPen;
                
                // Refresh the page data to show updates
                await LoadData();
                
                Snackbar.Add("Pig pen updated successfully", Severity.Success);
            }
            else
            {
                Console.WriteLine("[EditPigPen] Dialog was canceled or no data returned");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[EditPigPen] Error: {ex.Message}");
            Snackbar.Add($"Error opening edit dialog: {ex.Message}", Severity.Error);
        }
    }

    private async Task ForceClosePigPen()
    {
        if (pigPen == null)
        {
            Snackbar.Add("Pig pen data not available", Severity.Error);
            return;
        }

        if (pigPen.ActHarvestDate.HasValue)
        {
            Snackbar.Add("Pig pen is already closed", Severity.Warning);
            return;
        }

        var parameters = new DialogParameters
        {
            { "PigPen", pigPen },
            { "HarvestInfo", harvestCalculationInfo }
        };

        var options = new DialogOptions() 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<ForceClosePigPenDialog>("Force Close Pig Pen", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is bool confirmed && confirmed)
        {
            try
            {
                var request = new PigPenForceCloseRequest(pigPen.Id, "Force closed by user", true);
                var closedPigPen = await PigPenService.ForceClosePigPenAsync(request);
                
                if (closedPigPen != null)
                {
                    // Update the local pig pen data
                    pigPen = closedPigPen;
                    
                    // Refresh the page data to show updates
                    await LoadData();
                    
                    Snackbar.Add("Pig pen has been force closed successfully", Severity.Success);
                }
                else
                {
                    Snackbar.Add("Failed to force close pig pen", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error force closing pig pen: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task AddDeposit()
    {
        if (pigPen == null || pigPen.Type != PigPenType.Project) 
        {
            Snackbar.Add("Deposits are only available for Project type pig pens", Severity.Warning);
            return;
        }

        var parameters = new DialogParameters<AddDepositDialog>
        {
            { x => x.PigPenId, pigPen.Id },
            { x => x.PigPen, pigPen },
            { x => x.CurrentDeposits, deposits ?? new List<Deposit>() }
        };

        var options = new DialogOptions() 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<AddDepositDialog>("Add Deposit", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            // Refresh deposits list
            await RefreshDeposits();
            
            // Refresh summary to update total deposits
            if (summary != null)
            {
                summary = await Http.GetFromJsonAsync<PigPenSummary>($"/api/pigpens/{PigPenId}/summary");
                StateHasChanged();
            }
        }
    }

    private async Task EditDeposit(Deposit deposit)
    {
        if (pigPen?.Type != PigPenType.Project) 
        {
            Snackbar.Add("Deposits are only available for Project type pig pens", Severity.Warning);
            return;
        }
        
        var parameters = new DialogParameters<EditDepositDialog>
        {
            { x => x.DepositToEdit, deposit },
            { x => x.PigPen, pigPen },
            { x => x.CurrentDeposits, deposits ?? new List<Deposit>() }
        };

        var options = new DialogOptions() 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<EditDepositDialog>("Edit Deposit", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            // Refresh deposits list
            await RefreshDeposits();
            
            // Refresh summary to update total deposits
            if (summary != null)
            {
                summary = await Http.GetFromJsonAsync<PigPenSummary>($"/api/pigpens/{PigPenId}/summary");
                StateHasChanged();
            }
        }
    }

    private async Task DeleteDeposit(Deposit deposit)
    {
        if (pigPen?.Type != PigPenType.Project) 
        {
            Snackbar.Add("Deposits are only available for Project type pig pens", Severity.Warning);
            return;
        }
        
        var parameters = new DialogParameters<DeleteDepositConfirmationDialog>
        {
            { x => x.DepositToDelete, deposit }
        };

        var options = new DialogOptions() 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<DeleteDepositConfirmationDialog>("Confirm Delete", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is bool confirmed && confirmed)
        {
            try
            {
                var success = await PigPenService.DeleteDepositAsync(deposit.PigPenId, deposit.Id);
                
                if (success)
                {
                    Snackbar.Add($"Deposit of ‡∏ø{deposit.Amount:N2} deleted successfully", Severity.Success);
                    
                    // Refresh deposits list
                    await RefreshDeposits();
                    
                    // Refresh summary to update total deposits
                    if (summary != null)
                    {
                        summary = await Http.GetFromJsonAsync<PigPenSummary>($"/api/pigpens/{PigPenId}/summary");
                        StateHasChanged();
                    }
                }
                else
                {
                    Snackbar.Add("Failed to delete deposit", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting deposit: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task ImportFeeds()
    {
        if (pigPen == null) return;

        // Find customer information from the loaded customers list or make API call
        var customersResponse = await Http.GetFromJsonAsync<List<Customer>>("/api/customers") ?? new();
        var customer = customersResponse.FirstOrDefault(c => c.Id == pigPen.CustomerId);

        var parameters = new DialogParameters<PigPenPosImportDialog>
        {
            { x => x.PigPenId, pigPen.Id },
            { x => x.CustomerDisplayName, customer?.DisplayName ?? "Unknown Customer" },
            { x => x.PenCode, pigPen.PenCode },
            { x => x.CustomerCode, customer?.Code ?? "" }
        };

        var options = new DialogOptions() 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.Large,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<PigPenPosImportDialog>("Import POSPOS Feed Data", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is FeedImportResult importResult)
        {
            // Refresh feeds list after successful import
            await RefreshFeeds();
            
            Snackbar.Add($"Successfully imported {importResult.SuccessfulImports} feed transaction(s)", Severity.Success);
        }
    }

    private async Task AddHarvest()
    {
        if (pigPen == null) return;

        var parameters = new DialogParameters<AddHarvestDialog>
        {
            { x => x.PigPenId, pigPen.Id },
            { x => x.PigPen, pigPen },
            { x => x.ExistingHarvests, harvests ?? new List<HarvestResult>() }
        };

        var options = new DialogOptions() 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<AddHarvestDialog>("Add Harvest Record", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is HarvestResult newHarvest)
        {
            // Refresh harvests list
            await RefreshHarvests();
            
            // Refresh summary to update calculations
            if (summary != null)
            {
                summary = await Http.GetFromJsonAsync<PigPenSummary>($"/api/pigpens/{PigPenId}/summary");
                StateHasChanged();
            }
        }
    }

    private async Task EditHarvest(HarvestResult harvest)
    {
        if (pigPen == null) return;

        var parameters = new DialogParameters<EditHarvestDialog>
        {
            { x => x.HarvestToEdit, harvest },
            { x => x.PigPen, pigPen },
            { x => x.ExistingHarvests, harvests ?? new List<HarvestResult>() }
        };

        var options = new DialogOptions() 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<EditHarvestDialog>("Edit Harvest Record", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is HarvestResult updatedHarvest)
        {
            // Refresh harvests list
            await RefreshHarvests();
            
            // Refresh summary to update calculations
            if (summary != null)
            {
                summary = await Http.GetFromJsonAsync<PigPenSummary>($"/api/pigpens/{PigPenId}/summary");
                StateHasChanged();
            }
        }
    }

    private async Task DeleteHarvest(HarvestResult harvest)
    {
        var parameters = new DialogParameters<DeleteHarvestConfirmationDialog>
        {
            { x => x.HarvestToDelete, harvest }
        };

        var options = new DialogOptions() 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<DeleteHarvestConfirmationDialog>("Confirm Delete", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is bool confirmed && confirmed)
        {
            try
            {
                var success = await PigPenService.DeleteHarvestResultAsync(harvest.PigPenId, harvest.Id);
                
                if (success)
                {
                    Snackbar.Add($"Harvest record (‡∏ø{harvest.Revenue:N2}) deleted successfully", Severity.Success);
                    
                    // Refresh harvests list
                    await RefreshHarvests();
                    
                    // Refresh summary to update calculations
                    if (summary != null)
                    {
                        summary = await Http.GetFromJsonAsync<PigPenSummary>($"/api/pigpens/{PigPenId}/summary");
                        StateHasChanged();
                    }
                }
                else
                {
                    Snackbar.Add("Failed to delete harvest record", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting harvest: {ex.Message}", Severity.Error);
            }
        }
    }

    private void BuildComparisonData()
    {
        Console.WriteLine($"BuildComparisonData called - feedFormulaCalculations null: {feedFormulaCalculations == null}, pigPen null: {pigPen == null}");

        if (pigPen == null)
        {
            Console.WriteLine("Exiting BuildComparisonData - pigPen is null");
            return;
        }

        comparisonData = new List<FeedComparisonData>();

        // 1. Process assigned formulas (existing logic)
        if (feedFormulaCalculations != null)
        {
            Console.WriteLine($"Processing {feedFormulaCalculations.Count()} assigned feed formulas");

            var assignedFormulaData = feedFormulaCalculations.Select(formula =>
            {
                Console.WriteLine($"Processing assigned formula: {formula.ProductCode} - {formula.ProductName}");

                // Find matching feed history entries by product code
                var matchingFeeds = feeds.Where(f => f.ProductCode == formula.ProductCode).ToList();
                Console.WriteLine($"Found {matchingFeeds.Count} matching feeds for assigned formula {formula.ProductCode}");

                // Group by invoice reference code for detailed breakdown
                var feedHistoryEntries = matchingFeeds
                    .Select(f => new FeedHistoryEntry
                    {
                        FeedId = f.Id,
                        InvoiceReferenceCode = string.IsNullOrEmpty(f.InvoiceReferenceCode) ? "N/A" : f.InvoiceReferenceCode,
                        Quantity = f.QuantityKg / 25m, // Convert KG to bags
                        FeedDate = f.Date,
                        FeedCost = f.FeedCost,
                        PriceIncludeDiscount = f.PriceIncludeDiscount,
                        SysTotalPriceIncludeDiscount = f.Sys_TotalPriceIncludeDiscount,
                        PosTotalPriceIncludeDiscount = f.Pos_TotalPriceIncludeDiscount
                    })
                    .OrderBy(e => e.InvoiceReferenceCode)
                    .ThenBy(e => e.FeedDate)
                    .ToList();

                var result = new FeedComparisonData
                {
                    ProductCode = formula.ProductCode,
                    ProductName = formula.ProductName,
                    FormulaPerPig = formula.BagPerPig,
                    FormulaTotal = formula.TotalBagsRequired,
                    ActualTotal = matchingFeeds.Sum(f => f.QuantityKg) / 25m, // Convert KG to bags
                    FeedHistoryEntries = feedHistoryEntries,
                    IsUnmatchedFeed = false // This matches an assigned formula
                };

                Console.WriteLine($"Created assigned formula data: {result.ProductCode}, FormulaPerPig: {result.FormulaPerPig}, FormulaTotal: {result.FormulaTotal}");
                return result;
            }).ToList();

            comparisonData.AddRange(assignedFormulaData);
        }

        // 2. Add unmatched feed items (feeds consumed but not in any assigned formula)
        var assignedProductCodes = feedFormulaCalculations?.Select(f => f.ProductCode).ToHashSet() ?? new HashSet<string>();
        var unmatchedFeeds = feeds.Where(f => !assignedProductCodes.Contains(f.ProductCode)).ToList();

        Console.WriteLine($"Found {unmatchedFeeds.Count} unmatched feed records");

        if (unmatchedFeeds.Any())
        {
            var unmatchedGroups = unmatchedFeeds.GroupBy(f => f.ProductCode);

            foreach (var group in unmatchedGroups)
            {
                var productCode = group.Key;
                var productName = group.First().ProductName ?? productCode;
                var totalQuantity = group.Sum(f => f.QuantityKg) / 25m; // Convert KG to bags

                Console.WriteLine($"Processing unmatched feed: {productCode} - {productName}, total: {totalQuantity:F1} bags");

                // Group by invoice reference code for unmatched feeds too
                var feedHistoryEntries = group
                    .Select(f => new FeedHistoryEntry
                    {
                        FeedId = f.Id,
                        InvoiceReferenceCode = string.IsNullOrEmpty(f.InvoiceReferenceCode) ? "N/A" : f.InvoiceReferenceCode,
                        Quantity = f.QuantityKg / 25m,
                        FeedDate = f.Date,
                        FeedCost = f.FeedCost,
                        PriceIncludeDiscount = f.PriceIncludeDiscount,
                        SysTotalPriceIncludeDiscount = f.Sys_TotalPriceIncludeDiscount,
                        PosTotalPriceIncludeDiscount = f.Pos_TotalPriceIncludeDiscount
                    })
                    .OrderBy(e => e.InvoiceReferenceCode)
                    .ThenBy(e => e.FeedDate)
                    .ToList();

                comparisonData.Add(new FeedComparisonData
                {
                    ProductCode = productCode,
                    ProductName = productName,
                    FormulaPerPig = 0, // No assigned formula
                    FormulaTotal = 0,   // No assigned formula
                    ActualTotal = totalQuantity,
                    FeedHistoryEntries = feedHistoryEntries,
                    IsUnmatchedFeed = true // This feed doesn't match any assigned formula
                });
            }
        }

        // Sort by ProductCode in ascending order
        comparisonData = comparisonData.OrderBy(c => c.ProductCode).ToList();

        Console.WriteLine($"BuildComparisonData completed - created {comparisonData.Count} comparison items ({comparisonData.Count(c => c.IsUnmatchedFeed)} unmatched)");
    }

    private decimal GetOverallVariance()
    {
        if (!comparisonData.Any()) return 0;
        return comparisonData.Sum(c => c.ActualTotal) - comparisonData.Sum(c => c.FormulaTotal);
    }

    private Severity GetOverallVarianceAlertSeverity()
    {
        var variance = GetOverallVariance();
        var percentage = comparisonData.Sum(c => c.FormulaTotal) > 0 
            ? Math.Abs(variance) / comparisonData.Sum(c => c.FormulaTotal) * 100 
            : 0;
        
        return percentage > 10 ? Severity.Error : percentage > 5 ? Severity.Warning : Severity.Success;
    }

    private decimal GetEfficiencyPercentage()
    {
        if (!comparisonData.Any() || comparisonData.Sum(c => c.FormulaTotal) == 0) return 100;
        
        var actualTotal = comparisonData.Sum(c => c.ActualTotal);
        var formulaTotal = comparisonData.Sum(c => c.FormulaTotal);
        
        // Efficiency: lower actual usage = higher efficiency
        return formulaTotal > 0 ? Math.Max(0, (2 * formulaTotal - actualTotal) / formulaTotal * 100) : 100;
    }

    private Severity GetEfficiencyAlertSeverity()
    {
        var efficiency = GetEfficiencyPercentage();
        return efficiency >= 95 ? Severity.Success : efficiency >= 85 ? Severity.Warning : Severity.Error;
    }

    // Helper method to calculate profit: POS Total - (cost * quantity)
    private string CalculateProfit(decimal? posTotal, decimal? feedCost, decimal quantity)
    {
        // If no POS total, cannot determine profit
        if (!posTotal.HasValue)
            return "-";

        // If cost is missing, treat entire POS total as profit
        if (!feedCost.HasValue)
            return posTotal.Value.ToString("N2");

        var totalCost = feedCost.Value * quantity;
        var profit = posTotal.Value - totalCost;
        return profit.ToString("N2");
    }

    // Helper method to calculate subtotal profit for a list of feed history entries
    private string CalculateSubTotalProfit(List<FeedHistoryEntry> entries)
    {
        decimal totalProfit = 0;
        bool hasPosTotal = false;

        foreach (var entry in entries)
        {
            if (entry.PosTotalPriceIncludeDiscount.HasValue)
            {
                hasPosTotal = true;

                if (entry.FeedCost.HasValue)
                {
                    var totalCost = entry.FeedCost.Value * entry.Quantity;
                    totalProfit += entry.PosTotalPriceIncludeDiscount.Value - totalCost;
                }
                else
                {
                    // If cost missing, entire POS total counts as profit
                    totalProfit += entry.PosTotalPriceIncludeDiscount.Value;
                }
            }
        }

        return hasPosTotal ? totalProfit.ToString("N2") : "-";
    }

    // Helper method to calculate grand total profit for all comparison data
    private string CalculateGrandTotalProfit(List<FeedComparisonData> comparisonData)
    {
        decimal totalProfit = 0;
        bool hasPosTotal = false;

        foreach (var comparison in comparisonData)
        {
            foreach (var entry in comparison.FeedHistoryEntries)
            {
                if (entry.PosTotalPriceIncludeDiscount.HasValue)
                {
                    hasPosTotal = true;

                    if (entry.FeedCost.HasValue)
                    {
                        var totalCost = entry.FeedCost.Value * entry.Quantity;
                        totalProfit += entry.PosTotalPriceIncludeDiscount.Value - totalCost;
                    }
                    else
                    {
                        // If cost missing, entire POS total counts as profit
                        totalProfit += entry.PosTotalPriceIncludeDiscount.Value;
                    }
                }
            }
        }

        return hasPosTotal ? totalProfit.ToString("N2") : "-";
    }

    public class GroupedFeedItem
    {
        public string ProductCode { get; set; } = "";
        public string ProductName { get; set; } = "";
        public decimal TotalQuantity { get; set; }
        public int FeedCount { get; set; }
    }

    // Method to create table rows that match the provided image structure
    private List<TableRowData> GetTableRows()
    {
        var rows = new List<TableRowData>();

        if (comparisonData?.Any() != true)
            return rows;

        foreach (var comparison in comparisonData)
        {
            // Check if there are any feed history entries
            if (comparison.FeedHistoryEntries.Any())
            {
                // First add the main product row with first invoice
                var firstInvoice = comparison.FeedHistoryEntries.First();
                var perPigValue = comparison.IsUnmatchedFeed ? "N/A" : comparison.FormulaPerPig.ToString("F1");
                var perPenValue = comparison.IsUnmatchedFeed ? "N/A" : comparison.FormulaTotal.ToString("0");
                var combinedFormula = comparison.IsUnmatchedFeed ? "N/A" : $"{perPigValue} / {perPenValue}";
                
                rows.Add(new TableRowData
                {
                    ProductCode = comparison.ProductCode,
                    ProductName = comparison.ProductName,
                    Formula = combinedFormula,
                    InvNo = firstInvoice.InvoiceReferenceCode,
                    InvDate = firstInvoice.FeedDate.ToString("MM/dd/yyyy"),
                    PerInvoiceBags = firstInvoice.Quantity.ToString("0"),
                    FeedCost = firstInvoice.FeedCost?.ToString("N2") ?? "-",
                    PriceIncludeDiscount = firstInvoice.PriceIncludeDiscount?.ToString("N2") ?? "-",
                    SysTotalPriceIncludeDiscount = firstInvoice.SysTotalPriceIncludeDiscount?.ToString("N2") ?? "-",
                    PosTotalPriceIncludeDiscount = firstInvoice.PosTotalPriceIncludeDiscount?.ToString("N2") ?? "-",
                    Profit = CalculateProfit(firstInvoice.PosTotalPriceIncludeDiscount, firstInvoice.FeedCost, firstInvoice.Quantity),
                    IsSubTotal = false,
                    IsUnmatchedFeed = comparison.IsUnmatchedFeed,
                    IsFirstProductRow = true // This is the first row for this product
                });

                // Add additional invoices for this product (from second invoice onwards)
                foreach (var invoice in comparison.FeedHistoryEntries.Skip(1))
                {
                    rows.Add(new TableRowData
                    {
                        ProductCode = comparison.ProductCode, // Include ProductCode for delete functionality
                        ProductName = "",
                        Formula = "",
                        InvNo = invoice.InvoiceReferenceCode,
                        InvDate = invoice.FeedDate.ToString("MM/dd/yyyy"),
                        PerInvoiceBags = invoice.Quantity.ToString("0"),
                        FeedCost = invoice.FeedCost?.ToString("N2") ?? "-",
                        PriceIncludeDiscount = invoice.PriceIncludeDiscount?.ToString("N2") ?? "-",
                        SysTotalPriceIncludeDiscount = invoice.SysTotalPriceIncludeDiscount?.ToString("N2") ?? "-",
                        PosTotalPriceIncludeDiscount = invoice.PosTotalPriceIncludeDiscount?.ToString("N2") ?? "-",
                        Profit = CalculateProfit(invoice.PosTotalPriceIncludeDiscount, invoice.FeedCost, invoice.Quantity),
                        IsSubTotal = false,
                        IsUnmatchedFeed = comparison.IsUnmatchedFeed,
                        IsFirstProductRow = false // Not the first row for this product
                    });
                }

                // Add Sub Total row for this product
                var subTotalSysTotal = comparison.FeedHistoryEntries.Sum(e => e.SysTotalPriceIncludeDiscount ?? 0);
                var subTotalPosTotal = comparison.FeedHistoryEntries.Sum(e => e.PosTotalPriceIncludeDiscount ?? 0);
                var subTotalProfit = CalculateSubTotalProfit(comparison.FeedHistoryEntries);
                
                rows.Add(new TableRowData
                {
                    ProductCode = "",
                    ProductName = "",
                    Formula = "",
                    InvNo = "Sub Total",
                    InvDate = "",
                    PerInvoiceBags = comparison.ActualTotal.ToString("0"),
                    FeedCost = "-",
                    PriceIncludeDiscount = "-",
                    SysTotalPriceIncludeDiscount = subTotalSysTotal > 0 ? subTotalSysTotal.ToString("N2") : "-",
                    PosTotalPriceIncludeDiscount = subTotalPosTotal > 0 ? subTotalPosTotal.ToString("N2") : "-",
                    Profit = subTotalProfit,
                    IsSubTotal = true,
                    IsUnmatchedFeed = comparison.IsUnmatchedFeed,
                    IsFirstProductRow = false
                });
            }
            else
            {
                // No feed history - show only formula data with "No Feeds" indicator
                var perPigValue = comparison.IsUnmatchedFeed ? "N/A" : comparison.FormulaPerPig.ToString("F1");
                var perPenValue = comparison.IsUnmatchedFeed ? "N/A" : comparison.FormulaTotal.ToString("0");
                var combinedFormula = comparison.IsUnmatchedFeed ? "N/A" : $"{perPigValue} / {perPenValue}";
                
                rows.Add(new TableRowData
                {
                    ProductCode = comparison.ProductCode,
                    ProductName = comparison.ProductName,
                    Formula = combinedFormula,
                    InvNo = "No Feeds",
                    InvDate = "",
                    PerInvoiceBags = "0",
                    FeedCost = "-",
                    PriceIncludeDiscount = "-",
                    SysTotalPriceIncludeDiscount = "-",
                    PosTotalPriceIncludeDiscount = "-",
                    Profit = "-",
                    IsSubTotal = false,
                    IsUnmatchedFeed = comparison.IsUnmatchedFeed,
                    IsFirstProductRow = true // This is the only row for this product
                });
            }
        }

        // Calculate grand totals (only include assigned formulas, not unmatched feeds)
        var assignedFormulas = comparisonData.Where(c => !c.IsUnmatchedFeed);
        var grandTotalPerPig = assignedFormulas.Sum(c => c.FormulaPerPig);
        var grandTotalPerPigPen = assignedFormulas.Sum(c => c.FormulaTotal);
        var grandTotalPerInvoice = comparisonData.Sum(c => c.ActualTotal);

        // Add Grand Total row
        var grandTotalCombined = grandTotalPerPig > 0 || grandTotalPerPigPen > 0 
            ? $"{grandTotalPerPig.ToString("F1")} / {grandTotalPerPigPen.ToString("0")}" 
            : "N/A";
        
        var grandTotalSysTotal = comparisonData.SelectMany(c => c.FeedHistoryEntries).Sum(e => e.SysTotalPriceIncludeDiscount ?? 0);
        var grandTotalPosTotal = comparisonData.SelectMany(c => c.FeedHistoryEntries).Sum(e => e.PosTotalPriceIncludeDiscount ?? 0);
        var grandTotalProfit = CalculateGrandTotalProfit(comparisonData);
        
        rows.Add(new TableRowData
        {
            ProductCode = "",
            ProductName = "",
            Formula = grandTotalCombined,
            InvNo = "Grand Total",
            InvDate = "",
            PerInvoiceBags = grandTotalPerInvoice.ToString("0"),
            FeedCost = "-",
            PriceIncludeDiscount = "-",
            SysTotalPriceIncludeDiscount = grandTotalSysTotal > 0 ? grandTotalSysTotal.ToString("N2") : "-",
            PosTotalPriceIncludeDiscount = grandTotalPosTotal > 0 ? grandTotalPosTotal.ToString("N2") : "-",
            Profit = grandTotalProfit,
            IsSubTotal = false,
            IsGrandTotal = true,
            IsUnmatchedFeed = false,
            IsFirstProductRow = false
        });

        return rows;
    }

    // Method to get filtered table rows based on product visibility settings
    private List<TableRowData> GetFilteredTableRows()
    {
        var allRows = GetTableRows();
        
        if (_showSpecificProducts)
        {
            // Show all rows when specific products switch is enabled
            return allRows;
        }
        
        // Filter out specific product codes when switch is disabled
        var specificProductCodes = new[] { "PK66000956", "PK66000957" };
        var filteredRows = new List<TableRowData>();
        
        // First, filter the comparison data to exclude specific products
        var filteredComparisonData = comparisonData?.Where(c => !specificProductCodes.Contains(c.ProductCode)).ToList() ?? new List<FeedComparisonData>();
        
        foreach (var row in allRows)
        {
            // For Grand Total, recalculate based on filtered data
            if (row.IsGrandTotal)
            {
                var grandTotalPerInvoice = filteredComparisonData.Sum(c => c.ActualTotal);
                var grandTotalSysTotal = filteredComparisonData.SelectMany(c => c.FeedHistoryEntries).Sum(e => e.SysTotalPriceIncludeDiscount ?? 0);
                var grandTotalPosTotal = filteredComparisonData.SelectMany(c => c.FeedHistoryEntries).Sum(e => e.PosTotalPriceIncludeDiscount ?? 0);
                var grandTotalProfit = CalculateGrandTotalProfit(filteredComparisonData);
                
                // Calculate new formula totals (excluding specific products)
                var assignedFormulas = filteredComparisonData.Where(c => !c.IsUnmatchedFeed);
                var grandTotalPerPig = assignedFormulas.Sum(c => c.FormulaPerPig);
                var grandTotalPerPigPen = assignedFormulas.Sum(c => c.FormulaTotal);
                var grandTotalCombined = grandTotalPerPig > 0 || grandTotalPerPigPen > 0 
                    ? $"{grandTotalPerPig.ToString("F1")} / {grandTotalPerPigPen.ToString("0")}" 
                    : "N/A";
                
                var updatedGrandTotal = new TableRowData
                {
                    ProductCode = "",
                    ProductName = "",
                    Formula = grandTotalCombined,
                    InvNo = "Grand Total",
                    InvDate = "",
                    PerInvoiceBags = grandTotalPerInvoice.ToString("0"),
                    FeedCost = "-",
                    PriceIncludeDiscount = "-",
                    SysTotalPriceIncludeDiscount = grandTotalSysTotal > 0 ? grandTotalSysTotal.ToString("N2") : "-",
                    PosTotalPriceIncludeDiscount = grandTotalPosTotal > 0 ? grandTotalPosTotal.ToString("N2") : "-",
                    Profit = grandTotalProfit,
                    IsSubTotal = false,
                    IsGrandTotal = true,
                    IsUnmatchedFeed = false,
                    IsFirstProductRow = false
                };
                filteredRows.Add(updatedGrandTotal);
                continue;
            }
            
            // For regular product rows, check if it's a specific product
            if (!string.IsNullOrEmpty(row.ProductCode) && specificProductCodes.Contains(row.ProductCode))
            {
                // Skip this product and all its related rows
                continue;
            }
            
            // For empty product code rows (additional invoice rows), check the previous row to determine the product
            if (string.IsNullOrEmpty(row.ProductCode) && !row.IsGrandTotal && !row.IsSubTotal)
            {
                // Look backward to find the parent product row
                var lastProductRow = filteredRows.LastOrDefault(r => !string.IsNullOrEmpty(r.ProductCode) && !r.IsGrandTotal && !r.IsSubTotal);
                if (lastProductRow != null && specificProductCodes.Contains(lastProductRow.ProductCode))
                {
                    // Skip this row as it belongs to a filtered product
                    continue;
                }
            }
            
            // For subtotal rows, check if they belong to a filtered product by looking at recent context
            if (row.IsSubTotal)
            {
                // Look at the last few rows to see if we're in a filtered product context
                var recentProductRows = allRows.TakeWhile(r => r != row).Reverse().Take(10)
                    .Where(r => !string.IsNullOrEmpty(r.ProductCode) && !r.IsGrandTotal && !r.IsSubTotal);
                
                var lastRelevantProduct = recentProductRows.FirstOrDefault();
                if (lastRelevantProduct != null && specificProductCodes.Contains(lastRelevantProduct.ProductCode))
                {
                    // Skip this subtotal as it belongs to a filtered product
                    continue;
                }
            }
            
            filteredRows.Add(row);
        }
        
        return filteredRows;
    }

    public class TableRowData
    {
        public Guid FeedId { get; set; } = Guid.Empty;
        public string ProductCode { get; set; } = "";
        public string ProductName { get; set; } = "";
        public string Formula { get; set; } = ""; // Combined: "PerPig / PerPen"
        public string InvNo { get; set; } = "";
        public string InvDate { get; set; } = "";
        public string PerInvoiceBags { get; set; } = "";
        public decimal Quantity { get; set; } = 0m;
        public string FeedCost { get; set; } = ""; // From FeedFormula.Cost
        public string PriceIncludeDiscount { get; set; } = ""; // UnitPrice - CostDiscountPrice
        public string SysTotalPriceIncludeDiscount { get; set; } = ""; // System calculated total
        public string PosTotalPriceIncludeDiscount { get; set; } = ""; // POS provided total
        public string Profit { get; set; } = ""; // POS Total - (cost * quantity)
        public bool IsSubTotal { get; set; }
        public bool IsGrandTotal { get; set; }
        public bool IsUnmatchedFeed { get; set; } // True if this feed doesn't match any assigned formula
        public bool IsFirstProductRow { get; set; } // True if this is the first row for this product
    }

    public class FeedComparisonData
    {
        public string ProductCode { get; set; } = "";
        public string ProductName { get; set; } = "";
        public decimal FormulaPerPig { get; set; }
        public decimal FormulaTotal { get; set; }
        public decimal ActualTotal { get; set; }
        public List<FeedHistoryEntry> FeedHistoryEntries { get; set; } = new();
        public bool IsUnmatchedFeed { get; set; } // True if this feed doesn't match any assigned formula
    }

    public class FeedHistoryEntry
    {
        public Guid FeedId { get; set; } = Guid.Empty;
        public string InvoiceReferenceCode { get; set; } = "";
        public decimal Quantity { get; set; }
        public DateTime FeedDate { get; set; }
        public decimal? FeedCost { get; set; } // From FeedFormula.Cost
        public decimal? PriceIncludeDiscount { get; set; } // UnitPrice - CostDiscountPrice
        public decimal? SysTotalPriceIncludeDiscount { get; set; } // System calculated total
        public decimal? PosTotalPriceIncludeDiscount { get; set; } // POS provided total
    }

    // Deposit-related helper methods
    private Color GetProgressColor()
    {
        if (depositCalculationInfo == null) return Color.Default;
        
        return depositCalculationInfo.Status switch
        {
            DepositCompletionStatus.Complete => Color.Success,
            DepositCompletionStatus.Partial => Color.Warning,
            DepositCompletionStatus.Started => Color.Info,
            _ => Color.Error
        };
    }

    private Color GetStatusChipColor()
    {
        if (depositCalculationInfo == null) return Color.Default;
        
        return depositCalculationInfo.Status switch
        {
            DepositCompletionStatus.Complete => Color.Success,
            DepositCompletionStatus.Partial => Color.Warning,
            DepositCompletionStatus.Started => Color.Info,
            _ => Color.Error
        };
    }

    private string GetStatusText()
    {
        if (depositCalculationInfo == null) return "Unknown";
        
        return depositCalculationInfo.Status switch
        {
            DepositCompletionStatus.Complete => "‚úÖ Complete",
            DepositCompletionStatus.Partial => "üü° Partial",
            DepositCompletionStatus.Started => "üîµ Started",
            _ => "üî¥ No Deposits"
        };
    }

    private Color GetDepositStatusColor()
    {
        if (depositCalculationInfo == null) return Color.Secondary;
        
        return depositCalculationInfo.Status switch
        {
            DepositCompletionStatus.Complete => Color.Success,
            DepositCompletionStatus.Partial => Color.Warning,
            DepositCompletionStatus.Started => Color.Info,
            _ => Color.Error
        };
    }

    // Harvest progress color methods
    private Color GetHarvestProgressColor()
    {
        if (harvestCalculationInfo == null) return Color.Default;
        
        return harvestCalculationInfo.Status switch
        {
            HarvestCompletionStatus.Complete => Color.Success,
            HarvestCompletionStatus.Partial => Color.Warning,
            HarvestCompletionStatus.Started => Color.Info,
            _ => Color.Secondary
        };
    }

    private Color GetHarvestStatusColor()
    {
        if (harvestCalculationInfo == null) return Color.Default;
        
        return harvestCalculationInfo.RemainingPigQuantity switch
        {
            0 => Color.Success,
            > 0 when harvestCalculationInfo.CompletionPercentage >= 0.5m => Color.Warning,
            _ => Color.Info
        };
    }

    private Color GetHarvestStatusChipColor()
    {
        if (harvestCalculationInfo == null) return Color.Default;
        
        return harvestCalculationInfo.Status switch
        {
            HarvestCompletionStatus.Complete => Color.Success,
            HarvestCompletionStatus.Partial => Color.Warning,
            HarvestCompletionStatus.Started => Color.Info,
            _ => Color.Secondary
        };
    }

    /// <summary>
    /// Determines whether the Force Close button should be visible based on business rules
    /// </summary>
    private bool ShouldShowForceCloseButton()
    {
        // Don't show if pig pen is null or not loaded
        if (pigPen == null) return false;
        
        // Show for active pig pens (no actual harvest date) - covers scenarios 1, 2, 3
        if (!pigPen.ActHarvestDate.HasValue) return true;
        
        // Show for already completed pig pens (scenario 4) - might need to reopen or adjust
        if (pigPen.ActHarvestDate.HasValue) return true;
        
        // Fallback: show in all cases where pig pen exists
        return true;
    }

    /// <summary>
    /// Gets the appropriate color for the Force Close button based on pig pen status
    /// </summary>
    private Color GetForceCloseButtonColor()
    {
        if (pigPen == null) return Color.Default;
        
        return pigPen.ActHarvestDate.HasValue switch
        {
            true => Color.Info,      // Already completed - blue for "manage/reopen"
            false => Color.Warning   // Active - orange for "force close"
        };
    }

    /// <summary>
    /// Gets the appropriate icon for the Force Close button based on pig pen status
    /// </summary>
    private string GetForceCloseButtonIcon()
    {
        if (pigPen == null) return Icons.Material.Filled.GppMaybe;
        
        return pigPen.ActHarvestDate.HasValue switch
        {
            true => Icons.Material.Filled.Settings,    // Already completed - settings icon
            false => Icons.Material.Filled.GppMaybe    // Active - warning icon
        };
    }

    /// <summary>
    /// Gets the appropriate text for the Force Close button based on pig pen status
    /// </summary>
    private string GetForceCloseButtonText()
    {
        if (pigPen == null) return "Force Close";
        
        return pigPen.ActHarvestDate.HasValue switch
        {
            true => "Manage",        // Already completed - allow management/adjustments
            false => "Force Close"   // Active - force close action
        };
    }

    private async Task RefreshDeposits()
    {
        try
        {
            // Only load deposits for Project type pig pens
            if (pigPen?.Type == PigPenType.Project)
            {
                deposits = await Http.GetFromJsonAsync<List<Deposit>>($"/api/pigpens/{PigPenId}/deposits") ?? new();
                
                // Recalculate deposit information
                depositCalculationInfo = DepositCalculationInfo.Create(pigPen, deposits);
            }
            else
            {
                deposits = new();
                depositCalculationInfo = null;
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading deposits: {ex.Message}", Severity.Error);
        }
    }

    private async Task RefreshFeeds()
    {
        try
        {
            // Reload feeds
            var allFeeds = await Http.GetFromJsonAsync<List<FeedItem>>($"/api/pigpens/{PigPenId}/feeds") ?? new();
            feeds = allFeeds.OrderByDescending(f => f.Date).ThenBy(f => f.ProductCode).ToList();
            
            // Regroup feeds by product code
            groupedFeeds = feeds
                .Where(f => !string.IsNullOrEmpty(f.ProductCode))
                .GroupBy(f => f.ProductCode)
                .Select(g => new GroupedFeedItem
                {
                    ProductCode = g.Key,
                    ProductName = g.First().ProductName ?? g.Key,
                    TotalQuantity = g.Sum(f => f.QuantityKg),
                    FeedCount = g.Count()
                })
                .OrderBy(g => g.ProductCode)
                .ToList();

            // Rebuild comparison data
            BuildComparisonData();
            
            // Refresh feed progress summary
            try
            {
                feedProgressSummary = await Http.GetFromJsonAsync<FeedProgressSummary>($"/api/pigpens/{PigPenId}/feed-progress/summary");
                Console.WriteLine($"Refreshed feed progress: {feedProgressSummary?.Progress?.Status ?? "No data"}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading feed progress: {ex.Message}");
                Snackbar.Add($"Error refreshing feed progress: {ex.Message}", Severity.Warning);
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading feeds: {ex.Message}", Severity.Error);
        }
    }

    private async Task RefreshHarvests()
    {
        try
        {
            harvests = await Http.GetFromJsonAsync<List<HarvestResult>>($"/api/pigpens/{PigPenId}/harvests") ?? new();
            
            // Recalculate harvest information
            if (pigPen != null)
            {
                harvestCalculationInfo = HarvestCalculationInfo.Create(pigPen, harvests);
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading harvests: {ex.Message}", Severity.Error);
        }
    }

    // Feed progress helper methods
    private string GetFeedProgressIcon()
    {
        if (feedProgressSummary?.Progress == null) return Icons.Material.Filled.HelpOutline;
        
        return feedProgressSummary.Progress.Status switch
        {
            "Complete" => Icons.Material.Filled.CheckCircle,
            "On Track" => Icons.Material.Filled.TrendingUp,
            "Over Feeding" => Icons.Material.Filled.Warning,
            "Behind Schedule" => Icons.Material.Filled.Schedule,
            _ => Icons.Material.Filled.Info
        };
    }

    private Color GetFeedProgressColor()
    {
        if (feedProgressSummary?.Progress == null) return Color.Default;
        
        return feedProgressSummary.Progress.Status switch
        {
            "On track" => Color.Success,
            "Below target" => Color.Warning,
            "Under-fed" => Color.Error,
            "Over-feeding" => Color.Error,
            _ => Color.Info
        };
    }

    private Color GetFeedStatusChipColor()
    {
        if (feedProgressSummary?.Progress == null) return Color.Default;
        
        return feedProgressSummary.Progress.Status switch
        {
            "On track" => Color.Success,
            "Below target" => Color.Warning,
            "Under-fed" => Color.Error,
            "Over-feeding" => Color.Error,
            _ => Color.Info
        };
    }

    private bool IsPigPenClosed()
    {
        if (pigPen == null) return false;
        
        // A pig pen is considered closed only if calculations are locked
        // Having an ActHarvestDate alone doesn't mean it's closed - user may want to force close later
        return pigPen.IsCalculationLocked;
    }

    private async Task RemoveInvoice(string productCode, string invoiceReferenceCode)
    {
        if (string.IsNullOrEmpty(productCode) || string.IsNullOrEmpty(invoiceReferenceCode) || invoiceReferenceCode == "N/A")
        {
            Snackbar.Add("Cannot remove this invoice entry", Severity.Warning);
            return;
        }

        try
        {
            // Find feeds with the specified invoice reference code and product code
            var feedsToRemove = feeds.Where(f => f.ProductCode == productCode && 
                                               (f.InvoiceReferenceCode == invoiceReferenceCode || 
                                                (string.IsNullOrEmpty(f.InvoiceReferenceCode) && invoiceReferenceCode == "N/A")))
                                    .ToList();

            if (!feedsToRemove.Any())
            {
                Snackbar.Add($"Invoice '{invoiceReferenceCode}' for product '{productCode}' was not found or has already been deleted.", Severity.Info);
                // Still refresh to ensure UI is up to date
                await RefreshFeeds();
                return;
            }

            // Confirm deletion
            var totalQuantity = feedsToRemove.Sum(f => f.QuantityKg);
            var confirmed = await DialogService.ShowMessageBox(
                "Confirm Removal",
                $"Are you sure you want to remove invoice '{invoiceReferenceCode}' for product '{productCode}'? This will remove {feedsToRemove.Count} feed record(s) totaling {totalQuantity:N1} kg.",
                yesText: "Remove Invoice",
                cancelText: "Cancel");

            if (confirmed == true)
            {
                // Delete feeds from the server one by one to handle partial failures gracefully
                var successfulDeletes = 0;
                var failedDeletes = 0;
                
                foreach (var feed in feedsToRemove)
                {
                    try
                    {
                        Console.WriteLine($"Attempting to delete feed {feed.Id} for pig pen {pigPen!.Id}");
                        var result = await PigPenService.DeleteFeedItemAsync(pigPen!.Id, feed.Id);
                        Console.WriteLine($"Delete result for feed {feed.Id}: {result}");
                        if (result)
                        {
                            successfulDeletes++;
                        }
                        else
                        {
                            failedDeletes++;
                            Console.WriteLine($"Failed to delete feed {feed.Id} - HTTP request failed");
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"Exception deleting feed {feed.Id}: {ex.Message}");
                        failedDeletes++;
                    }
                }

                // Always refresh feeds data from server
                await RefreshFeeds();

                // Show appropriate message based on results
                if (failedDeletes == 0)
                {
                    Snackbar.Add($"Successfully removed invoice '{invoiceReferenceCode}' - {successfulDeletes} feed record(s) deleted", Severity.Success);
                }
                else if (successfulDeletes > 0)
                {
                    Snackbar.Add($"Partially removed invoice '{invoiceReferenceCode}' - {successfulDeletes} record(s) deleted, {failedDeletes} failed. Some records may have already been deleted.", Severity.Warning);
                }
                else
                {
                    Snackbar.Add($"Failed to remove invoice '{invoiceReferenceCode}' - all {failedDeletes} record(s) could not be deleted. They may have already been removed.", Severity.Error);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error removing invoice: {ex.Message}", Severity.Error);
        }
    }
}
